var oc=Object.defineProperty,rc=Object.defineProperties;var sc=Object.getOwnPropertyDescriptors;var qi=Object.getOwnPropertySymbols;var Ss=Object.prototype.hasOwnProperty,Ks=Object.prototype.propertyIsEnumerable;var xs=(o,e,t)=>e in o?oc(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,L=(o,e)=>{for(var t in e||(e={}))Ss.call(e,t)&&xs(o,t,e[t]);if(qi)for(var t of qi(e))Ks.call(e,t)&&xs(o,t,e[t]);return o},D=(o,e)=>rc(o,sc(e));var Ne=(o,e)=>{var t={};for(var n in o)Ss.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&qi)for(var n of qi(o))e.indexOf(n)<0&&Ks.call(o,n)&&(t[n]=o[n]);return t};import{merge as Jd}from"lodash";import ya from"axios";import{PublicKey as Ls}from"@solana/web3.js";import{get as Cs,set as ac}from"lodash";var nr=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Rs={},uc={};function ue(o){let e=Cs(Rs,o);if(!e){let t=Cs(uc,o);e=new nr({name:o,logLevel:t}),ac(Rs,o,e)}return e}import{MINT_SIZE as cc,TOKEN_PROGRAM_ID as lc,getTransferFeeConfig as mc,unpackMint as dc}from"@solana/spl-token";var ir=ue("Raydium_accountInfo_util");async function Bt(o,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:r=100}=L({batchRequest:!1},t),s=or(e,r),a=new Array(s.length).fill([]);if(n){let u=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),c=or(u,10);a=(await(await Promise.all(c.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&ir.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:f,lamports:y,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&ir.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:f,lamports:y,owner:new Ls(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(u=>o.getMultipleAccountsInfo(u,i)))}catch(u){u instanceof Error&&ir.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return a.flat()}async function qe(o,e,t){let n=await Bt(o,e.map(i=>i.pubkey),t);return e.map((i,r)=>D(L({},i),{accountInfo:n[r]}))}async function Mn({connection:o,mints:e,config:t}){var r,s,a;if(e.length===0)return{};let n=await qe(o,e.map(u=>({pubkey:dt(u)})),t),i={};for(let u of n){if(!u.accountInfo||u.accountInfo.data.length<cc){console.log("invalid mint account",u.pubkey.toBase58());continue}let c=dc(u.pubkey,u.accountInfo,(r=u.accountInfo)==null?void 0:r.owner);i[u.pubkey.toString()]=D(L({},c),{programId:((s=u.accountInfo)==null?void 0:s.owner)||lc,feeConfig:(a=mc(c))!=null?a:void 0})}return i[Ls.default.toBase58()]=i[H.toBase58()],i}import Gt from"bn.js";var Nn=9e15,nn=1e9,rr="0123456789abcdef",Gi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Xi="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",sr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Nn,maxE:Nn,crypto:!1},_s,qt,oe=!0,Qi="[DecimalError] ",tn=Qi+"Invalid argument: ",Vs=Qi+"Precision limit exceeded",vs=Qi+"crypto unavailable",Es="[object Decimal]",He=Math.floor,Ee=Math.pow,pc=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,fc=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,yc=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Fs=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,St=1e7,ee=7,bc=9007199254740991,gc=Gi.length-1,ar=Xi.length-1,V={toStringTag:Es};V.absoluteValue=V.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),$(o)};V.ceil=function(){return $(new this.constructor(this),this.e+1,2)};V.clampedTo=V.clamp=function(o,e){var t,n=this,i=n.constructor;if(o=new i(o),e=new i(e),!o.s||!e.s)return new i(NaN);if(o.gt(e))throw Error(tn+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new i(n)};V.comparedTo=V.cmp=function(o){var e,t,n,i,r=this,s=r.d,a=(o=new r.constructor(o)).d,u=r.s,c=o.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(r.e!==o.e)return r.e>o.e^u<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===i?0:n>i^u<0?1:-1};V.cosine=V.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+ee,n.rounding=1,t=wc(n,Gs(n,t)),n.precision=o,n.rounding=e,$(qt==2||qt==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};V.cubeRoot=V.cbrt=function(){var o,e,t,n,i,r,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(oe=!1,r=l.s*Ee(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=Xe(l.d),o=l.e,(r=(o-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Ee(t,1/3),o=He((o+1)/3)-(o%3==(o<0?-1:2)),r==1/0?t="5e"+o:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(r.toString()),s=(o=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=Pe(c.plus(l).times(a),c.plus(u),s+2,1),Xe(a.d).slice(0,s)===(t=Xe(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&($(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&($(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return oe=!0,$(n,o,m.rounding,e)};V.decimalPlaces=V.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-He(this.e/ee))*ee,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};V.dividedBy=V.div=function(o){return Pe(this,new this.constructor(o))};V.dividedToIntegerBy=V.divToInt=function(o){var e=this,t=e.constructor;return $(Pe(e,new t(o),0,1,1),t.precision,t.rounding)};V.equals=V.eq=function(o){return this.cmp(o)===0};V.floor=function(){return $(new this.constructor(this),this.e+1,3)};V.greaterThan=V.gt=function(o){return this.cmp(o)>0};V.greaterThanOrEqualTo=V.gte=function(o){var e=this.cmp(o);return e==1||e===0};V.hyperbolicCosine=V.cosh=function(){var o,e,t,n,i,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,i=r.d.length,i<32?(o=Math.ceil(i/3),e=(1/ji(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),r=_n(s,1,r.times(e),new s(1),!0);for(var u,c=o,l=new s(8);c--;)u=r.times(r),r=a.minus(u.times(l.minus(u.times(l))));return $(r,s.precision=t,s.rounding=n,!0)};V.hyperbolicSine=V.sinh=function(){var o,e,t,n,i=this,r=i.constructor;if(!i.isFinite()||i.isZero())return new r(i);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(i.e,i.sd())+4,r.rounding=1,n=i.d.length,n<3)i=_n(r,2,i,i,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,i=i.times(1/ji(5,o)),i=_n(r,2,i,i,!0);for(var s,a=new r(5),u=new r(16),c=new r(20);o--;)s=i.times(i),i=i.times(a.plus(s.times(u.times(s).plus(c))))}return r.precision=e,r.rounding=t,$(i,e,t,!0)};V.hyperbolicTangent=V.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,Pe(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};V.inverseCosine=V.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?xt(t,i,r):new t(0):new t(NaN):e.isZero()?xt(t,i+4,r).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),o=xt(t,i+4,r).times(.5),t.precision=i,t.rounding=r,o.minus(e))};V.inverseHyperbolicCosine=V.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,oe=!1,t=t.times(t).minus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};V.inverseHyperbolicSine=V.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,oe=!1,t=t.times(t).plus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln())};V.inverseHyperbolicTangent=V.atanh=function(){var o,e,t,n,i=this,r=i.constructor;return i.isFinite()?i.e>=0?new r(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(o=r.precision,e=r.rounding,n=i.sd(),Math.max(n,o)<2*-i.e-1?$(new r(i),o,e,!0):(r.precision=t=n-i.e,i=Pe(i.plus(1),new r(1).minus(i),t+o,1),r.precision=o+4,r.rounding=1,i=i.ln(),r.precision=o,r.rounding=e,i.times(.5))):new r(NaN)};V.inverseSine=V.asin=function(){var o,e,t,n,i=this,r=i.constructor;return i.isZero()?new r(i):(e=i.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(o=xt(r,t+4,n).times(.5),o.s=i.s,o):new r(NaN):(r.precision=t+6,r.rounding=1,i=i.div(new r(1).minus(i.times(i)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,i.times(2)))};V.inverseTangent=V.atan=function(){var o,e,t,n,i,r,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=ar)return s=xt(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=ar)return s=xt(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/ee+2|0),o=t;o;--o)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(oe=!1,e=Math.ceil(a/ee),n=1,u=c.times(c),s=new l(c),i=c;o!==-1;)if(i=i.times(u),r=s.minus(i.div(n+=2)),i=i.times(u),s=r.plus(i.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===r.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),oe=!0,$(s,l.precision=m,l.rounding=d,!0)};V.isFinite=function(){return!!this.d};V.isInteger=V.isInt=function(){return!!this.d&&He(this.e/ee)>this.d.length-2};V.isNaN=function(){return!this.s};V.isNegative=V.isNeg=function(){return this.s<0};V.isPositive=V.isPos=function(){return this.s>0};V.isZero=function(){return!!this.d&&this.d[0]===0};V.lessThan=V.lt=function(o){return this.cmp(o)<0};V.lessThanOrEqualTo=V.lte=function(o){return this.cmp(o)<1};V.logarithm=V.log=function(o){var e,t,n,i,r,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(i=t[0];i%10===0;)i/=10;r=i!==1}if(oe=!1,a=m+p,s=en(c,a),n=e?zi(l,a+10):en(o,a),u=Pe(s,n,a,1),Qn(u.d,i=m,d))do if(a+=10,s=en(c,a),n=e?zi(l,a+10):en(o,a),u=Pe(s,n,a,1),!r){+Xe(u.d).slice(i+1,i+15)+1==1e14&&(u=$(u,m+1,0));break}while(Qn(u.d,i+=10,d));return oe=!0,$(u,m,d)};V.minus=V.sub=function(o){var e,t,n,i,r,s,a,u,c,l,m,d,p=this,f=p.constructor;if(o=new f(o),!p.d||!o.d)return!p.s||!o.s?o=new f(NaN):p.d?o.s=-o.s:o=new f(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(c=p.d,d=o.d,a=f.precision,u=f.rounding,!c[0]||!d[0]){if(d[0])o.s=-o.s;else if(c[0])o=new f(p);else return new f(u===3?-0:0);return oe?$(o,a,u):o}if(t=He(o.e/ee),l=He(p.e/ee),c=c.slice(),r=l-t,r){for(m=r<0,m?(e=c,r=-r,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/ee),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}r=0}for(m&&(e=c,c=d,d=e,o.s=-o.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>r;){if(c[--n]<d[n]){for(i=n;i&&c[--i]===0;)c[i]=St-1;--c[i],c[n]+=St}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(o.d=c,o.e=Yi(c,t),oe?$(o,a,u):o):new f(u===3?-0:0)};V.modulo=V.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?$(new n(t),n.precision,n.rounding):(oe=!1,n.modulo==9?(e=Pe(t,o.abs(),0,3,1),e.s*=o.s):e=Pe(t,o,0,n.modulo,1),e=e.times(o),oe=!0,t.minus(e))};V.naturalExponential=V.exp=function(){return ur(this)};V.naturalLogarithm=V.ln=function(){return en(this)};V.negated=V.neg=function(){var o=new this.constructor(this);return o.s=-o.s,$(o)};V.plus=V.add=function(o){var e,t,n,i,r,s,a,u,c,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(c=m.d,l=o.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(o=new d(m)),oe?$(o,a,u):o;if(r=He(m.e/ee),n=He(o.e/ee),c=c.slice(),i=r-n,i){for(i<0?(t=c,i=-i,s=l.length):(t=l,n=r,s=c.length),r=Math.ceil(a/ee),s=r>s?r+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=c.length,i=l.length,s-i<0&&(i=s,t=l,l=c,c=t),e=0;i;)e=(c[--i]=c[i]+l[i]+e)/St|0,c[i]%=St;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return o.d=c,o.e=Yi(c,n),oe?$(o,a,u):o};V.precision=V.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(tn+o);return t.d?(e=Ds(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};V.round=function(){var o=this,e=o.constructor;return $(new e(o),o.e+1,e.rounding)};V.sine=V.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+ee,n.rounding=1,t=Pc(n,Gs(n,t)),n.precision=o,n.rounding=e,$(qt>2?t.neg():t,o,e,!0)):new n(NaN)};V.squareRoot=V.sqrt=function(){var o,e,t,n,i,r,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(oe=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=Xe(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=He((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(r=n,n=r.plus(Pe(s,r,t+2,1)).times(.5),Xe(r.d).slice(0,t)===(e=Xe(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&($(r,u+1,0),r.times(r).eq(s))){n=r;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&($(n,u+1,1),o=!n.times(n).eq(s));break}return oe=!0,$(n,u,l.rounding,o)};V.tangent=V.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=Pe(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,$(qt==2||qt==4?t.neg():t,o,e,!0)):new n(NaN)};V.times=V.mul=function(o){var e,t,n,i,r,s,a,u,c,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=He(l.e/ee)+He(o.e/ee),u=d.length,c=p.length,u<c&&(r=d,d=p,p=r,s=u,u=c,c=s),r=[],s=u+c,n=s;n--;)r.push(0);for(n=c;--n>=0;){for(e=0,i=u+n;i>n;)a=r[i]+p[n]*d[i-n-1]+e,r[i--]=a%St|0,e=a/St|0;r[i]=(r[i]+e)%St|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),o.d=r,o.e=Yi(r,t),oe?$(o,m.precision,m.rounding):o};V.toBinary=function(o,e){return lr(this,2,o,e)};V.toDecimalPlaces=V.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:(at(o,0,nn),e===void 0?e=n.rounding:at(e,0,8),$(t,o+t.e+1,e))};V.toExponential=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=Et(n,!0):(at(o,0,nn),e===void 0?e=i.rounding:at(e,0,8),n=$(new i(n),o+1,e),t=Et(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};V.toFixed=function(o,e){var t,n,i=this,r=i.constructor;return o===void 0?t=Et(i):(at(o,0,nn),e===void 0?e=r.rounding:at(e,0,8),n=$(new r(i),o+i.e+1,e),t=Et(n,!1,o+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};V.toFraction=function(o){var e,t,n,i,r,s,a,u,c,l,m,d,p=this,f=p.d,y=p.constructor;if(!f)return new y(p);if(c=t=new y(1),n=u=new y(0),e=new y(n),r=e.e=Ds(f)-p.e-1,s=r%ee,e.d[0]=Ee(10,s<0?ee+s:s),o==null)o=r>0?e:c;else{if(a=new y(o),!a.isInt()||a.lt(c))throw Error(tn+a);o=a.gt(e)?r>0?e:c:a}for(oe=!1,a=new y(Xe(f)),l=y.precision,y.precision=r=f.length*ee*2;m=Pe(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(o)!=1;)t=n,n=i,i=c,c=u.plus(m.times(i)),u=i,i=e,e=a.minus(m.times(i)),a=i;return i=Pe(o.minus(t),n,0,1,1),u=u.plus(i.times(c)),t=t.plus(i.times(n)),u.s=c.s=p.s,d=Pe(c,n,r,1).minus(p).abs().cmp(Pe(u,t,r,1).minus(p).abs())<1?[c,n]:[u,t],y.precision=l,oe=!0,d};V.toHexadecimal=V.toHex=function(o,e){return lr(this,16,o,e)};V.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:at(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(oe=!1,t=Pe(t,o,0,e,1).times(o),oe=!0,$(t)):(o.s=t.s,t=o),t};V.toNumber=function(){return+this};V.toOctal=function(o,e){return lr(this,8,o,e)};V.toPower=V.pow=function(o){var e,t,n,i,r,s,a=this,u=a.constructor,c=+(o=new u(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new u(Ee(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,r=u.rounding,o.eq(1))return $(a,n,r);if(e=He(o.e/ee),e>=o.d.length-1&&(t=c<0?-c:c)<=bc)return i=Ws(u,a,t,n),o.s<0?new u(1).div(i):$(i,n,r);if(s=a.s,s<0){if(e<o.d.length-1)return new u(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Ee(+a,c),e=t==0||!isFinite(t)?He(c*(Math.log("0."+Xe(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(oe=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),i=ur(o.times(en(a,n+t)),n),i.d&&(i=$(i,n+5,1),Qn(i.d,n,r)&&(e=n+10,i=$(ur(o.times(en(a,e+t)),e),e+5,1),+Xe(i.d).slice(n+1,n+15)+1==1e14&&(i=$(i,n+1,0)))),i.s=s,oe=!0,u.rounding=r,$(i,n,r))};V.toPrecision=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=Et(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(at(o,1,nn),e===void 0?e=i.rounding:at(e,0,8),n=$(new i(n),o,e),t=Et(n,o<=n.e||n.e<=i.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};V.toSignificantDigits=V.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):(at(o,1,nn),e===void 0?e=n.rounding:at(e,0,8)),$(new n(t),o,e)};V.toString=function(){var o=this,e=o.constructor,t=Et(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};V.truncated=V.trunc=function(){return $(new this.constructor(this),this.e+1,1)};V.valueOf=V.toJSON=function(){var o=this,e=o.constructor,t=Et(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function Xe(o){var e,t,n,i=o.length-1,r="",s=o[0];if(i>0){for(r+=s,e=1;e<i;e++)n=o[e]+"",t=ee-n.length,t&&(r+=Jt(t)),r+=n;s=o[e],n=s+"",t=ee-n.length,t&&(r+=Jt(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function at(o,e,t){if(o!==~~o||o<e||o>t)throw Error(tn+o)}function Qn(o,e,t,n){var i,r,s,a;for(r=o[0];r>=10;r/=10)--e;return--e<0?(e+=ee,i=0):(i=Math.ceil((e+1)/ee),e%=ee),r=Ee(10,ee-e),a=o[i]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(o[i+1]/r/100|0)==Ee(10,e-2)-1||(a==r/2||a==0)&&(o[i+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(o[i+1]/r/1e3|0)==Ee(10,e-3)-1,s}function Ui(o,e,t){for(var n,i=[0],r,s=0,a=o.length;s<a;){for(r=i.length;r--;)i[r]*=e;for(i[0]+=rr.indexOf(o.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function wc(o,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/ji(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),o.precision+=t,e=_n(o,1,e.times(i),new o(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var Pe=function(){function o(n,i,r){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*i+a,n[u]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,i,r,s){var a,u;if(r!=s)u=r>s?1:-1;else for(a=u=0;a<r;a++)if(n[a]!=i[a]){u=n[a]>i[a]?1:-1;break}return u}function t(n,i,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<i[r]?1:0,n[r]=a*s+n[r]-i[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,r,s,a,u){var c,l,m,d,p,f,y,b,g,P,w,k,I,h,S,B,C,x,R,F,O=n.constructor,X=n.s==i.s?1:-1,q=n.d,W=i.d;if(!q||!q[0]||!W||!W[0])return new O(!n.s||!i.s||(q?W&&q[0]==W[0]:!W)?NaN:q&&q[0]==0||!W?X*0:X/0);for(u?(p=1,l=n.e-i.e):(u=St,p=ee,l=He(n.e/p)-He(i.e/p)),R=W.length,C=q.length,g=new O(X),P=g.d=[],m=0;W[m]==(q[m]||0);m++);if(W[m]>(q[m]||0)&&l--,r==null?(h=r=O.precision,s=O.rounding):a?h=r+(n.e-i.e)+1:h=r,h<0)P.push(1),f=!0;else{if(h=h/p+2|0,m=0,R==1){for(d=0,W=W[0],h++;(m<C||d)&&h--;m++)S=d*u+(q[m]||0),P[m]=S/W|0,d=S%W|0;f=d||m<C}else{for(d=u/(W[0]+1)|0,d>1&&(W=o(W,d,u),q=o(q,d,u),R=W.length,C=q.length),B=R,w=q.slice(0,R),k=w.length;k<R;)w[k++]=0;F=W.slice(),F.unshift(0),x=W[0],W[1]>=u/2&&++x;do d=0,c=e(W,w,R,k),c<0?(I=w[0],R!=k&&(I=I*u+(w[1]||0)),d=I/x|0,d>1?(d>=u&&(d=u-1),y=o(W,d,u),b=y.length,k=w.length,c=e(y,w,b,k),c==1&&(d--,t(y,R<b?F:W,b,u))):(d==0&&(c=d=1),y=W.slice()),b=y.length,b<k&&y.unshift(0),t(w,y,k,u),c==-1&&(k=w.length,c=e(W,w,R,k),c<1&&(d++,t(w,R<k?F:W,k,u))),k=w.length):c===0&&(d++,w=[0]),P[m++]=d,c&&w[0]?w[k++]=q[B]||0:(w=[q[B]],k=1);while((B++<C||w[0]!==void 0)&&h--);f=w[0]!==void 0}P[0]||P.shift()}if(p==1)g.e=l,_s=f;else{for(m=1,d=P[0];d>=10;d/=10)m++;g.e=m+l*p-1,$(g,a?r+g.e+1:r,s,f)}return g}}();function $(o,e,t,n){var i,r,s,a,u,c,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(i=1,a=m[0];a>=10;a/=10)i++;if(r=e-i,r<0)r+=ee,s=e,l=m[d=0],u=l/Ee(10,i-s-1)%10|0;else if(d=Math.ceil((r+1)/ee),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,i=1,r%=ee,s=r-ee+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;r%=ee,s=r-ee+i,u=s<0?0:l/Ee(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Ee(10,i-s-1)),c=t<4?(u||n)&&(t==0||t==(o.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(r>0?s>0?l/Ee(10,i-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=o.e+1,m[0]=Ee(10,(ee-e%ee)%ee),o.e=-e||0):m[0]=o.e=0,o;if(r==0?(m.length=d,a=1,d--):(m.length=d+1,a=Ee(10,ee-r),m[d]=s>0?(l/Ee(10,i-s)%Ee(10,s)|0)*a:0),c)for(;;)if(d==0){for(r=1,s=m[0];s>=10;s/=10)r++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(o.e++,m[0]==St&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=St)break;m[d--]=0,a=1}for(r=m.length;m[--r]===0;)m.pop()}return oe&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function Et(o,e,t){if(!o.isFinite())return Us(o);var n,i=o.e,r=Xe(o.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Jt(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(o.e<0?"e":"e+")+o.e):i<0?(r="0."+Jt(-i-1)+r,t&&(n=t-s)>0&&(r+=Jt(n))):i>=s?(r+=Jt(i+1-s),t&&(n=t-i-1)>0&&(r=r+"."+Jt(n))):((n=i+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(r+="."),r+=Jt(n))),r}function Yi(o,e){var t=o[0];for(e*=ee;t>=10;t/=10)e++;return e}function zi(o,e,t){if(e>gc)throw oe=!0,t&&(o.precision=t),Error(Vs);return $(new o(Gi),e,1,!0)}function xt(o,e,t){if(e>ar)throw Error(Vs);return $(new o(Xi),e,t,!0)}function Ds(o){var e=o.length-1,t=e*ee+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function Jt(o){for(var e="";o--;)e+="0";return e}function Ws(o,e,t,n){var i,r=new o(1),s=Math.ceil(n/ee+4);for(oe=!1;;){if(t%2&&(r=r.times(e),Ms(r.d,s)&&(i=!0)),t=He(t/2),t===0){t=r.d.length-1,i&&r.d[t]===0&&++r.d[t];break}e=e.times(e),Ms(e.d,s)}return oe=!0,r}function Os(o){return o.d[o.d.length-1]&1}function qs(o,e,t){for(var n,i=new o(e[0]),r=0;++r<e.length;)if(n=new o(e[r]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function ur(o,e){var t,n,i,r,s,a,u,c=0,l=0,m=0,d=o.constructor,p=d.rounding,f=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(oe=!1,u=f):u=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(Ee(2,m))/Math.LN10*2+5|0,u+=n,t=r=s=new d(1),d.precision=u;;){if(r=$(r.times(o),u,1),t=t.times(++l),a=s.plus(Pe(r,t,u,1)),Xe(a.d).slice(0,u)===Xe(s.d).slice(0,u)){for(i=m;i--;)s=$(s.times(s),u,1);if(e==null)if(c<3&&Qn(s.d,u-n,p,c))d.precision=u+=10,t=r=a=new d(1),l=0,c++;else return $(s,d.precision=f,p,oe=!0);else return d.precision=f,s}s=a}}function en(o,e){var t,n,i,r,s,a,u,c,l,m,d,p=1,f=10,y=o,b=y.d,g=y.constructor,P=g.rounding,w=g.precision;if(y.s<0||!b||!b[0]||!y.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:y.s!=1?NaN:b?0:y);if(e==null?(oe=!1,l=w):l=e,g.precision=l+=f,t=Xe(b),n=t.charAt(0),Math.abs(r=y.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)y=y.times(o),t=Xe(y.d),n=t.charAt(0),p++;r=y.e,n>1?(y=new g("0."+t),r++):y=new g(n+"."+t.slice(1))}else return c=zi(g,l+2,w).times(r+""),y=en(new g(n+"."+t.slice(1)),l-f).plus(c),g.precision=w,e==null?$(y,w,P,oe=!0):y;for(m=y,u=s=y=Pe(y.minus(1),y.plus(1),l,1),d=$(y.times(y),l,1),i=3;;){if(s=$(s.times(d),l,1),c=u.plus(Pe(s,new g(i),l,1)),Xe(c.d).slice(0,l)===Xe(u.d).slice(0,l))if(u=u.times(2),r!==0&&(u=u.plus(zi(g,l+2,w).times(r+""))),u=Pe(u,new g(p),l,1),e==null)if(Qn(u.d,l-f,P,a))g.precision=l+=f,c=s=y=Pe(m.minus(1),m.plus(1),l,1),d=$(y.times(y),l,1),i=a=1;else return $(u,g.precision=w,P,oe=!0);else return g.precision=w,u;u=c,i+=2}}function Us(o){return String(o.s*o.s/0)}function cr(o,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%ee,t<0&&(n+=ee),n<i){for(n&&o.d.push(+e.slice(0,n)),i-=ee;n<i;)o.d.push(+e.slice(n,n+=ee));e=e.slice(n),n=ee-e.length}else n-=i;for(;n--;)e+="0";o.d.push(+e),oe&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function Ac(o,e){var t,n,i,r,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Fs.test(e))return cr(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(fc.test(e))t=16,e=e.toLowerCase();else if(pc.test(e))t=2;else if(yc.test(e))t=8;else throw Error(tn+e);for(r=e.search(/p/i),r>0?(u=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,i=Ws(n,new n(t),r,r*2)),c=Ui(e,t,St),l=c.length-1,r=l;c[r]===0;--r)c.pop();return r<0?new n(o.s*0):(o.e=Yi(c,l),o.d=c,oe=!1,s&&(o=Pe(o,i,a*4)),u&&(o=o.times(Math.abs(u)<54?Ee(2,u):Yn.pow(2,u))),oe=!0,o)}function Pc(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:_n(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/ji(5,t)),e=_n(o,2,e,e);for(var i,r=new o(5),s=new o(16),a=new o(20);t--;)i=e.times(e),e=e.times(r.plus(i.times(s.times(i).minus(a))));return e}function _n(o,e,t,n,i){var r,s,a,u,c=1,l=o.precision,m=Math.ceil(l/ee);for(oe=!1,u=t.times(t),a=new o(n);;){if(s=Pe(a.times(u),new o(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Pe(s.times(u),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(r=m;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,c++}return oe=!0,s.d.length=m+1,s}function ji(o,e){for(var t=o;--e;)t*=o;return t}function Gs(o,e){var t,n=e.s<0,i=xt(o,o.precision,1),r=i.times(.5);if(e=e.abs(),e.lte(r))return qt=n?4:1,e;if(t=e.divToInt(i),t.isZero())qt=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(r))return qt=Os(t)?n?2:3:n?4:1,e;qt=Os(t)?n?1:4:n?3:2}return e.minus(i).abs()}function lr(o,e,t,n){var i,r,s,a,u,c,l,m,d,p=o.constructor,f=t!==void 0;if(f?(at(t,1,nn),n===void 0?n=p.rounding:at(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=Us(o);else{for(l=Et(o),s=l.indexOf("."),f?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Ui(Et(d),10,i),d.e=d.d.length),m=Ui(l,10,i),r=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=f?"0p+0":"0";else{if(s<0?r--:(o=new p(o),o.d=m,o.e=r,o=Pe(o,d,t,n,0,i),m=o.d,r=o.e,c=_s),s=m[t],a=i/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,c)for(;++m[--t]>i-1;)m[t]=0,t||(++r,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=rr.charAt(m[s]);if(f){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=Ui(l,i,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=rr.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>u)for(r-=u;r--;)l+="0";else r<u&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function Ms(o,e){if(o.length>e)return o.length=e,!0}function kc(o){return new this(o).abs()}function hc(o){return new this(o).acos()}function Tc(o){return new this(o).acosh()}function Ic(o,e){return new this(o).plus(e)}function Bc(o){return new this(o).asin()}function xc(o){return new this(o).asinh()}function Sc(o){return new this(o).atan()}function Kc(o){return new this(o).atanh()}function Cc(o,e){o=new this(o),e=new this(e);var t,n=this.precision,i=this.rounding,r=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=xt(this,r,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?xt(this,n,i):new this(0),t.s=o.s):!o.d||e.isZero()?(t=xt(this,r,1).times(.5),t.s=o.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Pe(o,e,r,1)),e=xt(this,r,1),this.precision=n,this.rounding=i,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(Pe(o,e,r,1)),t}function Rc(o){return new this(o).cbrt()}function Lc(o){return $(o=new this(o),o.e+1,2)}function Oc(o,e,t){return new this(o).clamp(e,t)}function Mc(o){if(!o||typeof o!="object")throw Error(Qi+"Object expected");var e,t,n,i=o.defaults===!0,r=["precision",1,nn,"rounding",0,8,"toExpNeg",-Nn,0,"toExpPos",0,Nn,"maxE",0,Nn,"minE",-Nn,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],i&&(this[t]=sr[t]),(n=o[t])!==void 0)if(He(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(tn+t+": "+n);if(t="crypto",i&&(this[t]=sr[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(vs);else this[t]=!1;else throw Error(tn+t+": "+n);return this}function Nc(o){return new this(o).cos()}function _c(o){return new this(o).cosh()}function Xs(o){var e,t,n;function i(r){var s,a,u,c=this;if(!(c instanceof i))return new i(r);if(c.constructor=i,Ns(r)){c.s=r.s,oe?!r.d||r.e>i.maxE?(c.e=NaN,c.d=null):r.e<i.minE?(c.e=0,c.d=[0]):(c.e=r.e,c.d=r.d.slice()):(c.e=r.e,c.d=r.d?r.d.slice():r.d);return}if(u=typeof r,u==="number"){if(r===0){c.s=1/r<0?-1:1,c.e=0,c.d=[0];return}if(r<0?(r=-r,c.s=-1):c.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;oe?s>i.maxE?(c.e=NaN,c.d=null):s<i.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[r]):(c.e=s,c.d=[r]);return}else if(r*0!==0){r||(c.s=NaN),c.e=NaN,c.d=null;return}return cr(c,r.toString())}else if(u!=="string")throw Error(tn+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),c.s=-1):(a===43&&(r=r.slice(1)),c.s=1),Fs.test(r)?cr(c,r):Ac(c,r)}if(i.prototype=V,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Mc,i.clone=Xs,i.isDecimal=Ns,i.abs=kc,i.acos=hc,i.acosh=Tc,i.add=Ic,i.asin=Bc,i.asinh=xc,i.atan=Sc,i.atanh=Kc,i.atan2=Cc,i.cbrt=Rc,i.ceil=Lc,i.clamp=Oc,i.cos=Nc,i.cosh=_c,i.div=Vc,i.exp=vc,i.floor=Ec,i.hypot=Fc,i.ln=Dc,i.log=Wc,i.log10=Uc,i.log2=qc,i.max=Gc,i.min=Xc,i.mod=zc,i.mul=Qc,i.pow=Yc,i.random=jc,i.round=Hc,i.sign=Zc,i.sin=$c,i.sinh=Jc,i.sqrt=el,i.sub=tl,i.sum=nl,i.tan=il,i.tanh=ol,i.trunc=rl,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return i.config(o),i}function Vc(o,e){return new this(o).div(e)}function vc(o){return new this(o).exp()}function Ec(o){return $(o=new this(o),o.e+1,3)}function Fc(){var o,e,t=new this(0);for(oe=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return oe=!0,new this(1/0);t=e}return oe=!0,t.sqrt()}function Ns(o){return o instanceof Yn||o&&o.toStringTag===Es||!1}function Dc(o){return new this(o).ln()}function Wc(o,e){return new this(o).log(e)}function qc(o){return new this(o).log(2)}function Uc(o){return new this(o).log(10)}function Gc(){return qs(this,arguments,"lt")}function Xc(){return qs(this,arguments,"gt")}function zc(o,e){return new this(o).mod(e)}function Qc(o,e){return new this(o).mul(e)}function Yc(o,e){return new this(o).pow(e)}function jc(o){var e,t,n,i,r=0,s=new this(1),a=[];if(o===void 0?o=this.precision:at(o,1,nn),n=Math.ceil(o/ee),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)i=e[r],i>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)i=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(i%1e7),r+=4);r=n/4}else throw Error(vs);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],o%=ee,n&&o&&(i=Ee(10,ee-o),a[r]=(n/i|0)*i);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=ee)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<ee&&(t-=ee-n)}return s.e=t,s.d=a,s}function Hc(o){return $(o=new this(o),o.e+1,this.rounding)}function Zc(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function $c(o){return new this(o).sin()}function Jc(o){return new this(o).sinh()}function el(o){return new this(o).sqrt()}function tl(o,e){return new this(o).sub(e)}function nl(){var o=0,e=arguments,t=new this(e[o]);for(oe=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return oe=!0,$(t,this.precision,this.rounding)}function il(o){return new this(o).tan()}function ol(o){return new this(o).tanh()}function rl(o){return $(o=new this(o),o.e+1,1)}V[Symbol.for("nodejs.util.inspect.custom")]=V.toString;V[Symbol.toStringTag]="Decimal";var Yn=V.constructor=Xs(sr);Gi=new Yn(Gi);Xi=new Yn(Xi);var M=Yn;import pl from"big.js";import $i from"bn.js";import sl from"toformat";var al=sl,jn=al;import Zi from"big.js";import cl from"bn.js";import ll from"decimal.js-light";import Hn from"bn.js";var zs=9007199254740991;function Z(o){let e=ue("Raydium_parseBigNumberish");if(o instanceof Hn)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new Hn(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=zs||o<=-zs)&&e.logWithError(`BigNumberish number overflow: ${o}`),new Hn(String(o))):typeof o=="bigint"?new Hn(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new Hn(0))}var Hi=ue("module/fraction"),mr=jn(Zi),Zn=jn(ll),ml={[0]:Zn.ROUND_DOWN,[1]:Zn.ROUND_HALF_UP,[2]:Zn.ROUND_UP},dl={[0]:Zi.roundDown,[1]:Zi.roundHalfUp,[2]:Zi.roundUp},fe=class{constructor(e,t=new cl(1)){this.numerator=Z(e),this.denominator=Z(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new fe(this.denominator,this.numerator)}add(e){let t=e instanceof fe?e:new fe(Z(e));return this.denominator.eq(t.denominator)?new fe(this.numerator.add(t.numerator),this.denominator):new fe(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof fe?e:new fe(Z(e));return this.denominator.eq(t.denominator)?new fe(this.numerator.sub(t.numerator),this.denominator):new fe(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof fe?e:new fe(Z(e));return new fe(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof fe?e:new fe(Z(e));return new fe(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Hi.logWithError(`${e} is not an integer.`),e<=0&&Hi.logWithError(`${e} is not positive.`),Zn.set({precision:e+1,rounding:ml[n]});let i=new Zn(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Hi.logWithError(`${e} is not an integer.`),e<0&&Hi.logWithError(`${e} is negative.`),mr.DP=e,mr.RM=dl[n]||1,new mr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var fl=ue("Raydium_amount"),Qs=jn(pl);function yl(o,e){let t="0",n="0";if(o.includes(".")){let i=o.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):fl.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var be=class extends fe{constructor(t,n,i=!0,r){let s=new $i(0),a=dr.pow(new $i(t.decimals));if(i)s=Z(n);else{let u=new $i(0),c=new $i(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=yl(n.toString(),t.decimals);u=Z(l),c=Z(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=ue(r||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new be(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new be(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Qs.DP=this.token.decimals,new Qs(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as bl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ys}from"@solana/spl-token";var on={chainId:101,address:bl.default.toBase58(),programId:Ys.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},ze={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ys.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as gr}from"@solana/web3.js";import{PublicKey as Te,SystemProgram as js,SYSVAR_RENT_PUBKEY as gl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as wl}from"@solana/spl-token";function T({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var pr=[T({pubkey:wl,isWritable:!1}),T({pubkey:js.programId,isWritable:!1}),T({pubkey:gl,isWritable:!1})];function fr({publicKey:o,transformSol:e}){let t=yr(o.toString());if(t instanceof Te)return e&&t.equals(Fe)?H:t;if(e&&t.toString()===Fe.toBase58())return H;if(typeof t=="string"){if(t===Te.default.toBase58())return Te.default;try{return new Te(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function yr(o){try{return new Te(o)}catch{return o}}var Ji=new Te("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),rn=new Te("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),pt=new Te("SysvarRent111111111111111111111111111111111"),Hs=new Te("SysvarC1ock11111111111111111111111111111111"),Ut=new Te("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Al=new Te("Sysvar1nstructions1111111111111111111111111"),br=js.programId,qp=new Te("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Up=new Te("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Gp=new Te("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Xp=new Te("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),zp=new Te("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Qp=new Te("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Yp=new Te("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),jp=new Te("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Hp=new Te("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Zp=new Te("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),$p=new Te("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),H=new Te("So11111111111111111111111111111111111111112"),Fe=Te.default;function dt(o){return fr({publicKey:o,transformSol:!0})}var wr=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:r=!1,isToken2022:s=!1}){if(e===Fe.toBase58()||e instanceof gr&&Fe.equals(e)){this.decimals=ze.decimals,this.symbol=ze.symbol,this.name=ze.name,this.mint=new gr(ze.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=r?gr.default:fr({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ie=wr;Ie.WSOL=new wr(D(L({},ze),{mint:ze.address}));var Ar=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},eo=Ar;eo.SOL=new Ar(on);import Pl from"bn.js";var Zs=new fe(new Pl(100)),Ue=class extends fe{toSignificant(e=5,t,n){return this.mul(Zs).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Zs).toFixed(e,t,n)}};var kl=ue("Raydium_price"),ut=class extends fe{constructor(t){let{baseToken:n,quoteToken:i,numerator:r,denominator:s}=t;super(r,s);this.baseToken=n,this.quoteToken=i,this.scalar=new fe(Pr(n.decimals),Pr(i.decimals))}get raw(){return new fe(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new ut({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&kl.logWithError("mul token not equals");let n=super.mul(t);return new ut({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as hl}from"@solana/web3.js";import Tl from"bn.js";function $s(o){return typeof o=="object"&&o!==null&&![Ie,be,hl,fe,Tl,ut,Ue].some(e=>typeof e=="object"&&o instanceof e)}function Qe(o){return typeof o=="string"?yr(o):Array.isArray(o)?o.map(e=>Qe(e)):$s(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,Qe(t)])):o}var ct=new Gt(0),Js=new Gt(1),Yf=new Gt(2),jf=new Gt(3),Hf=new Gt(5),dr=new Gt(10),Zf=new Gt(100),$f=new Gt(1e3),Jf=new Gt(1e4);function Pr(o){return dr.pow(Z(o))}function to(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function or(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Kt=class{constructor(e){this._owner=e}get publicKey(){return Kt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Kt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Kt.isKeyPair(this._owner)}get isPublicKey(){return Kt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Kt.isKeyPair(e)}};import{PublicKey as Cl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Rl}from"@solana/spl-token";import{ComputeBudgetProgram as ea,Keypair as na,PublicKey as Il,Transaction as ia,TransactionMessage as Bl,VersionedTransaction as oa}from"@solana/web3.js";var v={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee"};import{TOKEN_PROGRAM_ID as xl}from"@solana/spl-token";var ta=ue("Raydium_txUtil"),ra=1644;function no(o){let e=[],t=[];return o.microLamports&&(e.push(ea.setComputeUnitPrice({microLamports:o.microLamports})),t.push(v.SetComputeUnitPrice)),o.units&&(e.push(ea.setComputeUnitLimit({units:o.units})),t.push(v.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function Vn(o,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:i.blockhash}async function io(o,e){return o.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);o.onSignature(e,r=>{if(clearTimeout(i),!r.err){t("");return}n(r.err.toString())},"confirmed")})}function kr(o,e){o.length<1&&ta.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&ta.logWithError(`no signers provided:, ${e.toString()}`);let t=new ia;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<ra}catch{return!1}}function le(o,e){let[t,n]=Il.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}function $n({instructions:o,payer:e,signers:t}){return kr(o,[e,...t])}function Jn({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=na.generate().publicKey.toString()}){let r=new Bl({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new oa(r).serialize()).toString("base64").length<ra}catch{return!1}}var Sl=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o),Kl=o=>{let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});o instanceof oa&&(e=Sl(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function yn(o){let e=[];return o.forEach(t=>{t instanceof ia&&(t.recentBlockhash||(t.recentBlockhash=xl.toBase58()),t.feePayer||(t.feePayer=na.generate().publicKey)),e.push(Kl(t))}),console.log("simulate tx string:",e),e}function ce(o,e,t){return le([o.toBuffer(),(t!=null?t:Rl).toBuffer(),e.toBuffer()],new Cl("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as re}from"@solana/web3.js";var sa=new re("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),aa=new re("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),ua=new re("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),ei=new re("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Py=new re("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),ca=new re("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),hr=new re("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),oo=new re("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),ky=new re("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),la=new re("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),bn=new re("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),ti=new re("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),ro=new re("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),hy=new re("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),ma=new re("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Ll=new re("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Ol=new re("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Ml=new re("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Nl=new re("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),so=new re("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),da=new re("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Ty=new re("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),_l=new re("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Vl=new re("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),vl=new re("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),ao=new re("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),El=new re("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),uo=new re("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Fl=new re("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),ni={IDO_PROGRAM_ID_V1:Ll,IDO_PROGRAM_ID_V2:Ol,IDO_PROGRAM_ID_V3:Ml,IDO_PROGRAM_ID_V4:Nl};var Iy={SERUM_MARKET:re.default,OPENBOOK_MARKET:new re("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:re.default,FarmV3:new re("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new re("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new re("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new re("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new re("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new re("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new re("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new re("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new re("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:_l,CREATE_CPMM_POOL_AUTH:Vl,CREATE_CPMM_POOL_FEE_ACC:vl,FEE_DESTINATION_ID:new re("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:El,LCOK_CPMM_AUTH:Fl};import Ct from"bn.js";var ii=1e4;function ge(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=D(L({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),r=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new Ct(r.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===ii){let u=new Ct(r.maximumFee.toString());return{amount:o.add(u),fee:u,expirationTime:a}}else{let u=sn(o.mul(new Ct(ii)),new Ct(ii-r.transferFeeBasisPoints)),c=new Ct(r.maximumFee.toString()),l=u.sub(o).gt(c)?o.add(c):u,m=sn(l.mul(new Ct(r.transferFeeBasisPoints)),new Ct(ii)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=sn(o.mul(new Ct(r.transferFeeBasisPoints)),new Ct(ii)),c=u.gt(s)?s:u;return{amount:o,fee:c,expirationTime:a}}}function Rt(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function sn(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new Ct(0))?t.add(new Ct(1)):t}import{PublicKey as pa,AddressLookupTableAccount as co}from"@solana/web3.js";async function Tr({connection:o,address:e}){let t=await Bt(o,[...new Set(e.map(i=>i.toString()))].map(i=>new pa(i))),n={};for(let i=0;i<e.length;i++){let r=t[i],s=e[i];if(!r)continue;let a=new co({key:s,state:co.deserialize(r.data)});n[s.toString()]=a,lo[s.toString()]=a}return n}var lo={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new co({key:new pa("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:co.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};import{PublicKey as oi,sendAndConfirmTransaction as Ir,Transaction as ri,TransactionMessage as si,VersionedTransaction as ai}from"@solana/web3.js";import Dl from"axios";var mo=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.api=e.api}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Dl.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=no(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==oi.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(L({},t||{})):this.build(t)}build(e){var n;let t=new ri;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var c;let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a}=i||{},u=r!=null?r:await Vn(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),yn([t]),(c=this.owner)!=null&&c.isKeyPair)return{txId:a?await Ir(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var c;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),r=t.filter(l=>l.transaction.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],u=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:f,skipPreflight:y=!0}=l||{},b=f!=null?f:await Vn(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let P=[],w=0;for(let k of s){if(++w,w<=p)continue;let I=await Ir(this.connection,k,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});P.push(I)}return{txIds:P,signedTxs:s}}return{txIds:await await Promise.all(s.map(async P=>(P.recentBlockhash=b,await this.connection.sendRawTransaction(P.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let P=s.map((k,I)=>(k.recentBlockhash=b,a[I].length&&k.sign(...a[I]),k));yn(P);let w=await this.signAllTransactions(P);if(m){let k=0,I=[],h=async()=>{if(!w[k])return;let S=await this.connection.sendRawTransaction(w[k].serialize(),{skipPreflight:y});I.push({txId:S,status:"sent",signedTx:w[k]}),d==null||d([...I]),k++,this.connection.onSignature(S,B=>{let C=I.findIndex(x=>x.txId===S);C>-1&&(I[C].status=B.err?"error":"success"),d==null||d([...I]),B.err||h()},"processed"),this.connection.getSignatureStatus(S)};return await h(),{txIds:I.map(S=>S.txId),signedTxs:w}}else{let k=[];for(let I=0;I<w.length;I+=1){let h=await this.connection.sendRawTransaction(w[I].serialize(),{skipPreflight:y});k.push(h)}return{txIds:k,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var y;let f=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:r}=f,s=Ne(f,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=L(L({},this.cluster==="devnet"?{}:lo),t),u=Array.from(new Set([...n,...this.lookupTableAddress])),c=[];for(let b of u)a[b]===void 0&&c.push(new oi(b));let l=await Tr({connection:this.connection,address:c});for(let[b,g]of Object.entries(l))a[b]=g;let m=i?oi.default.toBase58():r!=null?r:await Vn(this.connection,this.blockhashCommitment),d=new si({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((y=this.owner)==null?void 0:y.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new ai(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var w;let{skipPreflight:g=!0,sendAndConfirm:P}=b||{};if(yn([p]),(w=this.owner)!=null&&w.isKeyPair){let k=await this.connection.sendTransaction(p,{skipPreflight:g});return P&&await io(this.connection,k),{txId:k,signedTx:p}}if(this.signAllTransactions){let k=await this.signAllTransactions([p]);return{txId:await this.connection.sendTransaction(k[0],{skipPreflight:g}),signedTx:k[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var c;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),r=t.filter(l=>l.builder.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],u=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async l=>{var y;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:f=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),yn(s),(y=this.owner)!=null&&y.isKeyPair){if(m){let b=[];for(let g of s){let P=await this.connection.sendTransaction(g,{skipPreflight:f});await io(this.connection,P),b.push(P)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,P=[],w=async()=>{if(!b[g])return;let k=await this.connection.sendTransaction(b[g],{skipPreflight:f});P.push({txId:k,status:"sent",signedTx:b[g]}),d==null||d([...P]),g++,this.connection.onSignature(k,I=>{let h=P.findIndex(S=>S.txId===k);h>-1&&(P[h].status=I.err?"error":"success"),d==null||d([...P]),I.err||w()},"processed"),this.connection.getSignatureStatus(k)};return w(),{txIds:[],signedTxs:b}}else{let g=[];for(let P=0;P<b.length;P+=1){let w=await this.connection.sendTransaction(b[P],{skipPreflight:f});g.push(w)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let c=e||{},{computeBudgetConfig:t}=c,n=Ne(c,["computeBudgetConfig"]),i=t?no(t):{instructions:[],instructionTypes:[]},r=this.signers.reduce((m,d)=>D(L({},m),{[d.publicKey.toBase58()]:d}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(m=>{let d=[...u,m],p=t?[...i.instructions,...d]:d,y=[...new Set(d.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new oi(b));if(u.length<12&&$n({instructions:p,payer:this.feePayer,signers:y})||$n({instructions:d,payer:this.feePayer,signers:y}))u.push(m);else{if(u.length===0)throw Error("item ins too big");$n({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:y})?s.push(new ri().add(...i.instructions,...u)):s.push(new ri().add(...u)),a.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>r[b]).filter(b=>b!==void 0)),u=[m]}}),u.length>0){let d=[...new Set(u.map(p=>p.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(p=>r[p]).filter(p=>p!==void 0);$n({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new ri().add(...i.instructions,...u)):s.push(new ri().add(...u)),a.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&a.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async m=>{var P;let{sequentially:d,onTxUpdate:p,skipTxCount:f=0,recentBlockHash:y,skipPreflight:b=!0}=m||{},g=y!=null?y:await Vn(this.connection,this.blockhashCommitment);if(s.forEach(async(w,k)=>{w.recentBlockhash=g,a[k].length&&w.sign(...a[k])}),yn(s),(P=this.owner)!=null&&P.isKeyPair){if(d){let w=0,k=[];for(let I of s){if(++w,w<=f){k.push("tx skipped");continue}let h=await Ir(this.connection,I,this.signers.find(S=>S.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});k.push(h)}return{txIds:k,signedTxs:s}}return{txIds:await Promise.all(s.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b}))),signedTxs:s}}if(this.signAllTransactions){let w=await this.signAllTransactions(s.slice(f,s.length)),k=[...s.slice(0,f),...w];if(d){let I=0,h=[],S=async()=>{if(!k[I])return;I<f&&(h.push({txId:"",status:"success",signedTx:k[I]}),p==null||p([...h]),I++,S());let B=await this.connection.sendRawTransaction(k[I].serialize(),{skipPreflight:b});h.push({txId:B,status:"sent",signedTx:k[I]}),p==null||p([...h]),I++,this.connection.onSignature(B,C=>{let x=h.findIndex(R=>R.txId===B);x>-1&&(h[x].status=C.err?"error":"success"),p==null||p([...h]),C.err||S()},"processed"),this.connection.getSignatureStatus(B)};return await S(),{txIds:h.map(B=>B.txId),signedTxs:k}}else{let I=[];for(let h=0;h<k.length;h+=1){let S=await this.connection.sendRawTransaction(k[h].serialize(),{skipPreflight:b});I.push(S)}return{txIds:I,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){var g;let b=e||{},{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:i=[]}=b,r=Ne(b,["computeBudgetConfig","lookupTableCache","lookupTableAddress"]),s=L(L({},this.cluster==="devnet"?{}:lo),n),a=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let P of a)s[P]===void 0&&u.push(new oi(P));let c=await Tr({connection:this.connection,address:u});for(let[P,w]of Object.entries(c))s[P]=w;let l=t?no(t):{instructions:[],instructionTypes:[]},m=await Vn(this.connection,this.blockhashCommitment),d=this.signers.reduce((P,w)=>D(L({},P),{[w.publicKey.toBase58()]:w}),{}),p=[],f=[],y=[];if(this.allInstructions.forEach(P=>{let w=[...y,P],k=t?[...l.instructions,...w]:w;if(y.length<12&&Jn({instructions:k,payer:this.feePayer,lookupTableAddressAccount:s})||Jn({instructions:w,payer:this.feePayer,lookupTableAddressAccount:s}))y.push(P);else{if(y.length===0)throw Error("item ins too big");let I={};for(let h of[...new Set(a)])s[h]!==void 0&&(I[h]=s[h]);if(t&&Jn({instructions:[...l.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let h=new si({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...y]}).compileToV0Message(Object.values(s));p.push(new ai(h))}else{let h=new si({payerKey:this.feePayer,recentBlockhash:m,instructions:[...y]}).compileToV0Message(Object.values(s));p.push(new ai(h))}f.push(Array.from(new Set(y.map(h=>h.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat())).map(h=>d[h]).filter(h=>h!==void 0)),y=[P]}}),y.length>0){let w=[...new Set(y.map(k=>k.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&Jn({instructions:[...l.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let k=new si({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...y]}).compileToV0Message(Object.values(s));p.push(new ai(k))}else{let k=new si({payerKey:this.feePayer,recentBlockhash:m,instructions:[...y]}).compileToV0Message(Object.values(s));p.push(new ai(k))}f.push(w)}return(g=this.owner)!=null&&g.signer&&f.forEach(P=>{P.some(w=>w.publicKey.equals(this.owner.publicKey))||P.push(this.owner.signer)}),{builder:this,transactions:p,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async P=>{var B;let{sequentially:w,onTxUpdate:k,skipTxCount:I=0,recentBlockHash:h,skipPreflight:S=!0}=P||{};if(p.map(async(C,x)=>{f[x].length&&C.sign(f[x]),h&&(C.message.recentBlockhash=h)}),yn(p),(B=this.owner)!=null&&B.isKeyPair){if(w){let C=0,x=[];for(let R of p){if(++C,C<=I){console.log("skip tx: ",C),x.push("tx skipped");continue}let F=await this.connection.sendTransaction(R,{skipPreflight:S});await io(this.connection,F),x.push(F)}return{txIds:x,signedTxs:p}}return{txIds:await Promise.all(p.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:S}))),signedTxs:p}}if(this.signAllTransactions){let C=await this.signAllTransactions(p.slice(I,p.length)),x=[...p.slice(0,I),...C];if(w){let R=0,F=[],O=async()=>{if(!x[R])return;if(R<I){F.push({txId:"",status:"success",signedTx:x[R]}),k==null||k([...F]),R++,O();return}let X=await this.connection.sendTransaction(x[R],{skipPreflight:S});F.push({txId:X,status:"sent",signedTx:x[R]}),k==null||k([...F]),R++,this.connection.onSignature(X,q=>{let W=F.findIndex(Se=>Se.txId===X);W>-1&&(F[W].status=q.err?"error":"success"),k==null||k([...F]),q.err||O()},"processed"),this.connection.getSignatureStatus(X)};return O(),{txIds:[],signedTxs:x}}else{let R=[];for(let F=0;F<x.length;F+=1){let O=await this.connection.sendTransaction(x[F],{skipPreflight:S});R.push(O)}return{txIds:R,signedTxs:x}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:r||{}}}};var _e={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",JITO:"https://mainnet.block-engine.jito.wtf",JITO_TRANSACTION:"/api/v1/transactions",JITO_BUNDLE:"/api/v1/bundles",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},ub=L({},_e);var fa="ray_tab_hash",Br="ray_req_hash",Wl=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(fa);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(fa,o)),o},po=async n=>{var i=n,{logCount:o=1e3,removeLastLog:e}=i,t=Ne(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let r=JSON.parse(localStorage.getItem(Br)||"[]").slice(0,o-1);e&&r.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),r.unshift(D(L({},t),{time:Date.now(),session:Wl()}));try{localStorage.setItem(Br,JSON.stringify(r))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(r[0].data=a+(a.length>100?"...":"");!s;){r.pop();let u=JSON.stringify(t.data).substring(0,100);r[0].data=u+(u.length>100?"...":"");try{localStorage.setItem(Br,JSON.stringify(r)),s=!0}catch{s=!1}}return new Promise(u=>u())}return po(D(L({},t),{logCount:o,removeLastLog:!0}))}};var fo=ue("Raydium_Api"),xr=new Map;var yo=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=i||1e3,this.api=ya.create({baseURL:this.urlConfigs.BASE_HOST||_e.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return fo.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>(fo.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:d}=a;return n&&po({status:c,url:`${m}${d}`,params:a.params,data:u,logCount:this.logCount}),fo.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:d}=a;return n&&po({status:c,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),fo.error(`${l.toUpperCase()} ${m}${d} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||_e.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||_e.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||_e.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await ya.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,r)=>i+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||_e.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||_e.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||_e.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||_e.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||_e.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||_e.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||_e.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>xr.has(s)?(n.push(xr.get(s)),!1):!0),r=[];return i.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||_e.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),r.forEach(a=>{xr.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:r="default",order:s="desc",page:a=1}=e,[u,c]=[t&&dt(t).toBase58(),n&&n!=="undefined"?dt(n).toBase58():""],[l,m]=c&&u>c?[c,u]:[u,c];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||_e.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||_e.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||_e.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||_e.CHECK_AVAILABILITY)).data}async sendTxToJito(e,t){let n=t?this.urlConfigs.JITO_BUNDLE||_e.JITO_BUNDLE:this.urlConfigs.JITO_TRANSACTION||_e.JITO_TRANSACTION;return(await this.api.post(n,{jsonrpc:"2.0",id:1,method:t?"sendBundle":"sendTransaction",params:e},{baseURL:this.urlConfigs.JITO||_e.JITO})).data}};var bo="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",ba="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as To,SystemProgram as bm}from"@solana/web3.js";import{AccountLayout as Dn,createAssociatedTokenAccountInstruction as vr,TOKEN_PROGRAM_ID as cn,TOKEN_2022_PROGRAM_ID as gm}from"@solana/spl-token";var Sr=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Be=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=ue(t)}createTxBuilder(e){return this.scope.checkOwner(),new mo({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Sr(e))}logInfo(...e){this.logger.info(Sr(e))}logAndCreateError(...e){let t=Sr(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as lm,SystemProgram as mm}from"@solana/web3.js";import dm from"bn.js";import{createCloseAccountInstruction as pm,createInitializeAccountInstruction as fm,createTransferInstruction as ym,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";import{Keypair as sm,PublicKey as Ra}from"@solana/web3.js";import am from"bn.js";import{TOKEN_PROGRAM_ID as um}from"@solana/spl-token";function ql(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function Kr(o,...e){if(!ql(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function Cr(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function ga(o,e){Kr(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var wo=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Lt=(o,e)=>o<<32-e|o>>>e;var Gb=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ul(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function Rr(o){return typeof o=="string"&&(o=Ul(o)),Kr(o),o}var go=class{clone(){return this._cloneInto()}},Xb={}.toString;function wa(o){let e=n=>o().update(Rr(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function Gl(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let i=BigInt(32),r=BigInt(4294967295),s=Number(t>>i&r),a=Number(t&r),u=n?4:0,c=n?0:4;o.setUint32(e+u,s,n),o.setUint32(e+c,a,n)}var Aa=(o,e,t)=>o&e^~o&t,Pa=(o,e,t)=>o&e^o&t^e&t,Ao=class extends go{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=wo(this.buffer)}update(e){Cr(this);let{view:t,buffer:n,blockLen:i}=this;e=Rr(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(i-this.pos,r-s);if(a===i){let u=wo(e);for(;i<=r-s;s+=i)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Cr(this),ga(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Gl(n,i-8,BigInt(this.length*8),r),this.process(n,0);let a=wo(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:r,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=r,e.destroyed=s,i%t&&e.buffer.set(n),e}};var Xl=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),an=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),un=new Uint32Array(64),Lr=class extends Ao{constructor(){super(64,32,8,!1),this.A=an[0]|0,this.B=an[1]|0,this.C=an[2]|0,this.D=an[3]|0,this.E=an[4]|0,this.F=an[5]|0,this.G=an[6]|0,this.H=an[7]|0}get(){let{A:e,B:t,C:n,D:i,E:r,F:s,G:a,H:u}=this;return[e,t,n,i,r,s,a,u]}set(e,t,n,i,r,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)un[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=un[m-15],p=un[m-2],f=Lt(d,7)^Lt(d,18)^d>>>3,y=Lt(p,17)^Lt(p,19)^p>>>10;un[m]=y+un[m-7]+f+un[m-16]|0}let{A:n,B:i,C:r,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let d=Lt(a,6)^Lt(a,11)^Lt(a,25),p=l+d+Aa(a,u,c)+Xl[m]+un[m]|0,y=(Lt(n,2)^Lt(n,13)^Lt(n,22))+Pa(n,i,r)|0;l=c,c=u,u=a,a=s+p|0,s=r,r=i,i=n,n=p+y|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,i,r,s,a,u,c,l)}roundClean(){un.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ka=wa(()=>new Lr);import{PublicKey as im}from"@solana/web3.js";import xa,{isBN as Sa}from"bn.js";import{bits as zl,BitStructure as eg,blob as Ql,Blob as tg,cstr as ng,f32 as ig,f32be as og,f64 as rg,f64be as sg,greedy as ag,Layout as Yl,ns64 as ug,ns64be as cg,nu64 as jl,nu64be as lg,offset as mg,s16 as dg,s16be as pg,s24 as fg,s24be as yg,s32 as Hl,s32be as bg,s40 as gg,s40be as wg,s48 as Ag,s48be as Pg,s8 as kg,seq as Zl,struct as hg,Structure as $l,u16 as Jl,u16be as Tg,u24 as Ig,u24be as Bg,u32 as em,u32be as xg,u40 as Sg,u40be as Kg,u48 as Cg,u48be as Rg,u8 as tm,UInt as nm,union as Lg,Union as Og,unionLayoutDiscriminator as Mg,utf8 as Ng}from"@solana/buffer-layout";var Po=Yl,ha=$l;var Or=nm;var Ta=tm,Xt=Jl;var Mr=em;var Ia=jl;var Ye=Hl;var Ba=Zl;var ye=Ql;var Nr=zl;var gn=class extends Po{constructor(t,n,i){super(t,i);this.blob=ye(t),this.signed=n}decode(t,n=0){let i=new xa(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new xa(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},ko=class extends Po{constructor(t){super(8,t);this._lower=Nr(Mr(),!1),this._upper=Nr(Mr(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),r=this._upper.decode(t,n+this._lower.span);return L(L({},i),r)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function G(o){return new Or(1,o)}function Ze(o){return new Or(4,o)}function A(o){return new gn(8,!1,o)}function J(o){return new gn(16,!1,o)}function Ka(o){return new gn(1,!0,o)}function vn(o){return new gn(8,!0,o)}function Ca(o){return new gn(16,!0,o)}var ho=class extends Po{constructor(t,n,i,r){super(t.span,r);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function K(o){return new ho(ye(32),e=>new im(e),e=>e.toBuffer(),o)}function De(o){return new ho(Ta(),om,rm,o)}function om(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function rm(o){return o?1:0}var _r=class extends ha{decode(e,t){return super.decode(e,t)}};function E(o,e,t){return new _r(o,e,t)}function j(o,e,t){let n,i=typeof e=="number"?e:Sa(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=Sa(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return Ba(o,i,t)}var En=E([K("mint"),K("owner"),A("amount"),Ze("delegateOption"),K("delegate"),G("state"),Ze("isNativeOption"),A("isNative"),A("delegatedAmount"),Ze("closeAuthorityOption"),K("closeAuthority")]);var nw=ue("Raydium_Util");function La({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:r,account:s}of t.value){let a=En.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:r,mint:u,amount:c,isAssociated:ce(o,u,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),i.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Ra.default,amount:new am(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function Ke({fromPublicKey:o,programId:e=um,assignSeed:t}){let n=t?btoa(t).slice(0,32):sm.generate().publicKey.toBase58().slice(0,32);return{publicKey:cm(o,n,e),seed:n}}function cm(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),i=ka(n);return new Ra(i)}function Vr(o){let{mint:e,tokenAccount:t,owner:n,programId:i=Fn}=o;return fm(t,e,n,i)}function zt(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:r=Fn}=o;return pm(e,t,i,n,r)}async function Qt(o){let{connection:e,amount:t,commitment:n,payer:i,owner:r,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(En.span,n),u=Z(t).add(new dm(a)),c=Ke({fromPublicKey:i,programId:Fn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[mm.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:En.span,programId:Fn}),Vr({mint:new lm(ze.address),tokenAccount:c.publicKey,owner:r,programId:Fn})],instructionTypes:[v.CreateAccount,v.InitAccount],endInstructionTypes:s?[]:[v.CloseAccount],endInstructions:s?[]:[zt({tokenAccount:c.publicKey,payer:i,owner:r})]}}function Oa({source:o,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:r=Fn}){return ym(o,e,t,BigInt(String(n)),i,r)}var ci=class extends Be{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=r!=null?r:!1,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return ce(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<1e3*60*3)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=L(L({},{}),t),[r,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:cn},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:gm},i.commitment)]),{tokenAccounts:u,tokenAccountRawInfos:c}=La({owner:this.scope.ownerPubKey,solAccountResp:r,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,programId:n=cn,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of r){let{publicKey:u}=a;if(u&&(!i||i&&s.equals(u)))return u}}async getOrCreateTokenAccount(t){var f,y,b,g;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:r,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new To(t.tokenProgram||cn),m=this.getAssociatedTokenAccount(n,new To(l)),d=(a?[]:this.tokenAccountRawInfos).filter(P=>P.accountInfo.mint.equals(n)&&(!r||P.pubkey.equals(m))).sort((P,w)=>P.accountInfo.amount.lt(w.accountInfo.amount)?1:-1);if(i===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(r){let P=vr(s,m,s,n,l);if(c){let w=await this.scope.connection.getAccountInfo(m);if(w===null)(f=p.instructions)==null||f.push(P),p.instructionTypes.push(v.CreateATA);else if(!(w.owner.equals(l)&&Dn.decode(w.data).mint.equals(n)&&Dn.decode(w.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else p.instructions.push(P),p.instructionTypes.push(v.CreateATA);if(n.equals(H)&&i.amount){let w=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(y=i.amount)!=null?y:0,skipCloseAccount:u});p.instructions.push(...w.instructions||[]),p.endInstructions.push(...w.endInstructions||[]),p.instructionTypes.push(...w.instructionTypes||[]),p.endInstructionTypes.push(...w.endInstructionTypes||[]),i.amount&&(p.instructions.push(Oa({source:w.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:cn})),p.instructionTypes.push(v.TransferAmount))}return u||(p.endInstructions.push(zt({owner:s,payer:i.payer||s,tokenAccount:m,programId:l})),p.endInstructionTypes.push(v.CloseAccount)),{account:m,instructionParams:p}}else{let P=Ke({fromPublicKey:s,programId:l}),w=await this.scope.connection.getMinimumBalanceForRentExemption(Dn.span),k=bm.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:P.seed,newAccountPubkey:P.publicKey,lamports:w+Number((g=(b=i.amount)==null?void 0:b.toString())!=null?g:0),space:Dn.span,programId:l});return p.instructions.push(k,Vr({mint:n,tokenAccount:P.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(v.CreateAccount),p.instructionTypes.push(v.InitAccount),u||(p.endInstructions.push(zt({owner:s,payer:i.payer||s,tokenAccount:P.publicKey,programId:l})),p.endInstructionTypes.push(v.CloseAccount)),{account:P.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:t,programId:n=cn,autoUnwrapWSOLToSOL:i}){var u;await this.fetchWalletTokenAccounts();let r=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!r){let c=this.getAssociatedTokenAccount(t,n),l=await vr(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[v.CreateATA],r=c}return i&&H.toBase58()===t.toBase58()&&(a.endInstructions=[zt({owner:s,payer:s,tokenAccount:r,programId:n})],a.endInstructionTypes=[v.CloseAccount]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:r,programId:s=cn,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(r,s);if(new To(H).equals(r)){let p=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:i,skipCloseAccount:l});return L({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!c){let p=[],f=vr(this.scope.ownerPubKey,d,this.scope.ownerPubKey,r,s);if(m){let y=await this.scope.connection.getAccountInfo(d);if(y===null)p.push(f);else if(!(y.owner.equals(cn)&&Dn.decode(y.data).mint.equals(r)&&Dn.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${r.toString()}, ata: ${d.toString()}`)}else p.push(f);return{tokenAccount:d,instructions:p,instructionTypes:[v.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=cn,amount:r,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new To(H))&&s){let l=await this.handleTokenAccount({side:"in",amount:r||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:d}=l,p=Ne(l,["tokenAccount"]);u=d,c.addInstruction(p)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let m=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:d}=m,p=Ne(m,["tokenAccount"]);u=d,c.addInstruction(p)}return L({tokenAccount:u},c.AllTxData)}};import{PublicKey as we,SystemProgram as Nm}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as _m}from"@solana/spl-token";import{PublicKey as _a}from"@solana/web3.js";var Er=E([G("instruction")]),Fr=E([G("instruction")]),wm=E([A("rewardState"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardLastUpdateTime"),A("totalReward"),A("totalRewardEmissioned"),A("rewardClaimed"),A("rewardPerSecond"),J("accRewardPerShare"),K("rewardVault"),K("rewardMint"),K("rewardSender"),A("rewardType"),j(A(),15,"padding")]),Am=E([A("state"),A("nonce"),K("lpVault"),K("rewardVault"),K(),K(),A(),A(),A("totalReward"),J("perShareReward"),A("lastSlot"),A("perSlotReward")]),Pm=E([A("state"),A("nonce"),K("lpVault"),K("rewardVaultA"),A("totalRewardA"),J("perShareRewardA"),A("perSlotRewardA"),G("option"),K("rewardVaultB"),ye(7),A("totalRewardB"),J("perShareRewardB"),A("perSlotRewardB"),A("lastSlot"),K()]),km=E([A(),A("state"),A("nonce"),A("validRewardTokenNum"),J("rewardMultiplier"),A("rewardPeriodMax"),A("rewardPeriodMin"),A("rewardPeriodExtend"),K("lpMint"),K("lpVault"),j(wm,5,"rewardInfos"),K("creator"),K(),j(A(),32,"padding")]),hm=new Proxy(Am,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return D(L({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(o,e,t)}}),Tm=new Proxy(Pm,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return D(L({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(o,e,t)}}),Io=new Proxy(km,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return D(L({},i),{version:6,rewardInfos:i.rewardInfos.map(r=>{var s;return D(L({},r),{rewardType:((s=Object.entries(ln).find(a=>String(a[1])===r.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),Im=E([A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),Dr=E([G("instruction"),A("nonce"),j(Im,5,"rewardTimeInfo")]),Wr=E([G("instruction"),A("rewardReopenTime"),A("rewardEndTime"),A("rewardPerSecond")]),qr=E([G("instruction"),A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),Nw=E([A("state"),K("id"),K("owner"),A("deposited"),j(A(),1,"rewardDebts")]),Ur=E([A("state"),K("id"),K("owner"),A("deposited"),j(J(),1,"rewardDebts"),A(""),A("voteLockedBalance"),j(A(),15)]),_w=E([A("state"),K("id"),K("owner"),A("deposited"),j(A(),2,"rewardDebts")]),Ma=E([A("state"),K("id"),K("owner"),A("deposited"),j(J(),2,"rewardDebts"),j(A(),17)]),Na=E([A(),A("state"),K("id"),K("owner"),A("deposited"),j(J(),5,"rewardDebts"),j(A(),16)]),ft=E([G("instruction"),A("amount")]),Bm=E([K("mint"),K("grantAuthority"),A("baselineVoteWeightScaledFactor"),A("maxExtraLockupVoteWeightScaledFactor"),A("lockupSaturationSecs"),Ka("digitShift"),j(G(),7,"reserved1"),j(A(),7,"reserved2")]),xm=E([ye(8),K("governanceProgramId"),K("realm"),K("realmGoverningTokenMint"),K("realmAuthority"),j(G(),32,"reserved1"),j(Bm,4,"votingMints"),vn("timeOffset"),G("bump"),j(G(),7,"reserved2"),j(A(),11,"reserved3")]),Sm=E([vn("startTime"),vn("endTime"),G("kind"),j(G(),15,"reserved")]),Km=E([j(Sm,1,"lockup"),A("amountDeposited_native"),A("amountInitiallyLockedNative"),De("isUsed"),De("allowClawback"),G("votingMintConfigIdx"),j(G(),29,"reserved")]),Cm=E([ye(8),K("voterAuthority"),K("registrar"),j(Km,32,"deposits"),G("voterBump"),G("voterWweightRecordBump"),j(G(),94,"reserved")]);var Uw=ue("Raydium_farm_config"),Va=new _a("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),va=new _a("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var Ea={3:Ur,5:Ma,6:Na},Gr=o=>[3,4,5,6].indexOf(o)!==-1,Xr=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,r={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=r[e])==null?void 0:s.call(r)},ln={"Standard SPL":0,"Option tokens":1},wt={[sa.toString()]:3,[aa.toString()]:4,[ua.toString()]:5,[ei.toString()]:6};import{PublicKey as ae,SystemProgram as Wa,SYSVAR_CLOCK_PUBKEY as di,SYSVAR_RENT_PUBKEY as Om,TransactionInstruction as Pt}from"@solana/web3.js";import qa from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as kA,createAssociatedTokenAccountInstruction as hA,TOKEN_PROGRAM_ID as Yt}from"@solana/spl-token";import Rm from"bn.js";var Lm=ue("Raydium.farm.util");function li({programId:o,poolId:e,mint:t,type:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return i}function At({programId:o,poolId:e,owner:t,version:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return i}var Fa=({programId:o,poolId:e})=>le([e.toBuffer()],o);function Da(o){return{isSet:new Rm(1),rewardPerSecond:Z(o.perSecond),rewardOpenTime:Z(o.openTime),rewardEndTime:Z(o.endTime),rewardType:Z(ln[o.rewardType])}}function zr(o){return Z(o.endTime).sub(Z(o.openTime)).mul(Z(o.perSecond))}function mi(o){let e=Ea[o];return e||Lm.logWithError("invalid version",o),e}var Mm=ue("Raydium_farm_instruction"),MA={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function pi(o){let{version:e,id:t,ledger:n,programId:i,owner:r}=o,s={3:9,5:10}[e];s||Mm.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Er.span);Er.encode({instruction:s},a);let u=[T({pubkey:t}),T({pubkey:n}),T({pubkey:r,isWritable:!1}),T({pubkey:Wa.programId,isWritable:!1}),T({pubkey:Om,isWritable:!1})];return{instruction:new Pt({programId:i,keys:u,data:a}),instructionType:v.FarmV3CreateLedger}}function Ua(o){var n;let e=Buffer.alloc(Dr.span);Dr.encode({instruction:0,nonce:new qa(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...pr,T({pubkey:o.farmId}),T({pubkey:o.farmAuthority,isWritable:!1}),T({pubkey:o.lpVault}),T({pubkey:o.lpMint,isWritable:!1}),T({pubkey:o.lockVault}),T({pubkey:o.lockMint,isWritable:!1}),T({pubkey:(n=o.lockUserAccount)!=null?n:Fe}),T({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let i of o.rewardInfo)t.push(T({pubkey:i.rewardMint,isWritable:!1}),T({pubkey:i.rewardVault}),T({pubkey:i.userRewardToken}));return{instruction:new Pt({programId:o.programId,keys:t,data:e}),instructionType:v.FarmV6Create}}function Ga(o){let e=Buffer.alloc(Fr.span);Fr.encode({instruction:5},e);let t=[T({pubkey:Yt,isWritable:!1}),T({pubkey:o.id}),T({pubkey:o.authority,isWritable:!1}),T({pubkey:o.lpVault,isWritable:!1}),T({pubkey:o.rewardVault}),T({pubkey:o.userRewardToken}),T({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new Pt({programId:o.programId,keys:t,data:e}),instructionType:v.FarmV6CreatorWithdraw}}function Qr({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let r=Buffer.alloc(Wr.span);Wr.encode({instruction:3,rewardReopenTime:Z(i.openTime),rewardEndTime:Z(i.endTime),rewardPerSecond:Z(i.perSecond)},r);let s=[T({pubkey:Yt,isWritable:!1}),T({pubkey:n.id}),T({pubkey:n.lpVault,isWritable:!1}),T({pubkey:e}),T({pubkey:t}),T({pubkey:o,isWritable:!1,isSigner:!0})];return new Pt({programId:n.programId,keys:s,data:r})}function Yr({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let r=Buffer.alloc(qr.span);qr.encode({instruction:4,isSet:new qa(1),rewardPerSecond:Z(i.perSecond),rewardOpenTime:Z(i.openTime),rewardEndTime:Z(i.endTime),rewardType:Z(ln[i.rewardType])},r);let s=[...pr,T({pubkey:t.id}),T({pubkey:t.authority,isWritable:!1}),T({pubkey:i.mint,isWritable:!1}),T({pubkey:n}),T({pubkey:e}),T({pubkey:o,isWritable:!1,isSigner:!0})];return new Pt({programId:t.programId,keys:s,data:r})}function fi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,u]=[new ae(e.programId),new ae(e.id)],c=At({programId:a,poolId:u,owner:r,version:6}),l=Buffer.alloc(ft.span);ft.encode({instruction:2,amount:Z(s)},l);let m=[T({pubkey:Yt,isWritable:!1}),T({pubkey:u}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:new ae(t.lpVault)}),T({pubkey:c}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(T({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(T({pubkey:i[d]}));return new Pt({programId:a,keys:m,data:l})}function yi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=At({programId:u,poolId:c,owner:r,version:5}),m=Buffer.alloc(ft.span);ft.encode({instruction:12,amount:Z(s)},m);let d=[T({pubkey:c}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:l}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n}),T({pubkey:new ae(t.lpVault)}),T({pubkey:i[0]}),T({pubkey:new ae(t.rewardInfos[0].vault)}),T({pubkey:di,isWritable:!1}),T({pubkey:Yt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(T({pubkey:i[p]})),d.push(T({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(T({pubkey:p}));return new Pt({programId:u,keys:d,data:m})}function Xa(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=E([G("instruction"),A("amount")]),m=[T({pubkey:c}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:a[0]}),T({pubkey:r,isSigner:!0,isWritable:!1}),T({pubkey:n}),T({pubkey:new ae(t.lpVault)}),T({pubkey:i[0]}),T({pubkey:new ae(t.rewardInfos[0].vault)}),T({pubkey:di,isWritable:!1}),T({pubkey:Yt,isWritable:!1}),T({pubkey:i[1]}),T({pubkey:new ae(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new Pt({keys:m,programId:u,data:d})}function bi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=At({programId:u,poolId:c,owner:r,version:3}),m=Buffer.alloc(ft.span);ft.encode({instruction:11,amount:Z(s)},m);let d=[T({pubkey:c}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:l}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n}),T({pubkey:new ae(t.lpVault)}),T({pubkey:i[0]}),T({pubkey:new ae(t.rewardInfos[0].vault)}),T({pubkey:di,isWritable:!1}),T({pubkey:Yt,isWritable:!1})];if(a)for(let p of a)d.push(T({pubkey:p}));return new Pt({programId:u,keys:d,data:m})}function za(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=At({programId:u,poolId:c,owner:r,version:3}),m=Buffer.alloc(ft.span);ft.encode({instruction:10,amount:Z(s)},m);let d=[T({pubkey:c}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:l}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n}),T({pubkey:new ae(t.lpVault)}),T({pubkey:i[0]}),T({pubkey:new ae(t.rewardInfos[0].vault)}),T({pubkey:di,isWritable:!1}),T({pubkey:Yt,isWritable:!1})];if(a)for(let p of a)d.push(T({pubkey:p}));return new Pt({programId:u,keys:d,data:m})}function Qa(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=At({programId:u,poolId:c,owner:r,version:5}),m=Buffer.alloc(ft.span);ft.encode({instruction:11,amount:Z(s)},m);let d=[T({pubkey:c}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:l}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n}),T({pubkey:new ae(t.lpVault)}),T({pubkey:i[0]}),T({pubkey:new ae(t.rewardInfos[0].vault)}),T({pubkey:di,isWritable:!1}),T({pubkey:Yt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(T({pubkey:i[p]})),d.push(T({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(T({pubkey:p}));return new Pt({programId:u,keys:d,data:m})}function Ya(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,u]=[new ae(e.programId),new ae(e.id)],c=At({programId:a,poolId:u,owner:r,version:6}),l=Buffer.alloc(ft.span);ft.encode({instruction:1,amount:Z(s)},l);let m=[T({pubkey:Yt,isWritable:!1}),T({pubkey:Wa.programId,isWritable:!1}),T({pubkey:u}),T({pubkey:new ae(t.authority),isWritable:!1}),T({pubkey:new ae(t.lpVault)}),T({pubkey:c}),T({pubkey:r,isWritable:!1,isSigner:!0}),T({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(T({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(T({pubkey:i[d]}));return new Pt({programId:a,keys:m,data:l})}var gi=class extends Be{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Fe)){let n=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:zr(D(L({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=ei,txVersion:r}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new we(e.lpMint.address),lockInfo:{lockMint:Va,lockVault:va},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=Ke({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(Io.span);u.addInstruction({instructions:[Nm.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:Io.span,programId:a.programId})]});let{publicKey:d,nonce:p}=Fa({programId:new we(a.programId),poolId:l.publicKey}),f=li({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),y=[],b=[];for(let I of a.rewardInfos){I.openTime>=I.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",I.openTime.toString()),isNaN(ln[I.rewardType])&&this.logAndCreateError("rewardType error",I.rewardType),Number(I.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",I.perSecond),y.push(Da(I));let{rewardPubKey:h,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:I,payer:c});S&&u.addInstruction(S),h||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let B=I.mint.equals(Fe)?new we(ze.address):I.mint;b.push({rewardMint:B,rewardVault:li({programId:a.programId,poolId:l.publicKey,mint:B,type:"rewardVault"}),userRewardToken:h})}let{account:g,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({mint:new we(a.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});P&&u.addInstruction(P),g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:w,instructionType:k}=Ua({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:d,lpVault:f,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:y,nonce:p});return u.addInstruction({instructions:[w],instructionTypes:[k]}).versionBuild({txVersion:r,extInfo:{farmId:l.publicKey,farmAuthority:d,lpVault:f,lockUserAccount:g,nonce:p}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i}){var b;let r=wt[e.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let s=Qe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(Fe)?new we(ze.address):n.mint,l=a.rewardInfos.findIndex(g=>new we(g.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let d=(b=m.vault)!=null?b:Fe,p=this.createTxBuilder(),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return y&&p.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),p.addInstruction({instructions:[Qr({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:f,farmKeys:a,rewardInfo:n})],instructionTypes:[v.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i}){var l;let r=wt[e.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let s=Qe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let d=m.mint.equals(Fe)?new we(ze.address):m.mint,p=a.rewardInfos.findIndex(w=>new we(w.mint.address).equals(d)),f=s.rewardInfos[p];f||this.logAndCreateError("configuration does not exist","rewardMint",d);let y=(l=f.vault)!=null?l:Fe,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&c.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let P=Qr({payer:this.scope.ownerPubKey,rewardVault:y,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[P],instructionTypes:[v.FarmV6Restart]})}return c.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:r}=e,s=wt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Qe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,c=this.createTxBuilder(),l=i.mint.equals(Fe)?new we(ze.address):i.mint,m=li({programId:new we(n.programId),poolId:new we(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return p&&c.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=l,c.addInstruction({instructions:[Yr({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:m,rewardInfo:i})],instructionTypes:[v.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:r}=e,s=wt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Qe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of i){let m=l.mint.equals(Fe)?new we(ze.address):l.mint,d=li({programId:new we(n.programId),poolId:new we(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:l,payer:u});f&&c.addInstruction(f),p||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=Yr({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:d,rewardInfo:D(L({},l),{mint:m})});c.addInstruction({instructions:[y],instructionTypes:[v.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:d}=n,p=wt[d];p===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Gr(p)||this.logAndCreateError("invalid farm program:",n.programId);let[f,y]=[new we(n.programId),new we(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=At({programId:f,poolId:y,owner:this.scope.ownerPubKey,version:p}),P=this.createTxBuilder();P.addCustomComputeBudget(l);let w={};for(let O of this.scope.account.tokenAccounts)if(a){let X=ce(this.scope.ownerPubKey,O.mint,O.programId).publicKey;O.publicKey&&X.equals(O.publicKey)&&(w[O.mint.toString()]=O.publicKey)}else w[O.mint.toString()]=O.publicKey;let k=b.lpMint,I=w[k.address];I||this.logAndCreateError("you don't have any lp","lp zero",w);let h=[];for(let O of m){let X=s&&O.mint.address===H.toString(),q=w[O.mint.address];if(!q){let{account:W,instructionParams:Se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:O.mint.programId,mint:new we(O.mint.address),notUseTokenAccount:X,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!X,associatedOnly:X?!1:a,checkCreateATAOwner:u});q=W,Se&&P.addInstruction(Se)}w[O.mint.address]=q,h.push(q)}let S,B=await this.scope.connection.getAccountInfo(g);if(B&&(S=mi(p).decode(B.data)),n.programId!==ei.toString()&&!S){let{instruction:O,instructionType:X}=pi({id:y,programId:f,version:p,ledger:g,owner:this.scope.ownerPubKey});P.addInstruction({instructions:[O],instructionTypes:[X]})}let C=Xr({version:p,rewardInfos:m,rewardTokenAccountsPublicKeys:h});C&&this.logAndCreateError(C);let x={amount:Z(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:I,rewardAccounts:h,userAuxiliaryLedgers:c==null?void 0:c.map(O=>new we(O))},R=p===6?Ya(x):p===5?Qa(x):za(x),F={3:v.FarmV3Deposit,5:v.FarmV5Deposit,6:v.FarmV6Deposit};return P.addInstruction({instructions:[R],instructionTypes:[F[p]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let p=wt[n.programId];Gr(p)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],y=this.createTxBuilder();y.addCustomComputeBudget(m);let b={};for(let C of this.scope.account.tokenAccounts)if(u){let x=ce(this.scope.ownerPubKey,C.mint).publicKey;C.publicKey&&x.equals(C.publicKey)&&(b[C.mint.toString()]=C.publicKey)}else b[C.mint.toString()]=C.publicKey;if(!r&&p!==4){let C=At({programId:new we(n.programId),poolId:new we(n.id),owner:this.scope.ownerPubKey,version:p}),x=await this.scope.connection.getAccountInfo(C);if(x)mi(p).decode(x.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(p!==6&&(l||[]).length>0){let{instruction:R,instructionType:F}=pi({id:new we(f.id),programId:new we(f.programId),version:p,ledger:C,owner:this.scope.ownerPubKey});y.addInstruction({instructions:[R],instructionTypes:[F]})}else this.logAndCreateError("no lp data",{farmId:n.id,version:p,ledgerData:x})}else r&&r.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});let g=f.lpMint.address,P=s&&g===H.toString(),w=b[g.toString()];if(!w){let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new we(g),notUseTokenAccount:P,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:P?!1:u,checkCreateATAOwner:c});w=C,x&&y.addInstruction(x)}b[g.toString()]=w;let k=[];for(let C of d){let x=s&&C.mint.address===H.toString(),R=b[C.mint.address];if(!R){let{account:F,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:C.mint.programId,mint:new we(C.mint.address),notUseTokenAccount:x,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!x,associatedOnly:x?!1:u,checkCreateATAOwner:c});R=F,O&&y.addInstruction(O)}b[C.mint.address]=R,k.push(R)}let I=Xr({version:p,rewardInfos:d,rewardTokenAccountsPublicKeys:k});I&&this.logAndCreateError(I);let h={amount:Z(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:w,rewardAccounts:k,userAuxiliaryLedgers:l==null?void 0:l.map(C=>new we(C))},S=p===6?fi(h):p===5?yi(h):p===4?Xa(h):bi(h),B={3:v.FarmV3Withdraw,4:v.FarmV4Withdraw,5:v.FarmV5Withdraw,6:v.FarmV6Withdraw};return y.addInstruction({instructions:[S],instructionTypes:[B[p]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var p;this.scope.checkOwner();let i=Qe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),r=wt[e.programId];r!==6&&this.logAndCreateError("invalid farm version",r);let s=e.rewardInfos.findIndex(f=>f.mint.address===Fe.toString()?new we(ze.address):t),a=i.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(p=a==null?void 0:a.vault)!=null?p:Fe,c=this.createTxBuilder(),l;if(t.equals(Fe)){let f=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:zr(D(L({},a),{openTime:a.openTime,endTime:a.endTime,perSecond:new M(a.perSecond).mul(10**a.mint.decimals).toString()}))});l=f.addresses.newAccount,c.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:t});f===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[_m(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[v.CreateATA]})):l=f}let{instruction:m,instructionType:d}=Ga({programId:i.programId,id:i.id,authority:i.authority,lpVault:i.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[d]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder(),m={};for(let f of this.scope.account.tokenAccounts)if(r){let y=ce(this.scope.ownerPubKey,f.mint).publicKey;f.publicKey&&y.equals(f.publicKey)&&(m[f.mint.toString()]=f.publicKey)}else m[f.mint.toString()]=f.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(f=>f.id).join(",")})).reduce((f,y)=>D(L({},f),{[y.id]:y}),{});for(let f of Object.values(t)){let{programId:y,lpMint:b,rewardInfos:g,id:P}=f,w=wt[y],k=b.address,I=n&&k===H.toString(),h=m[k];if(!h){let{account:F,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new we(k),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:r,checkCreateATAOwner:s});h=F,O&&l.addInstruction(O)}m[k.toString()]=h;let S=[];for(let F of g){let O=n&&F.mint.address===H.toString(),X=m[F.mint.address];if(!X){let{account:q,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:F.mint.programId,mint:new we(F.mint.address),notUseTokenAccount:O,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!O,associatedOnly:O?!1:r,checkCreateATAOwner:s});X=q,W&&l.addInstruction(W)}m[F.mint.address]=X,S.push(X)}let B=p[P],C={amount:ct,owner:this.scope.ownerPubKey,farmInfo:f,farmKeys:B,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(F=>new we(F))},x=w===6?fi(C):w===5?yi(C):bi(C),R={3:v.FarmV3Withdraw,5:v.FarmV5Withdraw,6:v.FarmV6Withdraw};l.addInstruction({instructions:[x],instructionTypes:[R[w]]})}return u===1?l.sizeCheckBuild({computeBudgetConfig:c}):l.sizeCheckBuildV0({computeBudgetConfig:c})}};import{PublicKey as Ve}from"@solana/web3.js";import{AccountLayout as hd,NATIVE_MINT as Eo,TOKEN_PROGRAM_ID as dn}from"@solana/spl-token";import{Keypair as Ro,PublicKey as U,SystemProgram as Tn,TransactionInstruction as it}from"@solana/web3.js";import fu from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as is,TOKEN_2022_PROGRAM_ID as Dt,TOKEN_PROGRAM_ID as he}from"@solana/spl-token";import Xm from"bn.js";import kt from"bn.js";var Ce=new kt(0),yt=new kt(1),jt=new kt(-1),bt=new kt(1).shln(64),Bo=new kt(1).shln(128),jr=bt.sub(yt),wi=64,ja=Bo.subn(1),$e=-443636,tt=-$e,ht=new kt("4295048016"),Tt=new kt("79226673521066979257578248091"),xo=new kt("4295048017"),So=new kt("79226673521066979257578248090"),Ha=16,Za="59543866431248",$a="184467440737095516",Ja="15793534762490258745",Ko=new kt(10).pow(new kt(6));var eu={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},lP=new kt("18446744073700000000");import se from"bn.js";function Co(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function Hr(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function Zr(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function Ai(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function tu(o,e){return Ai(o,e)?null:Hr(o,e)}function nu(o,e){return Ai(o,e)?null:Zr(o,e)}var bP=Buffer.from("amm_config","utf8"),Vm=Buffer.from("pool","utf8"),vm=Buffer.from("pool_vault","utf8"),Em=Buffer.from("pool_reward_vault","utf8"),iu=Buffer.from("position","utf8"),Fm=Buffer.from("tick_array","utf8"),Dm=Buffer.from("operation","utf8"),Wm=Buffer.from("pool_tick_array_bitmap_extension","utf8"),qm=Buffer.from("observation","utf8");function ou(o,e,t,n){return le([Vm,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function $r(o,e,t){return le([vm,e.toBuffer(),t.toBuffer()],o)}function ru(o,e,t){return le([Em,e.toBuffer(),t.toBuffer()],o)}function me(o,e,t){return le([Fm,e.toBuffer(),Co(t)],o)}function Ot(o,e,t,n){return le([iu,e.toBuffer(),Co(t),Co(n)],o)}function nt(o,e){return le([iu,e.toBuffer()],o)}function wn(o){return le([Buffer.from("metadata","utf8"),Ut.toBuffer(),o.toBuffer()],Ut)}function Pi(o){return le([Dm],o)}function je(o,e){return le([Wm,e.toBuffer()],o)}function su(o,e){return le([qm,e.toBuffer()],o)}var au=Buffer.from("locked_position","utf8");function Jr(o,e){return le([au,e.toBuffer()],o)}function ki(o,e){return le([au,e.toBuffer()],o)}import{PublicKey as Mt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as uu}from"@solana/spl-token";import ke from"bn.js";import Ft from"bn.js";var hi=class{static getfeeGrowthInside(e,t,n){let i=new Ft(0),r=new Ft(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Ft(0),a=new Ft(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=ie.wrappingSubU128(ie.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),c=ie.wrappingSubU128(ie.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ie.mulDivFloor(ie.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,bt),u=t.tokenFeesOwedA.add(a),c=ie.mulDivFloor(ie.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,bt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ie.mulDivFloor(ie.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,bt),u=t.tokenFeesOwedA.add(a),c=ie.mulDivFloor(ie.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,bt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ie.wrappingSubU128(u,c.growthInsideLastX64),m=ie.mulDivFloor(l,t.liquidity,bt),d=c.rewardAmountOwed.add(m);r.push(d)}return r}static GetPositionRewards(e,t,n,i){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ie.wrappingSubU128(u,c.growthInsideLastX64),m=ie.mulDivFloor(l,t.liquidity,bt),d=c.rewardAmountOwed.add(m);r.push(d)}return r}static getRewardGrowthInside(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Ft(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ft(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ie.wrappingSubU128(ie.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return r}static getRewardGrowthInsideV2(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Ft(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ft(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ie.wrappingSubU128(ie.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:r,epochInfo:s}){var b,g,P,w;let a=ne.priceToSqrtPriceX64(new M(e.price),e.mintA.decimals,e.mintB.decimals),u=ne.getSqrtPriceX64FromTick(t.tickLower),c=ne.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+i:1-i,m=pe.getAmountsFromLiquidity(a,u,c,n,r),[d,p]=[ge(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),ge(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[f,y]=[ge(new Ft(new M(m.amountA.toString()).mul(l).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,s,!0),ge(new Ft(new M(m.amountB.toString()).mul(l).toFixed(0)),(w=e.mintB.extensions)==null?void 0:w.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:Rt(d.expirationTime,p.expirationTime)}}};var Um=15,de=class{static async getTickArrays(e,t,n,i,r,s,a){let u=[],c=Y.getTickArrayStartIndexByTick(i,r),l=Y.getInitializedTickArrayInRange(s,a,r,c,Math.floor(Um/2));for(let p=0;p<l.length;p++){let{publicKey:f}=me(t,n,l[p]);u.push(f)}let m=(await Bt(e,u)).map(p=>p!==null?Ti.decode(p.data):null),d={};for(let p=0;p<u.length;p++){let f=m[p];f!==null&&(d[f.startTickIndex]=D(L({},f),{address:u[p]}))}return d}static nextInitializedTick(e,t,n,i,r,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,i,r,s);for(;a==null||a.liquidityGross.lten(0);){if(c=Y.getNextTickArrayStartIndex(c,r,s),this.checkIsValidStartIndex(c,r))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,i,r){let s=Math.floor(e/de.tickCount(t)),a=n?Y.searchLowBitFromStart(i,r,s-1,1,t):Y.searchHightBitFromStart(i,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let r;if(i){let a=We-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){r=u;break}a=a-1}}else{let a=0;for(;a<We;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){r=u;break}a=a+1}}let{publicKey:s}=me(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,r,s){let a=Y.getTickArrayStartIndexByTick(i,r),u=Math.floor((i-a)/r),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<We;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=me(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Y.checkIsOutOfBoundary(e)){if(e>tt)return!1;let n=Y.getTickArrayStartIndexByTick($e,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return We*e}};var es=14,Ht=class{static maxTickInTickarrayBitmap(e){return e*We*An}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let r=n*i;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!de.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=i?t-de.tickCount(n):t+de.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*We,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(i){let l=e.shln(1024-c-1),m=tu(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(c),m=nu(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:r-de.tickCount(n)}}}},Ii=class{static getBitmapOffset(e,t){if(!de.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Ht.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Ht.maxTickInTickarrayBitmap(e),n=-t;if(tt<=t)throw Error(`extensionTickBoundary check error: ${tt}, ${t}`);if(n<=$e)throw Error(`extensionTickBoundary check error: ${n}, ${$e}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Y.mergeTickArrayBitmap(i).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let r=de.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:r,maxValue:s}=Ht.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let u=Y.mergeTickArrayBitmap(e).shln(An-1-a),c=Ai(512,u)?null:Hr(512,u);if(c!==null){let l=t-c*de.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let u=Y.mergeTickArrayBitmap(e).shrn(a),c=Ai(512,u)?null:Zr(512,u);if(c!==null){let l=t+c*de.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-de.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Ht.maxTickInTickarrayBitmap(t),i=Math.floor(n/de.tickCount(t));return e<0&&n!=0&&(i=An-i),i}};var Re=class{static getOutputAmountAndRemainAccounts(e,t,n,i,r,s=!1){let a=n.toBase58()===e.mintA.address,u=[],{isExist:c,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!c||l===void 0||!m)throw new Error("Invalid tick array");u.push(m);let{allTrade:d,amountCalculated:p,accounts:f,sqrtPriceX64:y,feeAmount:b}=Pn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,r,s);return u.push(...f),{allTrade:d,expectedAmountOut:p.mul(jt),remainingAccounts:u,executionPrice:y,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let y=this.preInitializedTickArrayStartIndex(e,s);if(y.isExist){let{publicKey:b}=me(e.programId,e.id,y.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:f}=Pn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(jt),c,r);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Re.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Ii.checkTickArrayIsInit(de.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Y.checkTickArrayIsInitialized(Y.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=me(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,de.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=me(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/de.tickCount(e.tickSpacing)),i=t?Y.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Y.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=de.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:r}=Ht.nextInitializedTickArrayStartIndex(Y.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=Ii.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<$e||t>tt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:r}){var a,u,c;let s=[];for(let l=0;l<r.length;l++){let m=r[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let p=D(L({},m),{perSecond:ie.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Mt(d)});if(p.tokenMint.equals(Mt.default))continue;if(n<=p.openTime.toNumber()||i.eq(Ce)){s.push(p);continue}let f=new ke(Math.min(p.endTime.toNumber(),n)),y=f.sub(p.lastUpdateTime),b=ie.mulDivFloor(y,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(b),P=ie.mulDivFloor(y,p.emissionsPerSecondX64,bt),w=p.rewardTotalEmissioned.add(P);s.push(D(L({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:w,lastUpdateTime:f}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let r of t){let s=Y.getTickArrayStartIndexByTick(r,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Ht.maxTickInTickarrayBitmap(e),n=-t;return t>tt&&(t=de.getArrayStartIndex(tt,e)+de.tickCount(e)),n<$e&&(n=de.getArrayStartIndex($e,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!de.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/de.tickCount(t)*An}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await qe(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of i)s.accountInfo!==null&&(r[s.pubkey.toString()]=lu.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},r=[];for(let u of t){let c=Y.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=Y.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=me(u.programId,u.id,m);r.push({pubkey:d}),i[d.toString()]=u.id}}let s=await qe(e,r,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=i[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=Ti.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]=D(L({},l),{address:u.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:r=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let p of s)c.push(nt(p,d).publicKey);let l=await Bt(t,c,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=Bi.decode(d.data),f=p.poolId.toString(),y=e.find(B=>B.state.id.toBase58()===f);if(y===void 0)continue;let b=y.state,g=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),P=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=pe.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,P.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(P.price).toNumber())));y.positionAccount=[...(a=y.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:P.price,amountA:w,amountB:k,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(B=>D(L({},B),{pendingReward:new ke(0)})),leverage:I,tokenFeeAmountA:new ke(0),tokenFeeAmountB:new ke(0)}];let h=await Y.getTickArrayAddressByTick(y.state.programId,p.poolId,p.tickLower,y.state.tickSpacing),S=await Y.getTickArrayAddressByTick(y.state.programId,p.poolId,p.tickUpper,y.state.tickSpacing);m[`${y.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=h,m[`${y.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(r){let d=Object.values(m),p=await Bt(t,d,{batchRequest:i}),f={};for(let y=0;y<d.length;y++){let b=p[y];if(b===null)continue;let g=d[y].toString();f[g]=Ti.decode(b.data)}for(let{state:y,positionAccount:b}of e)if(!!b)for(let g of b){let P=`${y.programId.toString()}-${y.id.toString()}-${g.tickLower}`,w=`${y.programId.toString()}-${y.id.toString()}-${g.tickUpper}`,k=f[m[P].toString()],I=f[m[w].toString()],h=k.ticks[Y.getTickOffsetInArray(g.tickLower,y.tickSpacing)],S=I.ticks[Y.getTickOffsetInArray(g.tickUpper,y.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:C}=await hi.GetPositionFees(y,g,h,S),x=await hi.GetPositionRewards(y,g,h,S);g.tokenFeeAmountA=B.gte(new ke(0))?B:new ke(0),g.tokenFeeAmountB=C.gte(new ke(0))?C:new ke(0);for(let R=0;R<x.length;R++)g.rewardInfos[R].pendingReward=x[R].gte(new ke(0))?x[R]:new ke(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:r,slippage:s,priceLimit:a=new M(0),catchLiquidityInsufficient:u=!1}){var F;let c,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new M(0))?c=l?ht.add(new ke(1)):Tt.sub(new ke(1)):c=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=ge(r,m,i,!1),{allTrade:f,expectedAmountOut:y,remainingAccounts:b,executionPrice:g,feeAmount:P}=Re.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((F=p.fee)!=null?F:Ce),c,u),w=ge(y,d,i,!1),k=ne.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?k:new M(1).div(k),h=y.mul(new ke(Math.floor((1-s)*1e10))).div(new ke(1e10)),S=ge(h,d,i,!1),B=l?e.currentPrice:new M(1).div(e.currentPrice),C=new M(I).sub(B).abs(),x=B,R=new Ue(new M(C).mul(10**15).toFixed(0),new M(x).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:p,amountOut:w,minAmountOut:S,expirationTime:Rt(p.expirationTime,w.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:R,fee:P,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let u=i.address===e.mintB.address,[c,l]=u?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ie(D(L({},c),{mint:c.address,isToken2022:c.programId===uu.toBase58()})),new Ie(D(L({},l),{mint:l.address,isToken2022:l.programId===uu.toBase58()}))],{allTrade:p,realAmountIn:f,amountOut:y,minAmountOut:b,expirationTime:g,currentPrice:P,executionPrice:w,priceImpact:k,fee:I,remainingAccounts:h,executionPriceX64:S}=Re.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Mt(c.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),B=D(L({},f),{amount:new be(m,f.amount),fee:f.fee===void 0?void 0:new be(m,f.fee)}),C=D(L({},y),{amount:new be(d,y.amount),fee:y.fee===void 0?void 0:new be(d,y.fee)}),x=D(L({},b),{amount:new be(d,b.amount),fee:b.fee===void 0?void 0:new be(d,b.fee)}),R=new ut({baseToken:m,denominator:new ke(10).pow(new ke(20+m.decimals)),quoteToken:d,numerator:P.mul(new M(10**(20+d.decimals))).toFixed(0)}),F=new ut({baseToken:m,denominator:new ke(10).pow(new ke(20+m.decimals)),quoteToken:d,numerator:w.mul(new M(10**(20+d.decimals))).toFixed(0)}),O=new be(m,I);return{allTrade:p,realAmountIn:B,amountOut:C,minAmountOut:x,expirationTime:g,currentPrice:R,executionPrice:F,priceImpact:k,fee:O,remainingAccounts:h,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:r,slippage:s,priceLimit:a=new M(0)}){var x;let u=n.toBase58()===e.mintA.address,c={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new M(0))?l=u?Tt.sub(new ke(1)):ht.add(new ke(1)):l=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=ge(r,c[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:f,feeAmount:y}=Re.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((x=m.fee)!=null?x:Ce),l),b=u?e.mintB.address:e.mintA.address,g=ge(d,c[b],i,!1),P=ne.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),w=u?P:new M(1).div(P),k=d.mul(new ke(Math.floor((1+s)*1e10))).div(new ke(1e10)),I=ge(k,c[b],i,!0),h=u?e.currentPrice:new M(1).div(e.currentPrice),S=new M(w).sub(h).abs(),B=h,C=new Ue(new M(S).mul(10**15).toFixed(0),new M(B).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:Rt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:w,priceImpact:C,fee:y,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var f,y,b;let r=e[t],s=Y.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Y.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-u,m=a-s,d=r.priceMax-r.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:r.feeApr*p,rewardsApr:[((f=r.rewardApr[0])!=null?f:0)*p,((y=r.rewardApr[1])!=null?y:0)*p,((b=r.rewardApr[2])!=null?b:0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[dt(e.mintA.address).toString()],d=i[dt(e.mintB.address).toString()],p=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let y=ne.priceToSqrtPriceX64(new M(e.price),e.mintA.decimals,e.mintB.decimals),b=ne.getSqrtPriceX64FromTick(s),g=ne.getSqrtPriceX64FromTick(a),{amountSlippageA:P,amountSlippageB:w}=pe.getAmountsFromLiquidityWithSlippage(y,b,g,t,!1,!1,0),{amountSlippageA:k,amountSlippageB:I}=pe.getAmountsFromLiquidityWithSlippage(y,b,g,r,!1,!1,0),h=new M(P.toString()).div(new M(10).pow(p)).mul(m.value).add(new M(w.toString()).div(new M(10).pow(f)).mul(d.value)),S=new M(k.toString()).div(new M(10).pow(p)).mul(m.value).add(new M(I.toString()).div(new M(10).pow(f)).mul(d.value)),B=new M(1).div(h.add(S)),x=new M(l.volumeFee).mul(365).div(c).mul(B).mul(100).toNumber(),R=3600*24*365,F=e.rewardDefaultInfos.map(O=>{var W,Se;let X=O.mint.decimals,q=i[O.mint.address];return u<((W=O.startTime)!=null?W:0)||u>((Se=O.endTime)!=null?Se:0)||!O.perSecond||!q||X===void 0?0:new M(q.value).mul(new M(O.perSecond).mul(R)).div(new M(10).pow(X)).mul(B).mul(100).toNumber()});return{feeApr:x,rewardsApr:F,apr:x+F.reduce((O,X)=>O+X,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:r,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var g,P;let l=ne.priceToSqrtPriceX64(new M(e.price),e.mintA.decimals,e.mintB.decimals),m=ne.getSqrtPriceX64FromTick(n),d=ne.getSqrtPriceX64FromTick(i),p=a?1-s:1+s,f=ge(r,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!c),y=new ke(new M(f.amount.sub((P=f.fee)!=null?P:Ce).toString()).mul(p).toFixed(0)),b;if(l.lte(m))b=t?pe.getLiquidityFromTokenAmountA(m,d,y,!a):new ke(0);else if(l.lte(d)){let w=pe.getLiquidityFromTokenAmountA(l,d,y,!a),k=pe.getLiquidityFromTokenAmountB(m,l,y);b=t?w:k}else b=t?new ke(0):pe.getLiquidityFromTokenAmountB(m,d,y);return Re.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:r,slippage:s,add:a}){var b,g,P,w;let u=ne.getSqrtPriceX64FromTick(n),c=ne.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=pe.getAmountsFromLiquidity(ne.priceToSqrtPriceX64(new M(t.price),t.mintA.decimals,t.mintB.decimals),u,c,r,a),[d,p]=[ge(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),ge(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[f,y]=[ge(m.amountA.muln(l),(P=t.mintA.extensions)==null?void 0:P.feeConfig,e,!0),ge(m.amountB.muln(l),(w=t.mintB.extensions)==null?void 0:w.feeConfig,e,!0)];return{liquidity:r,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:Rt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(u=>!n[u.id]).map(u=>new Mt(u.id));(await Bt(e,i)).forEach((u,c)=>{!u||(n[i[c].toBase58()]=kn.decode(u.data))});let s=t.map(u=>je(new Mt(u.programId),new Mt(u.id)).publicKey),a=await Re.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((u,c)=>D(L({},u),{[c.id]:D(L({},n[c.id]),{id:new Mt(c.id),version:6,programId:new Mt(c.programId),mintA:c.mintA,mintB:c.mintB,ammConfig:D(L({},c.config),{id:new Mt(c.config.id),fundOwner:""}),currentPrice:new M(c.price),exBitmapInfo:a[je(new Mt(c.programId),new Mt(c.id)).publicKey.toBase58()],startTime:n[c.id].startTime.toNumber(),rewardInfos:n[c.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var ts={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function cu(o){return D(L({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:ts,week:ts,month:ts,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:D(L({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ie=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),r=i.div(n);return i.mod(n).eq(Ce)||(r=r.add(yt)),r}static mulDivFloor(e,t,n){if(n.eq(Ce))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Ce))throw new Error("division by 0");return e.mul(t).add(n.sub(yt)).div(n)}static x64ToDecimal(e,t){return new M(e.toString()).div(M.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new se(e.mul(M.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Bo).sub(t).mod(Bo)}};function Ge(o,e){return ns(o.mul(e),64,256)}function Gm(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function ns(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ne=class{static sqrtPriceX64ToPrice(e,t,n){return ie.x64ToDecimal(e).pow(2).mul(M.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ie.decimalToX64(e.mul(M.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(Ce))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Ce))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(Ce))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Ce))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(Ce))return e;let r=t.shln(wi);if(i){let s=r,a=r.add(n.mul(e));return a.gte(s)?ie.mulDivCeil(s,e,a):ie.mulDivRoundingUp(s,yt,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ie.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let r=n.shln(wi);if(i)return e.add(r.div(t));{let s=ie.mulDivRoundingUp(r,yt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<$e||e>tt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new se("18445821805675395072"):new se("18446744073709551616");return(t&2)!=0&&(n=Ge(n,new se("18444899583751176192"))),(t&4)!=0&&(n=Ge(n,new se("18443055278223355904"))),(t&8)!=0&&(n=Ge(n,new se("18439367220385607680"))),(t&16)!=0&&(n=Ge(n,new se("18431993317065453568"))),(t&32)!=0&&(n=Ge(n,new se("18417254355718170624"))),(t&64)!=0&&(n=Ge(n,new se("18387811781193609216"))),(t&128)!=0&&(n=Ge(n,new se("18329067761203558400"))),(t&256)!=0&&(n=Ge(n,new se("18212142134806163456"))),(t&512)!=0&&(n=Ge(n,new se("17980523815641700352"))),(t&1024)!=0&&(n=Ge(n,new se("17526086738831433728"))),(t&2048)!=0&&(n=Ge(n,new se("16651378430235570176"))),(t&4096)!=0&&(n=Ge(n,new se("15030750278694412288"))),(t&8192)!=0&&(n=Ge(n,new se("12247334978884435968"))),(t&16384)!=0&&(n=Ge(n,new se("8131365268886854656"))),(t&32768)!=0&&(n=Ge(n,new se("3584323654725218816"))),(t&65536)!=0&&(n=Ge(n,new se("696457651848324352"))),(t&131072)!=0&&(n=Ge(n,new se("26294789957507116"))),(t&262144)!=0&&(n=Ge(n,new se("37481735321082"))),e>0&&(n=ja.div(n)),n}static getTickFromPrice(e,t,n){return ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Tt)||e.lt(ht))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new se(t-64),i=Gm(n,32,128),r=new se("8000000000000000","hex"),s=0,a=new se(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new se(0))&&s<Ha;){u=u.mul(u);let f=u.shrn(127);u=u.shrn(63+f.toNumber()),a=a.add(r.mul(f)),r=r.shrn(1),s+=1}let c=a.shrn(32),m=i.add(c).mul(new se(Za)),d=ns(m.sub(new se($a)),64,128).toNumber(),p=ns(m.add(new se(Ja)),64,128).toNumber();return d==p?d:ne.getSqrtPriceX64FromTick(p).lte(e)?p:d}},hn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let r=hn.getTickWithPriceAndTickspacing(e,t,n,i),s=ne.getSqrtPriceX64FromTick(r);return ne.sqrtPriceX64ToPrice(s,n,i)}},pe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Ce))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(wi),s=t.sub(e);return i?ie.mulDivRoundingUp(ie.mulDivCeil(r,s,t),yt,e):ie.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Ce))throw new Error("sqrtPriceX64A must greater than 0");return i?ie.mulDivCeil(n,t.sub(e),bt):ie.mulDivFloor(n,t.sub(e),bt)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return i?ie.mulDivRoundingUp(a,yt,jr):a.shrn(wi)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ie.mulDivFloor(n,jr,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return pe.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=pe.getLiquidityFromTokenAmountA(e,n,i,!1),a=pe.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return pe.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:pe.getTokenAmountAFromLiquidity(t,n,i,r),amountB:new se(0)};if(e.lt(n)){let s=pe.getTokenAmountAFromLiquidity(e,n,i,r),a=pe.getTokenAmountBFromLiquidity(t,e,i,r);return{amountA:s,amountB:a}}else return{amountA:new se(0),amountB:pe.getTokenAmountBFromLiquidity(t,n,i,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,r,s,a){let{amountA:u,amountB:c}=pe.getAmountsFromLiquidity(e,t,n,i,s),l=r?1+a:1-a,m=new se(new M(u.toString()).mul(l).toFixed(0)),d=new se(new M(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:r,add:s,epochInfo:a,amountAddFee:u}){var P,w,k,I;let c=ne.priceToSqrtPriceX64(new M(e.price),e.mintA.decimals,e.mintB.decimals),l=ne.getSqrtPriceX64FromTick(t),m=ne.getSqrtPriceX64FromTick(n),d=s?1+r:1-r,p=pe.getAmountsFromLiquidity(c,l,m,i,s),[f,y]=[ge(p.amountA,(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,u),ge(p.amountB,(w=e.mintB.extensions)==null?void 0:w.feeConfig,a,u)],[b,g]=[ge(new se(new M(p.amountA.toString()).mul(d).toFixed(0)),(k=e.mintA.extensions)==null?void 0:k.feeConfig,a,u),ge(new se(new M(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,u)];return{liquidity:i,amountA:f,amountB:y,amountSlippageA:b,amountSlippageB:g,expirationTime:Rt(f.expirationTime,y.expirationTime)}}},Pn=class{static swapCompute(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y=!1){if(d.eq(Ce))throw new Error("amountSpecified must not be 0");if(f||(f=s?ht.add(yt):Tt.sub(yt)),s){if(f.lt(ht))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(Tt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(Ce),g={amountSpecifiedRemaining:d,amountCalculated:Ce,sqrtPriceX64:m,tick:c>p?Math.min(p+de.tickCount(l)-1,c):p,accounts:[],liquidity:u,feeAmount:new se(0)},P=p,w=n[p],k=0,I=!s&&w.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(Ce)&&!g.sqrtPriceX64.eq(f);){k>10;let h={};h.sqrtPriceStartX64=g.sqrtPriceX64;let S=Y.nextInitTick(w,g.tick,l,s,I),B=S||null,C=null;if(!(B!=null&&B.liquidityGross.gtn(0))){let R=Re.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:r},P,s);if(!R.isExist){if(y)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}P=R.nextStartIndex;let{publicKey:F}=me(e,t,P);C=F,w=n[P];try{B=Y.firstInitializedTick(w,s)}catch{throw Error("not found next tick info")}}h.tickNext=B.tick,h.initialized=B.liquidityGross.gtn(0),p!==P&&C&&(g.accounts.push(C),p=P),h.tickNext<$e?h.tickNext=$e:h.tickNext>tt&&(h.tickNext=tt),h.sqrtPriceNextX64=ne.getSqrtPriceX64FromTick(h.tickNext);let x;if(s&&h.sqrtPriceNextX64.lt(f)||!s&&h.sqrtPriceNextX64.gt(f)?x=f:x=h.sqrtPriceNextX64,[g.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=Pn.swapStepCompute(g.sqrtPriceX64,x,g.liquidity,g.amountSpecifiedRemaining,a),g.feeAmount=g.feeAmount.add(h.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),g.amountCalculated=g.amountCalculated.sub(h.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(h.amountOut),g.amountCalculated=g.amountCalculated.add(h.amountIn.add(h.feeAmount))),g.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let R=B.liquidityNet;s&&(R=R.mul(jt)),g.liquidity=pe.addDelta(g.liquidity,R)}I=h.tickNext!=g.tick&&!s&&w.startTickIndex===h.tickNext,g.tick=s?h.tickNext-1:h.tickNext}else if(g.sqrtPriceX64!=h.sqrtPriceStartX64){let R=ne.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=R!=g.tick&&!s&&w.startTickIndex===R,g.tick=R}++k}try{let{nextStartIndex:h,isExist:S}=de.nextInitializedTickArray(g.tick,l,s,i,r);S&&p!==h&&(g.accounts.push(me(e,t,h).publicKey),p=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:Ce,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,r){let s={sqrtPriceX64Next:new se(0),amountIn:new se(0),amountOut:new se(0),feeAmount:new se(0)},a=e.gte(t),u=i.gte(Ce);if(u){let l=ie.mulDivFloor(i,Ko.sub(new se(r.toString())),Ko);s.amountIn=a?pe.getTokenAmountAFromLiquidity(t,e,n,!0):pe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?pe.getTokenAmountBFromLiquidity(t,e,n,!1):pe.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(jt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromOutput(e,n,i.mul(jt),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=pe.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=pe.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:pe.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:pe.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(i.mul(jt))&&(s.amountOut=i.mul(jt)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=ie.mulDivCeil(s.amountIn,new se(r),Ko.sub(new se(r))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var We=60,An=512,Y=class{static getTickArrayAddressByTick(e,t,n,i){let r=Y.getTickArrayStartIndexByTick(n,i),{publicKey:s}=me(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Y.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=We)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=de.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*de.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*We,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*We,r=Math.floor(t/i)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*We:e+t*We}static mergeTickArrayBitmap(e){let t=new Xm(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,r){let s=Math.floor(i/(n*We));return[...Y.searchLowBitFromStart(e,t,s-1,r,n),...Y.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Y.searchHightBitFromStart(e,t,0,An,n)}static getAllInitializedTickArrayInfo(e,t,n,i,r){let s=[],a=Y.getAllInitializedTickArrayStartIndex(n,i,r);for(let u of a){let{publicKey:c}=me(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>Y.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===i)break}let u=de.tickCount(r);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>Y.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===i)break}let u=de.tickCount(r);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<$e||e>tt}static nextInitTick(e,t,n,i,r){if(de.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<We;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=We-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<We;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=ne.getSqrtPriceX64FromTick(t),r=ne.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new M(1).div(r),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new M(1).div(t),r=hn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(r),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new M(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=ne.getSqrtPriceX64FromTick(t),r=ne.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new M(1).div(r),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new M(1).div(t),r=hn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(r),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new M(1).div(a)}}};var mu=E([ye(8),G("bump"),Xt("index"),K(""),Ze("protocolFeeRate"),Ze("tradeFeeRate"),Xt("tickSpacing"),j(A(),8,"")]),zm=E([Ze("blockTimestamp"),vn("tickCumulative"),j(A(),4)]),du=E([ye(8),De("initialized"),A("recentEpoch"),Xt("observationIndex"),K("poolId"),j(zm,100,"observations"),j(A(),4)]),Qm=E([G("rewardState"),A("openTime"),A("endTime"),A("lastUpdateTime"),J("emissionsPerSecondX64"),A("rewardTotalEmissioned"),A("rewardClaimed"),K("tokenMint"),K("tokenVault"),K("creator"),J("rewardGrowthGlobalX64")]),kn=E([ye(8),G("bump"),K("ammConfig"),K("creator"),K("mintA"),K("mintB"),K("vaultA"),K("vaultB"),K("observationId"),G("mintDecimalsA"),G("mintDecimalsB"),Xt("tickSpacing"),J("liquidity"),J("sqrtPriceX64"),Ye("tickCurrent"),Ze(),J("feeGrowthGlobalX64A"),J("feeGrowthGlobalX64B"),A("protocolFeesTokenA"),A("protocolFeesTokenB"),J("swapInAmountTokenA"),J("swapOutAmountTokenB"),J("swapInAmountTokenB"),J("swapOutAmountTokenA"),G("status"),j(G(),7,""),j(Qm,3,"rewardInfos"),j(A(),16,"tickArrayBitmap"),A("totalFeesTokenA"),A("totalFeesClaimedTokenA"),A("totalFeesTokenB"),A("totalFeesClaimedTokenB"),A("fundFeesTokenA"),A("fundFeesTokenB"),A("startTime"),j(A(),15*4-3,"padding")]),Ym=E([J("growthInsideLastX64"),A("rewardAmountOwed")]),Bi=E([ye(8),G("bump"),K("nftMint"),K("poolId"),Ye("tickLower"),Ye("tickUpper"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),j(Ym,3,"rewardInfos"),j(A(),8,"")]),Ik=E([ye(8),G("bump"),K("poolId"),Ye("tickLowerIndex"),Ye("tickUpperIndex"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),j(J(),3,"rewardGrowthInside"),j(A(),8,"")]),jm=E([Ye("tick"),Ca("liquidityNet"),J("liquidityGross"),J("feeGrowthOutsideX64A"),J("feeGrowthOutsideX64B"),j(J(),3,"rewardGrowthsOutsideX64"),j(Ze(),13,"")]),Ti=E([ye(8),K("poolId"),Ye("startTickIndex"),j(jm,We,"ticks"),G("initializedTickCount"),j(G(),115,"")]),pu=E([ye(329),j(K(),100,"whitelistMints")]),lu=E([ye(8),K("poolId"),j(j(A(),8),es,"positiveTickArrayBitmap"),j(j(A(),8),es,"negativeTickArrayBitmap")]),Bk=E([A(),G("bump"),K("owner"),K("poolId"),K("positionId"),K("nftAccount"),j(A(),8)]),xk=E([ye(8),G("bump"),K("lockOwner"),K("poolId"),K("positionId"),K("nftAccount"),K("lockNftMint"),A("recentEpoch"),j(A(),8)]);du.span;var yu=ue("Raydium_Clmm"),Nt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},bu=[188,37,179,131,82,150,84,73],gu=[16,72,250,198,14,162,212,19],Ae=class{static createPoolInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f){let y=E([J("sqrtPriceX64"),A("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:pt,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);y.encode({sqrtPriceX64:p,startTime:f},g);let P=Buffer.from([...Nt.createPool,...g]);return new it({keys:b,programId:e,data:P})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:r,ammConfigId:s,initialPriceX64:a,startTime:u}=e,[c,l]=[new U(i.address),new U(r.address)],{publicKey:m}=ou(t,s,c,l),{publicKey:d}=su(t,m),{publicKey:p}=$r(t,m,c),{publicKey:f}=$r(t,m,l),y=[this.createPoolInstruction(t,m,n,s,d,c,p,new U(i.programId||he),l,f,new U(r.programId||he),je(t,m).publicKey,a,u)];return{signers:[],instructions:y,instructionTypes:[v.CreateAccount,v.ClmmCreatePool],address:{poolId:m,observationId:d,mintAVault:p,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P,w,k,I,h,S,B,C,x){let R=E([Ye("tickLowerIndex"),Ye("tickUpperIndex"),Ye("tickArrayLowerStartIndex"),Ye("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),De("withMetadata"),G("optionBaseFlag"),De("baseFlag")]),F=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],O=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:pt,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:is,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...F],X=Buffer.alloc(R.span);R.encode({tickLowerIndex:P,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:h,amountMaxA:S,amountMaxB:B,withMetadata:C==="create",baseFlag:!1,optionBaseFlag:0},X);let q=Buffer.from([...Nt.openPosition,...X]);return new it({keys:O,programId:e,data:q})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let B=Ro.generate();m.push(B),f=B.publicKey}let y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=me(d,p,y),{publicKey:P}=me(d,p,b),{publicKey:w}=ce(n.wallet,f,he),{publicKey:k}=wn(f),{publicKey:I}=nt(d,f),{publicKey:h}=Ot(d,p,i,r),S=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,f,w,k,h,g,P,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,r,y,b,s,a,u,c);return{signers:m,instructions:[S],instructionTypes:[v.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:h}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let B=Ro.generate();m.push(B),f=B.publicKey}let y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=me(d,p,y),{publicKey:P}=me(d,p,b),{publicKey:w}=ce(n.wallet,f,he),{publicKey:k}=wn(f),{publicKey:I}=nt(d,f),{publicKey:h}=Ot(d,p,i,r),S=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,f,w,k,h,g,P,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,r,y,b,c,s,a,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,b])?je(d,p).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:h},instructions:[S],signers:m,instructionTypes:[v.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P,w,k,I,h,S,B,C,x){let R=E([Ye("tickLowerIndex"),Ye("tickUpperIndex"),Ye("tickArrayLowerStartIndex"),Ye("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),De("withMetadata"),G("optionBaseFlag"),De("baseFlag")]),F=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],O=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:pt,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:is,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...F],X=Buffer.alloc(R.span);R.encode({tickLowerIndex:P,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:new fu(0),amountMaxA:S==="MintA"?B:C,amountMaxB:S==="MintA"?C:B,withMetadata:h==="create",baseFlag:S==="MintA",optionBaseFlag:1},X);let q=Buffer.from([...Nt.openPosition,...X]);return new it({keys:O,programId:e,data:q})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,d=[];if(l)m=new U((await l(1))[0]);else{let B=Ro.generate();d.push(B),m=B.publicKey}let[p,f]=[new U(e.programId),new U(e.id)],y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=me(p,f,y),{publicKey:P}=me(p,f,b),{publicKey:w}=ce(n.wallet,m,he),{publicKey:k}=wn(m),{publicKey:I}=nt(p,m),{publicKey:h}=Ot(p,f,i,r),S=this.openPositionFromLiquidityInstruction(p,n.wallet,f,n.wallet,m,w,k,h,g,P,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),i,r,y,b,s,a,u,c,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,b])?je(p,f).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:h},instructions:[S],signers:d,instructionTypes:[v.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,r){let s=E([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...Nt.closePosition,...u]);return new it({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i}){let r=new U(e.programId),{publicKey:s}=ce(n.wallet,i.nftMint,he),{publicKey:a}=nt(r,i.nftMint),u=[];return u.push(this.closePositionInstruction(r,n.wallet,i.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[v.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P){let w=E([J("liquidity"),A("amountMaxA"),A("amountMaxB"),G("optionBaseFlag"),De("baseFlag")]),k=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...k],h=Buffer.alloc(w.span);w.encode({liquidity:y,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},h);let S=Buffer.from([...Nt.increaseLiquidity,...h]);return new it({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMaxA:s,amountMaxB:a}){let[u,c]=[new U(e.programId),new U(e.id)],l=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=me(u,c,l),{publicKey:p}=me(u,c,m),{publicKey:f}=ce(i.wallet,n.nftMint,he),{publicKey:y}=nt(u,n.nftMint),{publicKey:b}=Ot(u,c,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(u,i.wallet,f,y,c,b,d,p,i.tokenAccountA,i.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?je(u,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:f,personalPosition:y,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[v.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:r,baseAmount:s,otherAmountMax:a}){let[u,c]=[new U(e.programId),new U(e.id)],l=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=me(u,c,l),{publicKey:p}=me(u,c,m),{publicKey:f}=ce(i.wallet,n.nftMint,he),{publicKey:y}=nt(u,n.nftMint),{publicKey:b}=Ot(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:f,personalPosition:y,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,f,y,c,b,d,p,i.tokenAccountA,i.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?je(u,c).publicKey:void 0)],signers:[],instructionTypes:[v.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P){let w=E([J("liquidity"),A("amountMaxA"),A("amountMaxB"),G("optionBaseFlag"),De("baseFlag")]),k=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...k],h=Buffer.alloc(w.span);w.encode({liquidity:new fu(0),amountMaxA:y==="MintA"?b:g,amountMaxB:y==="MintA"?g:b,baseFlag:y==="MintA",optionBaseFlag:1},h);let S=Buffer.from([...Nt.increaseLiquidity,...h]);return new it({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P,w){let k=E([J("liquidity"),A("amountMinA"),A("amountMinB")]),I=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...y.map(C=>[{pubkey:C.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.rewardMint,isSigner:!1,isWritable:!1}]).flat()],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Ji,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(k.span);k.encode({liquidity:b,amountMinA:g,amountMinB:P},S);let B=Buffer.from([...Nt.decreaseLiquidity,...S]);return new it({keys:h,programId:e,data:B})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new U(e.programId),new U(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=me(c,l,m),{publicKey:f}=me(c,l,d),{publicKey:y}=ce(i.wallet,n.nftMint,u),{publicKey:b}=nt(c,n.nftMint),{publicKey:g}=Ot(c,l,n.tickLower,n.tickUpper),P=[];for(let I=0;I<e.rewardDefaultInfos.length;I++)P.push({poolRewardVault:new U(t.rewardInfos[I].vault),ownerRewardVault:i.rewardAccounts[I],rewardMint:new U(e.rewardDefaultInfos[I].mint.address)});let w=[],k=this.decreaseLiquidityInstruction(c,i.wallet,y,b,l,g,p,f,i.tokenAccountA,i.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),P,r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?je(c,l).publicKey:void 0);return w.push(k),{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},signers:[],instructions:w,instructionTypes:[v.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g){let P=E([A("amount"),A("otherAmountThreshold"),J("sqrtPriceLimitX64"),De("isBaseInput")]),w=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Ji,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...w],I=Buffer.alloc(P.span);P.encode({amount:p,otherAmountThreshold:f,sqrtPriceLimitX64:y,isBaseInput:b},I);let h=Buffer.from([...Nt.swap,...I]);return new it({keys:k,programId:e,data:h})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[f,y]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toString(),g=[this.swapInstruction(l,i.wallet,m,new U(e.config.id),b?i.tokenAccountA:i.tokenAccountB,b?i.tokenAccountB:i.tokenAccountA,b?d:p,b?p:d,b?f:y,b?y:f,c,n,s,a,u,!0,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[v.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[f,y]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new U(e.config.id),b?i.tokenAccountB:i.tokenAccountA,b?i.tokenAccountA:i.tokenAccountB,b?p:d,b?d:p,b?y:f,b?f:y,c,n,s,a,u,!1,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[v.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,r,s,a,u,c,l,m,d){let p=E([A("openTime"),A("endTime"),J("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:pt,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({openTime:Z(l),endTime:Z(m),emissionsPerSecondX64:d},y);let b=Buffer.from([...Nt.initReward,...y]);return new it({keys:f,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new U(e.programId),new U(e.id)],a=ru(r,s,i.mint).publicKey,u=Pi(r).publicKey,c=[this.initRewardInstruction(r,n.wallet,s,u,new U(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[v.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,r,s,a,u,c,l,m,d){let p=E([G("rewardIndex"),J("emissionsPerSecondX64"),A("openTime"),A("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],y=Buffer.alloc(p.span);p.encode({rewardIndex:c,emissionsPerSecondX64:d,openTime:Z(l),endTime:Z(m)},y);let b=Buffer.from([...Nt.setRewardEmissions,...y]);return new it({keys:f,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new U(e.programId),new U(e.id)],a,u,c;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,u=new U(t.rewardInfos[d].vault),c=new U(t.rewardInfos[d].mint.address));(a===void 0||u===void 0)&&yu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Pi(r).publicKey,m=[this.setRewardInstruction(r,n.wallet,s,l,new U(e.config.id),n.tokenAccount,u,c,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[v.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,r,s,a){let u=E([G("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Ji,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...Nt.collectReward,...l]);return new it({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[r,s]=[new U(e.programId),new U(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,u=new U(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&yu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,u,i,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[v.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:r,nftMint:s,getEphemeralSigners:a}){let u=[],c;if(a)c=new U((await a(1))[0]);else{let b=Ro.generate();u.push(b),c=b.publicKey}let{publicKey:l}=ce(r,s,he),{publicKey:m}=nt(n,s),d=ki(e,c).publicKey,p=ce(r,c,he).publicKey,f=wn(c).publicKey,y=Ae.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:r,lockOwner:r,positionNftAccount:l,positionId:m,lockPositionId:d,lockNftMint:c,lockNftAccount:p,metadataAccount:f,withMetadata:!0});return{address:{positionId:m,lockPositionId:d,lockNftAccount:p,lockNftMint:c,positionNftAccount:l,metadataAccount:f},instructions:[y],signers:u,instructionTypes:[v.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:r,positionNftAccount:s,positionId:a,lockPositionId:u,lockNftMint:c,lockNftAccount:l,metadataAccount:m,withMetadata:d}){let p=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!0,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:is,isSigner:!1,isWritable:!1},{pubkey:pt,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}],f=E([De("withMetadata")]),y=Buffer.alloc(f.span);f.encode({withMetadata:d},y);let b=Buffer.from([...bu,...y]);return new it({keys:p,programId:e,data:b})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:r}){let{publicKey:s}=ce(i,r,he),{publicKey:a}=nt(n,r),u=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Jr(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}];return new it({keys:u,programId:e,data:Buffer.from(bu)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],i=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=me(t,n,i),{publicKey:a}=me(t,n,r),{publicKey:u}=ce(e.owner,e.ownerPosition.nftMint,he),{publicKey:c}=nt(t,e.ownerPosition.nftMint),{publicKey:l}=Ot(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new U(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new U(e.poolKeys.rewardInfos[f].mint.address)});let d=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Jr(e.programId,c).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:rn,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new it({keys:p,programId:e.programId,data:Buffer.from(gu)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:u,positionId:c,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:f,tickArrayUpper:y,userVaultA:b,userVaultB:g,mintA:P,mintB:w,rewardAccounts:k,exTickArrayBitmap:I}){let h=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...k.map(B=>[{pubkey:B.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:B.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:B.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:rn,isSigner:!1,isWritable:!1},{pubkey:P,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...h];return new it({keys:S,programId:e,data:Buffer.from(gu)})}};var qk=E([Ze("mintAuthorityOption"),K("mintAuthority"),A("supply"),G("decimals"),G("isInitialized"),Ze("freezeAuthorityOption"),K("freezeAuthority")]);import{PublicKey as zk}from"@solana/web3.js";import{MintLayout as Yk,TOKEN_PROGRAM_ID as Hk}from"@solana/spl-token";var Lo=o=>new Ie({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),xi=i=>{var r=i,{amount:o,isRaw:e,name:t}=r,n=Ne(r,["amount","isRaw","name"]);return new be(new Ie({mint:dt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};var Je=i=>{var r=i,{address:o,programId:e,decimals:t}=r,n=Ne(r,["address","programId","decimals"]);return L({chainId:101,address:dt(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},mn=o=>o?D(L({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:D(L({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:D(L({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import wu from"bn.js";var os=new wu(25),Oo=new wu(1e4);import{PublicKey as Wt,SystemProgram as cd,SYSVAR_RENT_PUBKEY as Ah,TransactionInstruction as qn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as ld,TOKEN_PROGRAM_ID as Ki}from"@solana/spl-token";var rs=E([G("instruction"),A("amountIn"),A("minAmountOut")]),ss=E([G("instruction"),A("maxAmountIn"),A("amountOut")]),mh=E([G("instruction"),G("nonce")]),Hm=E([G("instruction"),G("nonce"),A("startTime")]),Mo=E([A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalValue"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),A("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("withdrawQueue"),K("lpVault"),K("owner"),A("lpReserve"),j(A(),3,"padding")]),dh=E([A("accountType"),A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalsValue"),A("abortTradeFactor"),A("priceTickMultiplier"),A("priceTick"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),A("swapBase2QuoteFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("modelDataAccount"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("owner"),j(A(),64,"padding")]),as=E([G("instruction"),A("baseAmountIn"),A("quoteAmountIn"),A("fixedSide"),A("otherAmountMin")]),us=E([G("instruction"),A("lpAmount"),A("baseAmountMin"),A("quoteAmountMin")]);var Au=E([A("fee")]);import{PublicKey as Zm}from"@solana/web3.js";var Wn=new Zm("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Bn=5e4,$m=E([A("x"),A("y"),A("price")]),Jm=E([A("accountType"),A("status"),A("multiplier"),A("validDataCount"),j($m,Bn,"DataElement")]);function ed(o,e){return[0,Bn-2]}function td(o){return[0,Bn-2]}function nd(o){return[0,Bn-2]}function id(o,e,t){let[n,i]=ed(e,t),r=n,s=i,a=0,u=e*o.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=Bn-2)return[a,a,!1];let c=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function cs(o,e,t){let[n,i,r]=id(o,e,t);if(!r)return 0;if(n===i){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,u=o.DataElement[i].x,c=o.DataElement[i].y,l=t*(u*a-s*c),m=s*l,d=(u-s)*(e*a-s*t)*c,p=m+d;return e*o.multiplier*l/p}}function In(o,e,t){return e*o.multiplier/t}function Pu(o,e,t){return e*t/o.multiplier}function od(o,e){let[t,n]=td(e),i=t,r=n,s=0,a=e;for(;i<r;){if(s=Math.floor((r+i)/2),s<=0||s>Bn-2)return[s,s,!1];let u=o.DataElement[s].x,c=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)r=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function rd(o,e){let[t,n]=nd(e),i=t,r=n,s=0,a=e;for(;i<=r;){if(s=Math.floor((r+i)/2),s<=0||s>=Bn-2)return[s,s,!1];let u=o.DataElement[s].y,c=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function ku(o,e,t,n){let i=n?e+t:e-t,[r,s,a]=od(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let u=o.DataElement[r].x,c=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=u&&e<=c)return n?[m,p,!0,a]:[l,d,!0,a];{let f,y;return n?(f=l+(m-l)*(e-u)/(c-u),y=d-(i-u)*o.multiplier/m):(f=l+(m-l)*(e-u)/(c-u),y=p+(c-i)*o.multiplier/l),[f,y,!1,a]}}}function sd(o,e,t,n){let i=n?e-t:e+t,[r,s,a]=rd(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let u=o.DataElement[r].x,c=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,c,!0,a]:[l,u,!0,a];{let f,y;return n?(f=l+(m-l)*(d-e)/(d-p),y=u+m*(d-i)/o.multiplier):(f=l+(m-l)*(d-e)/(d-p),y=c-l*(i-p)/o.multiplier),[f,y,!1,a]}}}function ad(o,e){let t=ku(o,e,0,!1);return t[3]?t[0]:0}function hu(o,e,t,n){let i=cs(o,e,t),r=In(o,e,i),s=In(o,t,i),a=In(o,n,i),u=!0,[c,l,m,d]=ku(o,r,a,u);if(!d)return 0;if(m)return n*o.multiplier/c;{let p=s-l;return Pu(o,p,i)}}function Tu(o,e,t,n){let i=cs(o,e,t),r=In(o,e,i),s=In(o,t,i),a=In(o,n,i),u=!1,[c,l,m,d]=sd(o,s,a,u);if(!d)return 0;if(m)return n*c/o.multiplier;{let p=r-l;return Pu(o,p,i)}}function ud(o){let e=Jm.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Iu(o,e,t,n){let i=ad(o,In(o,e,cs(o,e,t)))/o.multiplier;return n?i:1/i}var Si=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Wn);e&&(this._layoutData=ud(e==null?void 0:e.data))}}};var Bu=ue("Raydium_liquidity_instruction");function xu(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=o,u=Buffer.alloc(as.span);as.encode({instruction:3,baseAmountIn:Z(i),quoteAmountIn:Z(r),otherAmountMin:Z(a),fixedSide:s==="base"?ct:Js},u);let c=[T({pubkey:Ki,isWritable:!1}),T({pubkey:new Wt(e.id)}),T({pubkey:new Wt(t.authority),isWritable:!1}),T({pubkey:new Wt(t.openOrders),isWritable:!1}),T({pubkey:new Wt(t.targetOrders)}),T({pubkey:new Wt(e.lpMint.address)}),T({pubkey:new Wt(t.vault.A)}),T({pubkey:new Wt(t.vault.B)})];return e.pooltype.includes("StablePool")&&c.push(T({pubkey:Wn})),c.push(T({pubkey:new Wt(e.marketId),isWritable:!1}),T({pubkey:n.baseTokenAccount}),T({pubkey:n.quoteTokenAccount}),T({pubkey:n.lpTokenAccount}),T({pubkey:n.owner,isWritable:!1,isSigner:!0}),T({pubkey:new Wt(t.marketEventQueue),isWritable:!1})),new qn({programId:new Wt(e.programId),keys:c,data:u})}function ls(o){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:r,quoteAmountMin:s}=o,a=Qe(t),u=4;if(e.pooltype.includes("StablePool")&&(u=5),u===4||u===5){let c=Buffer.alloc(us.span);us.encode({instruction:4,lpAmount:Z(i),baseAmountMin:Z(r),quoteAmountMin:Z(s)},c);let l=[T({pubkey:Ki,isWritable:!1}),T({pubkey:a.id}),T({pubkey:a.authority,isWritable:!1}),T({pubkey:a.openOrders}),T({pubkey:a.targetOrders}),T({pubkey:a.mintLp.address}),T({pubkey:a.vault.A}),T({pubkey:a.vault.B})];return u===5?l.push(T({pubkey:Wn})):(l.push(T({pubkey:a.id})),l.push(T({pubkey:a.id}))),l.push(T({pubkey:a.marketProgramId,isWritable:!1}),T({pubkey:a.marketId}),T({pubkey:a.marketBaseVault}),T({pubkey:a.marketQuoteVault}),T({pubkey:a.marketAuthority,isWritable:!1}),T({pubkey:n.lpTokenAccount}),T({pubkey:n.baseTokenAccount}),T({pubkey:n.quoteTokenAccount}),T({pubkey:n.owner,isWritable:!1,isSigner:!0}),T({pubkey:a.marketEventQueue}),T({pubkey:a.marketBids}),T({pubkey:a.marketAsks})),new qn({programId:a.programId,keys:l,data:c})}return new qn({programId:a.programId,keys:[]})}function ms({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:r,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:f,userCoinVault:y,userPcVault:b,userLpVault:g,nonce:P,openTime:w,coinAmount:k,pcAmount:I,ammConfigId:h,feeDestinationId:S}){let B=E([G("instruction"),G("nonce"),A("openTime"),A("pcAmount"),A("coinAmount")]),C=[{pubkey:Ki,isSigner:!1,isWritable:!1},{pubkey:ld,isSigner:!1,isWritable:!1},{pubkey:cd.programId,isSigner:!1,isWritable:!1},{pubkey:pt,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],x=Buffer.alloc(B.span);return B.encode({instruction:1,nonce:P,openTime:w,coinAmount:k,pcAmount:I},x),{instruction:new qn({keys:C,programId:o,data:x}),instructionType:v.AmmV4CreatePool}}function md({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},i){let r=Qe(o),s=Buffer.alloc(rs.span);rs.encode({instruction:9,amountIn:Z(t),minAmountOut:Z(n)},s);let a=[T({pubkey:Ki,isWritable:!1}),T({pubkey:r.id}),T({pubkey:r.authority,isWritable:!1}),T({pubkey:r.openOrders})];return i===4&&a.push(T({pubkey:r.targetOrders})),a.push(T({pubkey:r.vault.A}),T({pubkey:r.vault.B})),i===5&&a.push(T({pubkey:Wn})),a.push(T({pubkey:r.marketProgramId,isWritable:!1}),T({pubkey:r.marketId}),T({pubkey:r.marketBids}),T({pubkey:r.marketAsks}),T({pubkey:r.marketEventQueue}),T({pubkey:r.marketBaseVault}),T({pubkey:r.marketQuoteVault}),T({pubkey:r.marketAuthority,isWritable:!1}),T({pubkey:e.tokenAccountIn}),T({pubkey:e.tokenAccountOut}),T({pubkey:e.owner,isWritable:!1})),new qn({programId:r.programId,keys:a,data:s})}function dd({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},i){let r=Qe(o),s=Buffer.alloc(ss.span);ss.encode({instruction:11,maxAmountIn:Z(t),amountOut:Z(n)},s);let a=[T({pubkey:Ki,isWritable:!1}),T({pubkey:r.id}),T({pubkey:r.authority,isWritable:!1}),T({pubkey:r.openOrders}),T({pubkey:r.targetOrders}),T({pubkey:r.vault.A}),T({pubkey:r.vault.B})];return i===5&&a.push(T({pubkey:Wn})),a.push(T({pubkey:r.marketProgramId,isWritable:!1}),T({pubkey:r.marketId}),T({pubkey:r.marketBids}),T({pubkey:r.marketAsks}),T({pubkey:r.marketEventQueue}),T({pubkey:r.marketBaseVault}),T({pubkey:r.marketQuoteVault}),T({pubkey:r.marketAuthority,isWritable:!1}),T({pubkey:e.tokenAccountIn}),T({pubkey:e.tokenAccountOut}),T({pubkey:e.owner,isWritable:!1,isSigner:!0})),new qn({programId:r.programId,keys:a,data:s})}function No(o){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:r,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return md(D(L({},a),{amountIn:i,minAmountOut:r}),t);if(s==="out")return dd(D(L({},a),{maxAmountIn:i,amountOut:r}),t);Bu.logWithError("invalid params","params",o)}throw Bu.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as yd}from"@solana/web3.js";import qh from"bn.js";import{TOKEN_PROGRAM_ID as bd}from"@solana/spl-token";import{PublicKey as pd}from"@solana/web3.js";var fd=ue("Raydium_liquidity_serum");function Su({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));i=pd.createProgramAddressSync(r,o)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:i,nonce:n}}throw fd.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}function _o({programId:o}){let{publicKey:e}=le([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function xn({name:o,programId:e,marketId:t}){let{publicKey:n}=le([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function gd({programId:o,marketId:e}){let{publicKey:t}=le([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function ps({programId:o}){return le([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function fs({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:u}){let c=xn({name:"amm_associated_seed",programId:a,marketId:t}),l=xn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=ps({programId:a}),p=xn({name:"coin_vault_associated_seed",programId:a,marketId:t}),f=xn({name:"pc_vault_associated_seed",programId:a,marketId:t}),y=xn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=gd({programId:a,marketId:t}),g=xn({name:"target_associated_seed",programId:a,marketId:t}),P=xn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:w}=Su({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:f,lpVault:y,openOrders:b,targetOrders:g,withdrawQueue:P,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:w,lookupTableAccount:yd.default,configId:_o({programId:a})}}var ds={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Vo=o=>{let e={},t=bd.toBase58();return Object.keys(o).map(n=>{let i=o[n],[r,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:Je({address:r,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:Je({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new M(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new M(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new M(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:ds,week:ds,month:ds,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:_o({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:0,lpMint:Je({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import xe from"bn.js";import{PublicKey as Ci}from"@solana/web3.js";import Ri from"bn.js";import{TOKEN_PROGRAM_ID as Lu}from"@solana/spl-token";import{SystemProgram as Sn,SYSVAR_RENT_PUBKEY as Ad,Transaction as Ku,TransactionInstruction as Pd}from"@solana/web3.js";import{createInitializeAccountInstruction as Cu,TOKEN_PROGRAM_ID as Ru}from"@solana/spl-token";function wd(o="accountFlags"){let e=new ko(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var ys=E([ye(5),wd("accountFlags"),K("ownAddress"),A("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),K("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),ye(7)]);function kd({programId:o,marketInfo:e}){let t=E([G("version"),Ze("instruction"),A("baseLotSize"),A("quoteLotSize"),Xt("feeRateBps"),A("vaultSignerNonce"),A("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Ad,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Pd({keys:n,programId:o,data:i})}async function vo({connection:o,wallet:e,marketInfo:t}){var s,a,u,c,l,m,d,p;let n=new Ku,i=await o.getMinimumBalanceForRentExemption(165);n.add(Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:Ru}),Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:Ru}),Cu(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Cu(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption(ys.span),space:ys.span,programId:t.programId}));let r=new Ku;return r.add(Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await o.getMinimumBalanceForRentExemption((u=t.eventQueueSpace)!=null?u:262144+12),space:t.lowestFeeMarket?11308:(c=t.eventQueueSpace)!=null?c:262144+12,programId:t.programId}),Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),Sn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),kd({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[v.CreateAccount,v.CreateAccount,v.InitAccount,v.InitAccount]},{transaction:r,signer:[],instructionTypes:[v.CreateAccount,v.CreateAccount,v.CreateAccount,v.CreateAccount,v.CreateAccount,v.InitMarket]}]}var Un=class extends Be{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u,lowestFeeMarket:c,assignSeed:l,txVersion:m,computeBudgetConfig:d}){let p=this.scope.ownerPubKey,f=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,y=Ke({fromPublicKey:p,programId:r,assignSeed:f&&`${f}-market`}),b=Ke({fromPublicKey:p,programId:r,assignSeed:f&&`${f}-request`}),g=Ke({fromPublicKey:p,programId:r,assignSeed:f&&`${f}-event`}),P=Ke({fromPublicKey:p,programId:r,assignSeed:f&&`${f}-bids`}),w=Ke({fromPublicKey:p,programId:r,assignSeed:f&&`${f}-asks`}),k=Ke({fromPublicKey:p,programId:Lu,assignSeed:f&&`${f}-baseVault`}),I=Ke({fromPublicKey:p,programId:Lu,assignSeed:f&&`${f}-quoteVault`}),h=0,S=new Ri(100);function B(){let q=new Ri(0);for(;;)try{return{vaultOwner:Ci.createProgramAddressSync([y.publicKey.toBuffer(),q.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:q}}catch{if(q.iaddn(1),q.gt(new Ri(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:x}=B(),R=new Ri(Math.round(10**e.decimals*n)),F=new Ri(Math.round(n*10**t.decimals*i));if(R.eq(ct))throw Error("lot size is too small");if(F.eq(ct))throw Error("tick size or lot size is too small");let O=await vo({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:y,baseMint:e.mint,quoteMint:t.mint,baseVault:k,quoteVault:I,vaultOwner:C,requestQueue:b,eventQueue:g,bids:P,asks:w,feeRateBps:h,quoteDustThreshold:S,vaultSignerNonce:x,baseLotSize:R,quoteLotSize:F,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u,lowestFeeMarket:c}}),X=this.createTxBuilder();X.addInstruction({instructions:O[0].transaction.instructions,signers:O[0].signer});for await(let q of O.slice(1,O.length))X.addInstruction({instructions:q.transaction.instructions,signers:q.signer,instructionTypes:q.instructionTypes});return m===0?X.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:y.publicKey,requestQueue:b.publicKey,eventQueue:g.publicKey,bids:P.publicKey,asks:w.publicKey,baseVault:k.publicKey,quoteVault:I.publicKey,baseMint:new Ci(e.mint),quoteMin:new Ci(t.mint)}}):X.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:y.publicKey,requestQueue:b.publicKey,eventQueue:g.publicKey,bids:P.publicKey,asks:w.publicKey,baseVault:k.publicKey,quoteVault:I.publicKey,baseMint:new Ci(e.mint),quoteMin:new Ci(t.mint)}})}};var Li=class extends Be{constructor(t){super(t);this.stableLayout=new Si({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:r}){let s=new xe(new M(n).mul(10**t[r?"mintA":"mintB"].decimals).toFixed(0)),a=Lo(t[r?"mintB":"mintA"]),[u,c]=[new xe(new M(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new xe(new M(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new xe(new M(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,M.ROUND_DOWN));this.logDebug("baseReserve:",u.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",r?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",r?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",u.toString(),"quoteReserve",c.toString());let m=r?"base":"quote";this.logDebug("input side:",m);let d=ct;s.isZero()||(d=m==="base"?to(s.mul(c),u):to(s.mul(u),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=to(s.mul(l),m==="base"?u:c);this.logDebug("liquidity:",p.toString());let f=new Ue(new xe(1)).add(i),y=new Ue(new xe(1)).sub(i),b=f.mul(d).quotient,g=y.mul(d).quotient,P=new be(a,d),w=new be(a,b),k=new be(a,g);return this.logDebug("anotherAmount:",P.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:P,maxAnotherAmount:w,minAnotherAmount:k,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:r,amountInB:s,otherAmountMin:a,fixedSide:u,config:c,txVersion:l,computeBudgetConfig:m}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:d}=this.scope,{bypassAssociatedCheck:p,checkCreateATAOwner:f}=L({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),[y,b]=[r.token,s.token],g=await d.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1}),P=await d.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1});!g&&!P&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",d.tokenAccounts);let w=await d.getCreatedTokenAccount({mint:new Ve(n.lpMint.address)}),k=[y,b],I=[g,P],h=[r.raw,s.raw],S=r.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",u),S==="quote"?(k.reverse(),I.reverse(),h.reverse(),B=u==="a"?"quote":"base"):S==="base"&&(B=u==="a"?"base":"quote");let[C,x]=k,[R,F]=I,[O,X]=h,q=i!=null?i:await this.getAmmPoolKeys(n.id),W=this.createTxBuilder(),st=await d.handleTokenAccount({side:"in",amount:O,mint:C.mint,tokenAccount:R,bypassAssociatedCheck:p,checkCreateATAOwner:f}),{tokenAccount:Se}=st,Vt=Ne(st,["tokenAccount"]);W.addInstruction(Vt);let gt=await d.handleTokenAccount({side:"in",amount:X,mint:x.mint,tokenAccount:F,bypassAssociatedCheck:p,checkCreateATAOwner:f}),{tokenAccount:Me}=gt,ot=Ne(gt,["tokenAccount"]);W.addInstruction(ot);let fn=await d.handleTokenAccount({side:"out",amount:0,mint:new Ve(n.lpMint.address),tokenAccount:w,bypassAssociatedCheck:p,checkCreateATAOwner:f}),{tokenAccount:rt}=fn,mt=Ne(fn,["tokenAccount"]);return W.addInstruction(mt),W.addInstruction({instructions:[xu({poolInfo:n,poolKeys:q,userKeys:{baseTokenAccount:Se,quoteTokenAccount:Me,lpTokenAccount:rt,owner:this.scope.ownerPubKey},baseAmountIn:O,quoteAmountIn:X,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?v.AmmV5AddLiquidity:v.AmmV4AddLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),W.addCustomComputeBudget(m),l===0&&await W.buildV0(),W.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:r,baseAmountMin:s,quoteAmountMin:a,config:u,txVersion:c,computeBudgetConfig:l}=t,m=i!=null?i:await this.getAmmPoolKeys(n.id),[d,p,f]=[new Ve(n.mintA.address),new Ve(n.mintB.address),new Ve(n.lpMint.address)];this.logDebug("lpAmount:",r),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),r.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",r.toString());let{account:y}=this.scope,b=await y.getCreatedTokenAccount({mint:f,associatedOnly:!1});b||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",y.tokenAccounts);let g=await y.getCreatedTokenAccount({mint:d}),P=await y.getCreatedTokenAccount({mint:p}),w=this.createTxBuilder(),{bypassAssociatedCheck:k,checkCreateATAOwner:I}=L({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),x=await y.handleTokenAccount({side:"out",amount:0,mint:d,tokenAccount:g,bypassAssociatedCheck:k,checkCreateATAOwner:I}),{tokenAccount:h}=x,S=Ne(x,["tokenAccount"]);w.addInstruction(S);let R=await y.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:P,bypassAssociatedCheck:k,checkCreateATAOwner:I}),{tokenAccount:B}=R,C=Ne(R,["tokenAccount"]);return w.addInstruction(C),w.addInstruction({instructions:[ls({poolInfo:n,poolKeys:m,userKeys:{lpTokenAccount:b,baseTokenAccount:h,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:r,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?v.AmmV5RemoveLiquidity:v.AmmV4RemoveLiquidity]}),w.addCustomComputeBudget(l),c===0?await w.buildV0():w.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:r,farmInfo:s,userFarmLpAmount:a,base:u,computeBudgetConfig:c,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=dn,checkCreateATAOwner:p=!0,getEphemeralSigners:f,txVersion:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let b=this.createTxBuilder();b.addCustomComputeBudget(c);let g={};for(let W of this.scope.account.tokenAccountRawInfos)(g[W.accountInfo.mint.toString()]===void 0||ce(this.scope.ownerPubKey,W.accountInfo.mint,dn).publicKey.equals(W.pubkey))&&(g[W.accountInfo.mint.toString()]=W.pubkey);let P=g[t.lpMint.address];if(P===void 0)throw Error("find lp account error in trade accounts");let w=i.add(a!=null?a:new xe(0)),k=t.mintA.address===Ie.WSOL.mint.toString(),I=t.mintB.address===Ie.WSOL.mint.toString(),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:dn,mint:new Ve(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(S||{}),h===void 0)throw new Error("base token account not found");let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:dn,mint:new Ve(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(C||{}),B===void 0)throw new Error("quote token account not found");if(g[t.mintA.address]=h,g[t.mintB.address]=B,s!==void 0&&!(a!=null&&a.isZero())){let W=wt[s.programId],Se=At({programId:new Ve(s.programId),poolId:new Ve(s.id),owner:this.scope.ownerPubKey,version:W}),Vt,Me=await this.scope.connection.getAccountInfo(Se);if(Me&&(Vt=mi(W).decode(Me.data)),W!==6&&!Vt){let{instruction:vt,instructionType:On}=pi({id:new Ve(s.id),programId:new Ve(s.programId),version:W,ledger:Se,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[vt],instructionTypes:[On]})}let ot=[];for(let vt of s.rewardInfos){let On=vt.mint.address===Ie.WSOL.mint.toString();if(g[vt.mint.address])ot.push(g[vt.mint.address]);else{let{account:Wi,instructionParams:ve}=await this.scope.account.getOrCreateTokenAccount({mint:new Ve(vt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!On,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});Wi||this.logAndCreateError("farm reward account not found:",vt.mint.address),ve&&b.addInstruction(ve),ot.push(Wi)}}let rt=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],mt={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:rt,lpAccount:P,rewardAccounts:ot},st=wt[s.programId],gt=st===6?fi(mt):st===5?yi(mt):bi(mt),fn={3:v.FarmV3Withdraw,5:v.FarmV5Withdraw,6:v.FarmV6Withdraw};b.addInstruction({instructions:[gt],instructionTypes:[fn[st]]})}let x=await this.getAmmPoolKeys(t.id),R=ls({poolInfo:t,poolKeys:x,userKeys:{lpTokenAccount:P,baseTokenAccount:h,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:w,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[R],instructionTypes:[t.pooltype.includes("StablePool")?v.AmmV5RemoveLiquidity:v.AmmV4RemoveLiquidity],lookupTableAddress:x.lookupTableAccount?[x.lookupTableAccount]:[]});let[F,O]=t.mintA.address===n.mintA.address?[h,B]:[B,h],X=await this.scope.clmm.getClmmPoolKeys(n.id),q=await Ae.openPositionFromBaseInstructions(D(L({poolInfo:n,poolKeys:X,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:F,tokenAccountB:O},withMetadata:"create"},r),{base:u,getEphemeralSigners:f}));return b.addInstruction({instructions:[...q.instructions],signers:q.signers,instructionTypes:[...q.instructionTypes],lookupTableAddress:X.lookupTableAccount?[X.lookupTableAccount]:[]}),y===0?b.sizeCheckBuildV0():b.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:r,baseAmount:s,quoteAmount:a,startTime:u,ownerInfo:c,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:f,computeBudgetConfig:y}){var F;let b=c.feePayer||((F=this.scope.owner)==null?void 0:F.publicKey),g=c.useSOLBalance&&i.mint.equals(Eo),P=c.useSOLBalance&&r.mint.equals(Eo),w=this.createTxBuilder(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});w.addInstruction(I||{});let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:P?{payer:b,amount:a}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:l,checkCreateATAOwner:m});if(w.addInstruction(S||{}),k===void 0||h===void 0)throw Error("you don't has some token account");let B=fs({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:f},{instruction:x,instructionType:R}=ms(D(L({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:k,userPcVault:h,userLpVault:ce(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:u,coinAmount:s,pcAmount:a}));return w.addInstruction({instructions:[x],instructionTypes:[R]}),w.addCustomComputeBudget(y),w.versionBuild({txVersion:p,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=oo,marketProgram:n=ca,feeDestinationId:i=ma,tokenProgram:r,baseMintInfo:s,quoteMintInfo:a,baseAmount:u,quoteAmount:c,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:f=!1,checkCreateATAOwner:y=!1,lotSize:b=1,tickSize:g=.01,txVersion:P,computeBudgetConfig:w}){var Bs;let k=this.scope.ownerPubKey,I=m.feePayer||((Bs=this.scope.owner)==null?void 0:Bs.publicKey),h=m.useSOLBalance&&s.mint.equals(Eo),S=m.useSOLBalance&&a.mint.equals(Eo),B=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,C=Ke({fromPublicKey:k,programId:n,assignSeed:B&&`${B}-market`}),x=Ke({fromPublicKey:k,programId:n,assignSeed:B&&`${B}-request`}),R=Ke({fromPublicKey:k,programId:n,assignSeed:B&&`${B}-event`}),F=Ke({fromPublicKey:k,programId:n,assignSeed:B&&`${B}-bids`}),O=Ke({fromPublicKey:k,programId:n,assignSeed:B&&`${B}-asks`}),X=Ke({fromPublicKey:k,programId:dn,assignSeed:B&&`${B}-baseVault`}),q=Ke({fromPublicKey:k,programId:dn,assignSeed:B&&`${B}-quoteVault`}),W=0,Se=new xe(100);function Vt(){let $t=new xe(0);for(;;)try{return{vaultOwner:Ve.createProgramAddressSync([C.publicKey.toBuffer(),$t.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:$t}}catch{if($t.iaddn(1),$t.gt(new xe(25555)))throw Error("find vault owner error")}}let{vaultOwner:Me,vaultSignerNonce:ot}=Vt(),rt=new xe(Math.round(10**s.decimals*b)),mt=new xe(Math.round(b*10**a.decimals*g));if(rt.eq(ct))throw Error("lot size is too small");if(mt.eq(ct))throw Error("tick size or lot size is too small");let st=await vo({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:Me,baseMint:s.mint,quoteMint:a.mint,id:C,baseVault:X,quoteVault:q,requestQueue:x,eventQueue:R,bids:F,asks:O,feeRateBps:W,quoteDustThreshold:Se,vaultSignerNonce:ot,baseLotSize:rt,quoteLotSize:mt,lowestFeeMarket:d}}),gt=this.createTxBuilder();gt.addInstruction({instructions:st[0].transaction.instructions,signers:st[0].signer});for await(let $t of st.slice(1,st.length))gt.addInstruction({instructions:$t.transaction.instructions,signers:$t.signer,instructionTypes:$t.instructionTypes});let{account:fn,instructionParams:vt}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:h?{payer:I,amount:u}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:f,checkCreateATAOwner:y});gt.addInstruction(vt||{});let{account:On,instructionParams:Wi}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:I,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:f,checkCreateATAOwner:y});if(gt.addInstruction(Wi||{}),fn===void 0)throw Error("you don't has base token account");if(On===void 0)throw Error("you don't has quote token account");let ve=fs({version:4,marketVersion:3,marketId:C.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),tr={programId:t,ammId:ve.id,ammAuthority:ve.authority,ammOpenOrders:ve.openOrders,lpMint:ve.lpMint,coinMint:ve.baseMint,pcMint:ve.quoteMint,coinVault:ve.baseVault,pcVault:ve.quoteVault,withdrawQueue:ve.withdrawQueue,ammTargetOrders:ve.targetOrders,poolTempLp:ve.lpVault,marketProgramId:ve.marketProgramId,marketId:ve.marketId,ammConfigId:ve.configId,feeDestinationId:i},{instruction:tc,instructionType:nc}=ms(D(L({},tr),{userWallet:this.scope.ownerPubKey,userCoinVault:fn,userPcVault:On,userLpVault:ce(this.scope.ownerPubKey,ve.lpMint,r).publicKey,nonce:ve.nonce,openTime:l,coinAmount:u,pcAmount:c}));return gt.addInstruction({instructions:[tc],instructionTypes:[nc]}),P===0?gt.sizeCheckBuildV0({computeBudgetConfig:w,address:L({requestQueue:x.publicKey,eventQueue:R.publicKey,bids:F.publicKey,asks:O.publicKey,baseVault:X.publicKey,quoteVault:q.publicKey,baseMint:new Ve(s.mint),quoteMin:new Ve(a.mint)},tr)}):gt.sizeCheckBuild({computeBudgetConfig:w,address:L({requestQueue:x.publicKey,eventQueue:R.publicKey,bids:F.publicKey,asks:O.publicKey,baseVault:X.publicKey,quoteVault:q.publicKey,baseMint:new Ve(s.mint),quoteMin:new Ve(a.mint)},tr)})}async getCreatePoolFee({programId:t}){let n=_o({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return Au.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:r,slippage:s}){let[a,u]=[i.toString(),r.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(u!==t.mintA.address&&u!==t.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:l}=t,m=[c,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[f,y]=m,[b,g]=d,P=t.version===4,w;if(P)w=new M(y.toString()).div(10**g).div(new M(f.toString()).div(10**b));else{let O=Iu(this.stableLayout.stableModelData,c.toNumber(),l.toNumber(),!1);p==="quote"?w=new M(1e6).div(O*1e6):w=new M(O*1e6).div(1e6)}let k=n,I=new xe(0),h=new xe(0);if(!k.isZero())if(P){h=sn(k.mul(os),Oo);let O=k.sub(h),X=f.add(O);I=y.mul(O).div(X)}else{h=k.mul(new xe(2)).div(new xe(1e4));let O=k.sub(h);p==="quote"?I=new xe(hu(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),O.toNumber())):I=new xe(Tu(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),O.toNumber()))}let S=new xe(new M(I.toString()).mul(1-s).toFixed(0)),B=I,C=S,x=new M(I.toString()).div(new M(k.sub(h).toString()).toFixed(0));!k.isZero()&&!I.isZero()&&(x=new M(I.toString()).div(10**g).div(new M(k.sub(h).toString()).div(10**b)));let R=w.sub(x).div(w).mul(100);return{amountOut:B,minAmountOut:C,currentPrice:w,executionPrice:x,priceImpact:R,fee:h}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:r,slippage:s}){let{baseReserve:a,quoteReserve:u}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",u.toString());let c=i.toString()===t.mintA.address,[l,m]=c?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new M(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,u],p=c?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[f,y]=d,b=new M(y.toString()).div(10**t[c?"mintB":"mintA"].decimals).div(new M(f.toString()).div(10**t[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new M(1).div(b).toString()} ${l.symbol||l.address}`);let g=new xe(0),P=n;if(!P.isZero()){P.gt(y)&&(P=y.sub(new xe(1)));let C=y.sub(P);g=f.mul(P).div(C).mul(Oo).div(Oo.sub(os))}let w=new xe(new M(g.toString()).mul(1+s).toFixed(0)),k=g,I=w;this.logDebug("amountIn:",new M(k.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new M(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let h=null;!g.isZero()&&!P.isZero()&&(h=new M(P.toString()).div(10**m.decimals).div(new M(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${h.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new M(1).div(h).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(k.toString()),B=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:I,currentPrice:b,executionPrice:h,priceImpact:B}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:r,inputMint:s,fixedSide:a,txVersion:u,config:c,computeBudgetConfig:l}){let m=this.createTxBuilder(),{associatedOnly:d=!0,inputUseSolBalance:p=!0,outputUseSolBalance:f=!0}=c||{},[y,b]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],g=p&&y.address===H.toBase58(),P=f&&b.address===H.toBase58(),{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:dn,mint:new Ve(y.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:d});m.addInstruction(k||{}),w||this.logAndCreateError("input token account not found",{token:y.symbol||y.address,tokenAccountIn:w,inputTokenUseSolBalance:g,associatedOnly:d});let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:dn,mint:new Ve(b.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:d});m.addInstruction(h||{}),I===void 0&&this.logAndCreateError("output token account not found",{token:b.symbol||b.address,tokenAccountOut:I,outputTokenUseSolBalance:P,associatedOnly:d});let S=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),m.addInstruction({instructions:[No({version:B,poolKeys:S,userKeys:{tokenAccountIn:w,tokenAccountOut:I,owner:this.scope.ownerPubKey},amountIn:i,amountOut:r,fixedSide:a})],instructionTypes:[B===4?v.AmmV4SwapBaseIn:v.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(l),m.versionBuild({txVersion:u})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await qe(this.scope.connection,t.map(l=>({pubkey:new Ve(l)})),n),r={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Mo.decode(m.accountInfo.data);r[String(t[l])]=D(L({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},u=await qe(this.scope.connection,s.map(l=>({pubkey:new Ve(l)})),n);for(let l=0;l<s.length;l++){let m=u[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new xe(hd.decode(m.data).amount.toString())}let c={};for(let[l,m]of Object.entries(r)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);c[l]=D(L({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new M(p.toString()).div(new M(10).pow(m.quoteDecimal.toString())).div(new M(d.toString()).div(new M(10).pow(m.baseDecimal.toString())))})}return c}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=Vo({[t]:n}),r=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:r,poolKeys:s[0]}}};import{PublicKey as Q}from"@solana/web3.js";import lt from"bn.js";import{AccountLayout as Ou,TOKEN_PROGRAM_ID as Oi}from"@solana/spl-token";var Mi=class extends Be{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var w;let{programId:t,owner:n=((w=this.scope.owner)==null?void 0:w.publicKey)||Q.default,mint1:i,mint2:r,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,getObserveState:m,txVersion:d}=e,p=this.createTxBuilder(),[f,y,b]=new lt(new Q(i.address).toBuffer()).gt(new lt(new Q(r.address).toBuffer()))?[r,i,new M(1).div(a)]:[i,r,a],g=ne.priceToSqrtPriceX64(b,f.decimals,y.decimals),P=await Ae.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:y,ammConfigId:s.id,initialPriceX64:g,startTime:u,forerunCreate:!m&&l});return p.addInstruction(P),p.addCustomComputeBudget(c),p.versionBuild({txVersion:d,extInfo:{address:D(L({},P.address),{programId:t.toString(),id:P.address.poolId.toString(),mintA:f,mintB:y,openTime:u.toString(),vault:{A:P.address.mintAVault.toString(),B:P.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:L({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:P.address.poolId.toString(),mintA:f,mintB:y,feeRate:s.tradeFeeRate,openTime:u.toString(),programId:t.toString(),price:b.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},eu),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:f}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let y=this.createTxBuilder(),b=null,g=null,P=n.useSOLBalance&&e.mintA.address===H.toString(),w=n.useSOLBalance&&e.mintB.address===H.toString(),[k,I]=s==="MintA"?[a,u]:[u,a],{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:P||k.isZero()?{payer:this.scope.ownerPubKey,amount:k}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:c,checkCreateATAOwner:l});h&&(b=h),y.addInstruction(S||{});let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||I.isZero()?{payer:this.scope.ownerPubKey,amount:I}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:c,checkCreateATAOwner:l});B&&(g=B),y.addInstruction(C||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:b==null?void 0:b.toBase58(),ownerTokenAccountB:g==null?void 0:g.toBase58()});let x=t||await this.getClmmPoolKeys(e.id),R=await Ae.openPositionFromBaseInstructions({poolInfo:e,poolKeys:x,ownerInfo:D(L({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g}),tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:d});return y.addInstruction(R),y.addCustomComputeBudget(p),y.versionBuild({txVersion:f,extInfo:L({},R.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,getEphemeralSigners:f}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let y=this.createTxBuilder(),b=null,g=null,P=n.useSOLBalance&&e.mintA.address===H.toBase58(),w=n.useSOLBalance&&e.mintB.address===H.toBase58(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:P||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:c,checkCreateATAOwner:l});k&&(b=k),y.addInstruction(I||{});let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:c,checkCreateATAOwner:l});h&&(g=h),y.addInstruction(S||{}),(b===void 0||g===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=t||await this.getClmmPoolKeys(e.id),C=await Ae.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:B,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:i,amountMaxB:r,withMetadata:m,getEphemeralSigners:f});return y.addInstruction(C),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d,extInfo:{address:C.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e,p=this.createTxBuilder(),f,y,b=u.useSOLBalance&&t.mintA.address===H.toString(),g=u.useSOLBalance&&t.mintB.address===H.toString(),{account:P,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!b,associatedOnly:b?!1:c,checkCreateATAOwner:l});P&&(f=P),p.addInstruction(w||{});let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:g||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:l});k&&(y=k),p.addInstruction(I||{}),!f&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let h=n!=null?n:await this.getClmmPoolKeys(t.id),S=Ae.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:h,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:y},liquidity:a,amountMaxA:r,amountMaxB:s});return p.addInstruction(S),p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:S.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:i,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,f,y=a.useSOLBalance&&t.mintA.address===H.toString(),b=a.useSOLBalance&&t.mintB.address===H.toString(),{account:g,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y||(i==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?r:s}:void 0,skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:c});g&&(p=g),d.addInstruction(P||{});let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b||(i==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:r}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});w&&(f=w),d.addInstruction(k||{}),!p&&!f&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getClmmPoolKeys(t.id),h=Ae.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:f},base:i,baseAmount:r,otherAmountMax:s});return d.addInstruction(h),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:h.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),f=r.useSOLBalance&&t.mintA.address===H.toString(),y=r.useSOLBalance&&t.mintB.address===H.toString(),b,g,{account:P,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:f?!1:c,checkCreateATAOwner:l});b=P,w&&p.addInstruction(w);let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:c,checkCreateATAOwner:l});g=k,I&&p.addInstruction(I);let h=[];for(let x of t.rewardDefaultInfos){let R=r.useSOLBalance&&x.mint.address===H.toString(),F;if(x.mint.address===t.mintA.address)F=b;else if(x.mint.address===t.mintB.address)F=g;else{let{account:O,instructionParams:X}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(x.mint.programId),mint:new Q(x.mint.address),notUseTokenAccount:R,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!R,associatedOnly:R?!1:c,checkCreateATAOwner:l});F=O,X&&p.addInstruction(X)}h.push(F)}!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let S=n!=null?n:await this.getClmmPoolKeys(t.id),B=await Ae.decreaseLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:h},liquidity:u,amountMinA:s,amountMinB:a});p.addInstruction({instructions:B.instructions,instructionTypes:[v.ClmmDecreasePosition]});let C=L({},B.address);if(r.closePosition){let x=await Ae.closePositionInstructions({poolInfo:t,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i});p.addInstruction({endInstructions:x.instructions,endInstructionTypes:x.instructionTypes}),C=L(L({},C),x.address)}return p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:C}})}async lockPosition(e){let{programId:t=ti,authProgramId:n=ro,poolProgramId:i=bn,ownerPosition:r,payer:s,computeBudgetConfig:a,txVersion:u,getEphemeralSigners:c}=e,l=this.createTxBuilder(),m=await Ae.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:c});return l.addInstruction(m),l.addCustomComputeBudget(a),l.versionBuild({txVersion:u,extInfo:m.address})}async harvestLockPosition(e){let{programId:t=ti,authProgramId:n=ro,clmmProgram:i=bn,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=r||await this.getClmmPoolKeys(s.poolId.toString()),p=this.createTxBuilder(),f=await this.scope.connection.getAccountInfo(s.positionId);f||this.logger.logWithError("position not found",s.positionId);let y=Bi.decode(f.data),b=a.useSOLBalance&&d.mintA.address===H.toString(),g=a.useSOLBalance&&d.mintB.address===H.toString(),P,w,{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new Q(d.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});P=k,I&&p.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new Q(d.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:c});w=h,S&&p.addInstruction(S);let B={},C=[];for(let Me of d.rewardInfos){let ot=a.useSOLBalance&&Me.mint.address===H.toString(),rt=B[Me.mint.address];if(!rt){let{account:mt,instructionParams:st}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(Me.mint.programId),mint:new Q(Me.mint.address),notUseTokenAccount:ot,owner:this.scope.ownerPubKey,skipCloseAccount:!ot,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:ot?!1:u});rt=mt,st&&p.addInstruction(st)}B[Me.mint.address]=rt,C.push(rt)}let x=ki(t,s.lockNftMint).publicKey,R=ce(this.scope.ownerPubKey,s.lockNftMint,Oi).publicKey,F=Y.getTickArrayStartIndexByTick(y.tickLower,d.config.tickSpacing),O=Y.getTickArrayStartIndexByTick(y.tickUpper,d.config.tickSpacing),{publicKey:X}=me(new Q(d.programId),s.poolId,F),{publicKey:q}=me(new Q(d.programId),s.poolId,O),{publicKey:W}=Ot(new Q(d.programId),s.poolId,y.tickLower,y.tickUpper),Se=[];for(let Me=0;Me<d.rewardInfos.length;Me++)Se.push({poolRewardVault:new Q(d.rewardInfos[Me].vault),ownerRewardVault:C[Me],rewardMint:new Q(d.rewardInfos[Me].mint.address)});let Vt=await Ae.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:x,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:R,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:W,vaultA:new Q(d.vault.A),vaultB:new Q(d.vault.B),tickArrayLower:X,tickArrayUpper:q,userVaultA:P,userVaultB:w,mintA:new Q(d.mintA.address),mintB:new Q(d.mintB.address),rewardAccounts:Se,exTickArrayBitmap:je(i,s.poolId).publicKey});return p.addInstruction({instructions:[Vt],instructionTypes:[v.ClmmHarvestLockPosition]}),p.addCustomComputeBudget(l),p.versionBuild({txVersion:m})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let r=this.createTxBuilder(),s=t!=null?t:await this.getClmmPoolKeys(e.id),a=Ae.closePositionInstructions({poolInfo:e,poolKeys:s,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});return r.addInstruction(a).versionBuild({txVersion:i,extInfo:{address:a.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===H.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(n.mint.address),mint:new Q(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new lt(new M(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:r});d&&u.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),f=Ae.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new Q(n.mint.programId),mint:new Q(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ie.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){for(let m of i)m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let c=this.createTxBuilder(),l={};for(let m of i){let d=n.useSOLBalance&&m.mint.address===H.toString(),p=m.perSecond.mul(m.endTime-m.openTime),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(m.mint.programId),mint:new Q(m.mint.address),notUseTokenAccount:!!d,skipCloseAccount:!d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new lt(new M(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:d?!1:r,checkCreateATAOwner:s});y&&c.addInstruction(y),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=t!=null?t:await this.getClmmPoolKeys(e.id),g=Ae.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{programId:new Q(m.mint.programId),mint:new Q(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ie.decimalToX64(m.perSecond)}});l=L(L({},l),g.address),c.addInstruction(g)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals(H),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new lt(new M(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:r});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=Ae.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ie.decimalToX64(n.perSecond)}});return u.addInstruction(p),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){let c=this.createTxBuilder(),l={};for(let m of i){m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let d=n.useSOLBalance&&m.mint.address===H.toString(),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(m.mint.programId),mint:new Q(m.mint.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new lt(new M(m.perSecond.sub(m.endTime-m.openTime).toFixed(0)).gte(m.perSecond.sub(m.endTime-m.openTime))?m.perSecond.sub(m.endTime-m.openTime).toFixed(0):m.perSecond.sub(m.endTime-m.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:r,checkCreateATAOwner:s});f&&c.addInstruction(f),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=t!=null?t:await this.getClmmPoolKeys(e.id),b=Ae.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new Q(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ie.decimalToX64(m.perSecond)}});c.addInstruction(b),l=L(L({},l),b.address)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals(H),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:i,checkCreateATAOwner:r});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=Ae.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(y=>y.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals(H),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:i,checkCreateATAOwner:r});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),f=Ae.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(f),a=L(L({},a),f.address)}return s.build({address:a})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let f=this.createTxBuilder(),y=n.toString()===e.mintA.address,b=u.useSOLBalance&&e.mintA.address===H.toBase58(),g=u.useSOLBalance&&e.mintB.address===H.toBase58(),P;!s||s.equals(new M(0))?P=y?ht.add(new lt(1)):Tt.sub(new lt(1)):P=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!y?{payer:u.feePayer||this.scope.ownerPubKey,amount:y?i:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});w=h,S&&f.addInstruction(S)}let k;if(!k){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||y?{payer:u.feePayer||this.scope.ownerPubKey,amount:y?0:i}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=h,S&&f.addInstruction(S)}(!w||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return f.addInstruction(Ae.makeSwapBaseInInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},inputMint:new Q(n),amountIn:i,amountOutMin:r,sqrtPriceLimitX64:P,remainingAccounts:c})),f.addCustomComputeBudget(p),f.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let f=this.createTxBuilder(),y=n.toString()===e.mintB.address,b=u.useSOLBalance&&e.mintA.address===H.toBase58(),g=u.useSOLBalance&&e.mintB.address===H.toBase58(),P;!s||s.equals(new M(0))?P=n.toString()===e.mintB.address?ht.add(new lt(1)):Tt.sub(new lt(1)):P=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!y?{payer:u.feePayer||this.scope.ownerPubKey,amount:y?r:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});w=h,S&&f.addInstruction(S)}let k;if(!k){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||y?{payer:u.feePayer||this.scope.ownerPubKey,amount:y?0:r}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=h,S&&f.addInstruction(S)}(!w||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return f.addInstruction(Ae.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},outputMint:new Q(n),amountOut:i,amountInMax:r,sqrtPriceLimitX64:P,remainingAccounts:c})),f.addCustomComputeBudget(p),f.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:u,computeBudgetConfig:c}){var d;let l={};for(let p of this.scope.account.tokenAccountRawInfos)r?ce(this.scope.ownerPubKey,p.accountInfo.mint,a).publicKey.equals(p.pubkey)&&(l[p.accountInfo.mint.toString()]=p.pubkey):l[p.accountInfo.mint.toString()]=p.pubkey;let m=this.createTxBuilder();for(let p of Object.values(e)){if(t[p.id]===void 0||!t[p.id].find(h=>!h.liquidity.isZero()||h.rewardInfos.find(S=>!S.rewardAmountOwed.isZero())))continue;let f=p,y=i.useSOLBalance&&f.mintA.address===H.toString(),b=i.useSOLBalance&&f.mintB.address===H.toString(),g=l[f.mintA.address];if(!g){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintA.programId,mint:new Q(f.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:r,checkCreateATAOwner:s});g=h,S&&m.addInstruction(S)}let P=l[f.mintB.address];if(!P){let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintB.programId,mint:new Q(f.mintB.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:b?!1:r,checkCreateATAOwner:s});P=h,S&&m.addInstruction(S)}l[f.mintA.address]=g,l[f.mintB.address]=P;let w=[];for(let h of f.rewardDefaultInfos){let S=i.useSOLBalance&&h.mint.address===H.toString(),B=l[h.mint.address];if(!B){let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(h.mint.programId),mint:new Q(h.mint.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,skipCloseAccount:!S,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:S?!1:r});B=C,x&&m.addInstruction(x)}l[h.mint.address]=B,w.push(B)}let k=await this.getClmmPoolKeys(f.id),I=[];for(let h=0;h<k.rewardInfos.length;h++)I.push({poolRewardVault:new Q(k.rewardInfos[h].vault),ownerRewardVault:w[h],rewardMint:new Q(k.rewardInfos[h].mint.address)});for(let h of t[p.id]){let S=(d=n==null?void 0:n[p.id])==null?void 0:d[h.nftMint.toBase58()];if(S){let B=ce(this.scope.ownerPubKey,S.lockNftMint,Oi).publicKey,C=Y.getTickArrayStartIndexByTick(h.tickLower,k.config.tickSpacing),x=Y.getTickArrayStartIndexByTick(h.tickUpper,k.config.tickSpacing),{publicKey:R}=me(new Q(k.programId),S.poolId,C),{publicKey:F}=me(new Q(k.programId),S.poolId,x),{publicKey:O}=Ot(new Q(k.programId),S.poolId,h.tickLower,h.tickUpper),X=ki(ti,S.lockNftMint).publicKey,q=Ae.harvestLockPositionInstructionV2({programId:ti,auth:ro,lockPositionId:X,clmmProgram:bn,lockOwner:this.scope.ownerPubKey,lockNftMint:S.lockNftMint,lockNftAccount:B,positionNftAccount:S.nftAccount,positionId:S.positionId,poolId:S.poolId,protocolPosition:O,vaultA:new Q(k.vault.A),vaultB:new Q(k.vault.B),tickArrayLower:R,tickArrayUpper:F,userVaultA:g,userVaultB:P,mintA:new Q(k.mintA.address),mintB:new Q(k.mintB.address),rewardAccounts:I,exTickArrayBitmap:je(bn,S.poolId).publicKey});m.addInstruction({instructions:[q],instructionTypes:[v.ClmmHarvestLockPosition],lookupTableAddress:k.lookupTableAccount?[k.lookupTableAccount]:[]})}else{let B=Ae.decreaseLiquidityInstructions({poolInfo:f,poolKeys:k,ownerPosition:h,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:g,tokenAccountB:P,rewardAccounts:w},liquidity:new lt(0),amountMinA:new lt(0),amountMinB:new lt(0)});m.addInstruction(B)}}}return u===0?m.sizeCheckBuildV0({computeBudgetConfig:c}):m.sizeCheckBuild({computeBudgetConfig:c})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Pi(e).publicKey);return t?pu.decode(t.data).whitelistMints.filter(i=>!i.equals(Q.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new lt(1))).map(s=>nt(new Q(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return i.forEach(s=>{if(!s)return;let a=Bi.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await qe(this.scope.connection,e.map(r=>({pubkey:new Q(r)})),t),i={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=kn.decode(s.accountInfo.data),u=ne.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[r])]=D(L({},a),{currentPrice:u,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(u=>e[u].ammConfig.toBase58())),i=await qe(this.scope.connection,Array.from(n).map(u=>({pubkey:new Q(u)}))),r={};i.forEach(u=>{!u.accountInfo||(r[u.pubkey.toBase58()]=mu.decode(u.accountInfo.data))});let s=await Re.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(u=>{var m,d,p,f;let[c,l]=[e[u].mintA.toBase58(),e[u].mintB.toBase58()];return{id:u,programId:e[u].programId.toBase58(),mintA:Je({address:c,decimals:e[u].mintDecimalsA,programId:t[c].programId.toBase58()||Oi.toBase58(),extensions:{feeConfig:(m=t[c])!=null&&m.feeConfig?mn((d=t[c])==null?void 0:d.feeConfig):void 0}}),mintB:Je({address:l,decimals:e[u].mintDecimalsB,programId:t[l].programId.toBase58()||Oi.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?mn((f=t[l])==null?void 0:f.feeConfig):void 0}}),price:e[u].currentPrice,config:D(L({},r[e[u].ammConfig.toBase58()]),{id:e[u].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Re.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await Mn({connection:this.scope.connection,mints:Array.from(n).map(m=>new Q(m))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await qe(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),u=cu(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");u.mintAmountA=Number(Ou.decode(a[0].accountInfo.data).amount.toString()),u.mintAmountB=Number(Ou.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let c=D(L({},r[e]),{id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:u.config,rewardInfos:r[e].rewardInfos.filter(m=>!m.tokenVault.equals(Q.default)).map(m=>({mint:Je({address:m.tokenMint.toBase58(),programId:Oi.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:u,poolKeys:c,computePoolInfo:r[e],tickData:s}}};import{PublicKey as z}from"@solana/web3.js";import{AccountLayout as Vd,NATIVE_MINT as Yo,TOKEN_PROGRAM_ID as _t}from"@solana/spl-token";import gs from"bn.js";import qo from"decimal.js-light";import Ni from"bn.js";function Fo(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function Td(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=Fo(o,e);return n.gt(Gn)&&(t=t.add(new Ni(1)),e=o.div(t),n=Fo(o,t),n.gt(Gn)&&(e=e.add(new Ni(1)))),[t,e]}var Gn=new Ni(0),Do=class{static swapWithoutFees(e,t,n){let i=t.mul(n),r=t.add(e),[s,a]=Td(i,r),u=a.sub(t),c=n.sub(s);if(c.isZero())throw Error("destinationAmountSwapped is zero");return{sourceAmountSwapped:u,destinationAmountSwapped:c}}static lpTokensToTradingTokens(e,t,n,i,r){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Fo(e.mul(n),t).gt(Gn)&&s.gt(Gn)&&(s=s.add(new Ni(1))),Fo(e.mul(i),t).gt(Gn)&&a.gt(Gn)&&(a=a.add(new Ni(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};import Nu from"bn.js";var bs=new Nu(1e6);function Id(o,e,t){return o.mul(e).add(t).sub(new Nu(1)).div(t)}function Mu(o,e,t){return o.mul(e).div(t)}var Wo=class{static tradingFee(e,t){return Id(e,t,bs)}static protocolFee(e,t){return Mu(e,t,bs)}static fundFee(e,t){return Mu(e,t,bs)}};var Uo=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let r=Wo.tradingFee(e,i),s=e.sub(r),{sourceAmountSwapped:a,destinationAmountSwapped:u}=Do.swapWithoutFees(s,t,n),c=a.add(r);return{newSwapSourceAmount:t.add(c),newSwapDestinationAmount:n.sub(u),sourceAmountSwapped:c,destinationAmountSwapped:u,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:r,outputMint:s,outputAmount:a}){let[u,c,l,m,d]=t.address===s.toString()?[i,r,e.decimals,t.decimals,e.address]:[r,i,t.decimals,e.decimals,t.address],p=new qo(c.toString()).div(10**m).div(new qo(u.toString()).div(10**l)),f=a.gte(c)?c.sub(new gs(1)):a,y=c.sub(f),b=sn(u.mul(f),y),g=sn(b.mul(new gs(1e6)),new gs(1e6).sub(n)),P=g.sub(b),w=new qo(f.toString()).div(10**m).div(new qo(g.toString()).div(10**l)),k=p.isZero()?0:w.sub(p).div(p).abs().toNumber();return{amountRealOut:f,amountIn:g,amountInWithoutFee:b,tradeFee:P,priceImpact:k}}};import Le from"bn.js";import{PublicKey as _i,TransactionInstruction as Kn,Keypair as Od,SystemProgram as Md}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as vu,TOKEN_2022_PROGRAM_ID as As,TOKEN_PROGRAM_ID as pn}from"@solana/spl-token";var Bd=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),ZI=Buffer.from("amm_config","utf8"),xd=Buffer.from("pool","utf8"),Sd=Buffer.from("pool_lp_mint","utf8"),Kd=Buffer.from("pool_vault","utf8"),Cd=Buffer.from("observation","utf8");function Xn(o){return le([Bd],o)}function ws(o,e,t,n){return le([xd,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function Rd(o,e){return le([Sd,e.toBuffer()],o)}function _u(o,e,t){return le([Kd,e.toBuffer(),t.toBuffer()],o)}function Go(o,e){return le([Cd,e.toBuffer()],o)}function Vu({poolId:o,programId:e,configId:t,mintA:n,mintB:i}){let r=Xn(e).publicKey,s=o||ws(e,t,n,i).publicKey,a=Rd(e,s).publicKey,u=_u(e,s,n).publicKey,c=_u(e,s,i).publicKey,l=Go(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:u,vaultB:c,observationId:l}}var Ld=Buffer.from("locked_liquidity","utf8");function Xo(o,e){return le([Ld,e.toBuffer()],o)}var Nd=ue("Raydium_cpmm"),Cn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Eu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f,y,b,g,P,w){let k=E([A("amountMaxA"),A("amountMaxB"),A("openTime")]),I=ws(o,t,r,s).publicKey,h=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:vu,isSigner:!1,isWritable:!1},{pubkey:br,isSigner:!1,isWritable:!1},{pubkey:pt,isSigner:!1,isWritable:!1}],S=Buffer.alloc(k.span);return k.encode({amountMaxA:g,amountMaxB:P,openTime:w},S),new Kn({keys:h,programId:o,data:Buffer.from([...Cn.initialize,...S])})}function Fu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f){let y=E([A("lpAmount"),A("amountMaxA"),A("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:As,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(y.span);return Nd.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:f.toString()}),y.encode({lpAmount:d,amountMaxA:p,amountMaxB:f},g),new Kn({keys:b,programId:o,data:Buffer.from([...Cn.deposit,...g])})}function Du(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f){let y=E([A("lpAmount"),A("amountMinA"),A("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:As,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:rn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);return y.encode({lpAmount:d,amountMinA:p,amountMinB:f},g),new Kn({keys:b,programId:o,data:Buffer.from([...Cn.withdraw,...g])})}function zo(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f,y){let b=E([A("amountIn"),A("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountIn:f,amounOutMin:y},P),new Kn({keys:g,programId:o,data:Buffer.from([...Cn.swapBaseInput,...P])})}function Wu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f,y){let b=E([A("amountInMax"),A("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountInMax:f,amountOut:y},P),new Kn({keys:g,programId:o,data:Buffer.from([...Cn.swapBaseOutput,...P])})}async function qu(o){var y;let{ownerInfo:e,poolInfo:t,poolKeys:n,getEphemeralSigners:i}=o,r=[],[s,a]=[new _i(t.id),new _i(t.lpMint.address)],u;if(i)u=new _i((await i(1))[0]);else{let b=Od.generate();r.push(b),u=b.publicKey}let{publicKey:c}=ce(e.feePayer,u,pn),{publicKey:l}=wn(u),{publicKey:m}=Xo(o.lockProgram,u),{publicKey:d}=ce(e.feePayer,a,pn),{publicKey:p}=ce(o.lockAuthProgram,a,pn),f=_d({programId:o.lockProgram,auth:o.lockAuthProgram,payer:e.feePayer,nftOwner:e.feePayer,liquidityOwner:e.feePayer,nftMint:u,nftAccount:c,poolId:s,lockPda:m,mintLp:a,userLpVault:d,lockLpVault:p,poolVaultA:new _i(n.vault.A),poolVaultB:new _i(n.vault.B),metadataAccount:l,lpAmount:o.lpAmount,withMetadata:(y=o.withMetadata)!=null?y:!0});return{address:{nftMint:u,nftAccount:c,metadataAccount:l,lockPda:m,userLpVault:d,lockLpVault:p},instructions:[f],signers:r,instructionTypes:[v.CpmmLockLp],lookupTableAddress:[]}}function _d({programId:o,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:r,nftAccount:s,poolId:a,lockPda:u,mintLp:c,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:f,lpAmount:y,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:pt,isSigner:!1,isWritable:!1},{pubkey:Md.programId,isSigner:!1,isWritable:!1},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:vu,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1}],P=E([A("lpAmount"),De("withMetadata")]),w=Buffer.alloc(P.span);P.encode({lpAmount:y,withMetadata:b},w);let k=Buffer.from([...Cn.lockCpLiquidity,...w]);return new Kn({keys:g,programId:o,data:k})}function Uu({programId:o,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:r,mintLp:s,userVaultA:a,userVaultB:u,poolVaultA:c,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:f,cpmmProgram:y,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:y!=null?y:so,isSigner:!1,isWritable:!1},{pubkey:b!=null?b:da,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:As,isSigner:!1,isWritable:!1},{pubkey:rn,isSigner:!1,isWritable:!1}],P=E([A("lpFeeAmount")]),w=Buffer.alloc(P.span);P.encode({lpFeeAmount:f},w);let k=Buffer.from([...Cn.collectCpFee,...w]);return new Kn({keys:g,programId:o,data:k})}var Gu=E([ye(8),G("bump"),De("disableCreatePool"),Xt("index"),A("tradeFeeRate"),A("protocolFeeRate"),A("fundFeeRate"),A("createPoolFee"),K("protocolOwner"),K("fundOwner"),j(A(),16)]),Qo=E([ye(8),K("configId"),K("poolCreator"),K("vaultA"),K("vaultB"),K("mintLp"),K("mintA"),K("mintB"),K("mintProgramA"),K("mintProgramB"),K("observationId"),G("bump"),G("status"),G("lpDecimals"),G("mintDecimalA"),G("mintDecimalB"),A("lpAmount"),A("protocolFeesMintA"),A("protocolFeesMintB"),A("fundFeesMintA"),A("fundFeesMintB"),A("openTime"),j(A(),32)]);var Vi=class extends Be{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await qe(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),i={},r=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Qo.decode(d.accountInfo.data);i[String(e[m])]=D(L({},p),{programId:d.accountInfo.owner}),r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...r],d=await qe(this.scope.connection,m.map(p=>({pubkey:new z(p)})));for(let p=0;p<m.length;p++){let f=d[p].accountInfo;if(f===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Gu.decode(f.data)}}let u={},c=await qe(this.scope.connection,s.map(m=>({pubkey:new z(m)})));for(let m=0;m<s.length;m++){let d=c[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);u[String(s[m])]=new Le(Vd.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=u[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),f=u[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=D(L({},d),{baseReserve:p,quoteReserve:f,vaultAAmount:u[d.vaultA.toString()],vaultBAmount:u[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new M(f.toString()).div(new M(10).pow(d.mintDecimalB)).div(new M(p.toString()).div(new M(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var u,c,l,m;let r=e[i],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return D(L({},n),{[i]:D(L({},r),{id:new z(i),configInfo:r.configInfo,version:7,authority:Xn(r.programId).publicKey,mintA:Je({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:(u=t[s])!=null&&u.feeConfig?mn((c=t[s])==null?void 0:c.feeConfig):void 0}}),mintB:Je({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?mn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await Mn({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=Je({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?mn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=Je({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?mn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=Je({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:_t.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},u={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new M(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new M(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:u,week:u,month:u,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Xn(t.programId).publicKey.toBase58(),mintLp:s,config:a},rpcData:t}}async createPool(d){var p=d,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:u,feeConfig:c,computeBudgetConfig:l}=p,m=Ne(p,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig"]);var X,q,W;let f=r.feePayer||((X=this.scope.owner)==null?void 0:X.publicKey),y=new Le(new z(m.mintA.address).toBuffer()).lte(new Le(new z(m.mintB.address).toBuffer())),[b,g]=y?[m.mintA,m.mintB]:[m.mintB,m.mintA],[P,w]=y?[m.mintAAmount,m.mintBAmount]:[m.mintBAmount,m.mintAAmount],k=r.useSOLBalance&&b.address===Yo.toBase58(),I=r.useSOLBalance&&g.address===Yo.toBase58(),[h,S]=[new z(b.address),new z(g.address)],B=this.createTxBuilder(),{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:f,amount:P}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:s,checkCreateATAOwner:a});B.addInstruction(x||{});let{account:R,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({mint:new z(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:I?{payer:f,amount:w}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:s,checkCreateATAOwner:a});if(B.addInstruction(F||{}),C===void 0||R===void 0)throw Error("you don't has some token account");let O=Vu({poolId:e,programId:t,configId:new z(c.id),mintA:h,mintB:S});return B.addInstruction({instructions:[Eu(t,this.scope.ownerPubKey,new z(c.id),O.authority,O.poolId,h,S,O.lpMint,C,R,ce(this.scope.ownerPubKey,O.lpMint).publicKey,O.vaultA,O.vaultB,n,new z((q=b.programId)!=null?q:_t),new z((W=g.programId)!=null?W:_t),O.observationId,P,w,i)],instructionTypes:[v.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.versionBuild({txVersion:u,extInfo:{address:D(L({},O),{mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:c})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:u,config:c,txVersion:l}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:m}=this.scope,{bypassAssociatedCheck:d,checkCreateATAOwner:p}=L({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),f=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:y,inputAmountFee:b,anotherAmount:g}=a||this.computePairAmount({poolInfo:D(L({},t),{lpAmount:new M(f.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:f.baseReserve,quoteReserve:f.quoteReserve,slippage:new Ue(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new M(i.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),P=g.amount,w=t.mintA.address===Yo.toString(),k=t.mintB.address===Yo.toString(),I=this.createTxBuilder(),[h,S]=[new z(t.mintA.address),new z(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:w||(r?i:P).isZero()?{payer:this.scope.ownerPubKey,amount:r?i:P}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(C||{});let{account:x,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(r?P:i).isZero()?{payer:this.scope.ownerPubKey,amount:r?P:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(R||{}),!B&&!x&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",m.tokenAccounts);let F=await m.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),Se=await m.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:F,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:O}=Se,X=Ne(Se,["tokenAccount"]);I.addInstruction(X);let q=n!=null?n:await this.getCpmmPoolKeys(t.id),W=new Ue(new Le(1)).sub(s);return I.addInstruction({instructions:[Fu(new z(t.programId),this.scope.ownerPubKey,new z(q.authority),new z(t.id),O,B,x,new z(q.vault.A),new z(q.vault.B),h,S,new z(t.lpMint.address),a?a==null?void 0:a.liquidity:W.mul(y).quotient,r?b.amount:P,r?P:b.amount)],instructionTypes:[v.CpmmAddLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),I.addCustomComputeBudget(u),I.versionBuild({txVersion:l})}async withdrawLiquidity(e){var O,X;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:r,computeBudgetConfig:s,txVersion:a}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let u=new Ue(new Le(1)).sub(r),c=await this.getRpcPoolInfo(t.id),[l,m]=[u.mul(i.mul(c.baseReserve).div(c.lpAmount)).quotient,u.mul(i.mul(c.quoteReserve).div(c.lpAmount)).quotient],d=await this.scope.fetchEpochInfo(),[p,f]=[ge(l,t.mintA.extensions.feeConfig,d,!1),ge(m,t.mintB.extensions.feeConfig,d,!1)],{account:y}=this.scope,b=this.createTxBuilder(),[g,P]=[new z(t.mintA.address),new z(t.mintB.address)],w=g.equals(H),k=P.equals(H),I,h,{account:S,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:!w,checkCreateATAOwner:!1});I=S,B&&b.addInstruction(B);let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:!k,checkCreateATAOwner:!1});h=C,x&&b.addInstruction(x),(!I||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let R=await y.getCreatedTokenAccount({mint:new z(t.lpMint.address)});R||this.logAndCreateError("cannot found lp token account","tokenAccounts",y.tokenAccounts);let F=n!=null?n:await this.getCpmmPoolKeys(t.id);return b.addInstruction({instructions:[Du(new z(t.programId),this.scope.ownerPubKey,new z(F.authority),new z(t.id),R,I,h,new z(F.vault.A),new z(F.vault.B),g,P,new z(t.lpMint.address),i,l.sub((O=p.fee)!=null?O:new Le(0)),m.sub((X=f.fee)!=null?X:new Le(0)))],instructionTypes:[v.CpmmWithdrawLiquidity],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),b.addCustomComputeBudget(s),b.versionBuild({txVersion:a})}async swap(e){var C,x,R,F,O,X;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:r,inputAmount:s,swapResult:a,slippage:u=0,config:c,computeBudgetConfig:l,txVersion:m}=e,{bypassAssociatedCheck:d,checkCreateATAOwner:p,associatedOnly:f}=L({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},c),y=this.createTxBuilder(),[b,g]=[new z(t.mintA.address),new z(t.mintB.address)];r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Le((1+u)*1e4)).div(new Le(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Le((1-u)*1e4)).div(new Le(1e4));let P=t.mintA.address===H.toBase58(),w=t.mintB.address===H.toBase58(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:b,tokenProgram:new z((C=t.mintA.programId)!=null?C:_t),owner:this.scope.ownerPubKey,createInfo:P||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:f,checkCreateATAOwner:p});I&&y.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:g,tokenProgram:new z((x=t.mintB.programId)!=null?x:_t),owner:this.scope.ownerPubKey,createInfo:w||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:f,checkCreateATAOwner:p});S&&y.addInstruction(S),(!k||!h)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:k,mintBTokenAcc:h,mintAUseSOLBalance:P,mintBUseSOLBalance:w,associatedOnly:f});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return y.addInstruction({instructions:[r?Wu(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),i?k:h,i?h:k,new z(B.vault[i?"A":"B"]),new z(B.vault[i?"B":"A"]),new z((O=t[i?"mintA":"mintB"].programId)!=null?O:_t),new z((X=t[i?"mintB":"mintA"].programId)!=null?X:_t),i?b:g,i?g:b,Go(new z(t.programId),new z(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):zo(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),i?k:h,i?h:k,new z(B.vault[i?"A":"B"]),new z(B.vault[i?"B":"A"]),new z((R=t[i?"mintA":"mintB"].programId)!=null?R:_t),new z((F=t[i?"mintB":"mintA"].programId)!=null?F:_t),i?b:g,i?g:b,Go(new z(t.programId),new z(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?v.CpmmSwapBaseOut:v.ClmmSwapBaseIn]}),y.addCustomComputeBudget(l),y.versionBuild({txVersion:m})}async lockLp(e){var c,l,m,d,p;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txVersion:r}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let s=this.createTxBuilder(),a=(c=e.poolKeys)!=null?c:await this.getCpmmPoolKeys(t.id),u=await qu({poolInfo:t,poolKeys:a,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(l=e.feePayer)!=null?l:this.scope.ownerPubKey},lockProgram:(m=e.programId)!=null?m:ao,lockAuthProgram:(d=e.authProgram)!=null?d:uo,lpAmount:n,withMetadata:(p=e.withMetadata)!=null?p:!0,getEphemeralSigners:e.getEphemeralSigners});return s.addInstruction(u),s.addCustomComputeBudget(i),s.versionBuild({txVersion:r,extInfo:u.address})}async harvestLockLp(e){var x;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:r=ao,authProgram:s=uo,cpmmProgram:a,computeBudgetConfig:u,txVersion:c}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let l=e.feePayer||this.scope.ownerPubKey,m=this.createTxBuilder(),[d,p]=[new z(t.mintA.address),new z(t.mintB.address)],f=d.equals(H),y=p.equals(H),b,g,{account:P,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:!f,checkCreateATAOwner:!1});b=P,w&&m.addInstruction(w);let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:!y,checkCreateATAOwner:!1});g=k,I&&m.addInstruction(I),(!b||!g)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:b,tokenAccountB:g});let h=(x=e.poolKeys)!=null?x:await this.getCpmmPoolKeys(t.id),{publicKey:S}=ce(l,i,_t),{publicKey:B}=Xo(r,i),{publicKey:C}=ce(s,new z(t.lpMint.address),_t);return m.addInstruction({instructions:[Uu({programId:r!=null?r:ao,nftOwner:this.scope.ownerPubKey,auth:s!=null?s:uo,nftMint:i,nftAccount:S,lockPda:B,poolId:new z(t.id),mintLp:new z(h.mintLp.address),userVaultA:b,userVaultB:g,poolVaultA:new z(h.vault.A),poolVaultB:new z(h.vault.B),mintA:d,mintB:p,lockLpVault:C,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[v.CpmmCollectLockFee]}),m.addCustomComputeBudget(u),m.versionBuild({txVersion:c})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let r=n.toString()===e.mintB.address,s=Uo.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new M(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),u=s.destinationAmountSwapped.mul(new Le((1-i)*1e4)).div(new Le(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:u,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:r,epochInfo:s,baseIn:a}){var k,I,h,S,B,C,x,R,F;let u=1-Number(r.toSignificant())/100,c=new Le(new M(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(u).toFixed(0)),l=ge(c,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=c.sub((k=l.fee)!=null?k:new Le(0)),d=new Le(new M(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,M.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",c.toString(),"amountInFee:",(h=(I=l.fee)==null?void 0:I.toString())!=null?h:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let f=m.mul(d).div(p==="base"?t:n),y={amount:ct,fee:void 0,expirationTime:void 0};if(!m.isZero()){let O=vd(f,t,n,d);this.logDebug("lpAmountData:",{amountA:O.amountA.toString(),amountB:O.amountB.toString()}),y=ge(O[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Ue(new Le(1)).add(r),g=new Ue(new Le(1)).sub(r),P=ge(b.mul(y.amount.sub((S=y.fee)!=null?S:new Le(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),w=ge(g.mul(y.amount.sub((B=y.fee)!=null?B:new Le(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",y.amount.toString(),"anotherAmountFee:",(x=(C=y.fee)==null?void 0:C.toString())!=null?x:0,"maxAnotherAmount:",P.amount.toString(),"maxAnotherAmountFee:",(F=(R=P.fee)==null?void 0:R.toString())!=null?F:0),{inputAmountFee:l,anotherAmount:y,maxAnotherAmount:P,minAnotherAmount:w,liquidity:f}}};function vd(o,e,t,n){let i=o.mul(e).div(n);!i.isZero()&&!o.mul(e).mod(n).isZero()&&(i=i.add(new Le(1)));let r=o.mul(t).div(n);return!r.isZero()&&!o.mul(t).mod(n).isZero()&&(r=r.add(new Le(1))),{amountA:i,amountB:r}}import{PublicKey as Ln}from"@solana/web3.js";import{createTransferInstruction as Hu,TOKEN_PROGRAM_ID as Oe,TOKEN_2022_PROGRAM_ID as Zo}from"@solana/spl-token";import $o from"bn.js";var Xu={[hr.toBase58()]:3},zu={3:hr};var Ps=E([ye(5),ye(8),K("ownAddress"),A("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),K("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),ye(7)]),Qu={3:Ps};import{PublicKey as Yu}from"@solana/web3.js";var jo=ue("Serum"),Ho=class{static getProgramId(e){let t=zu[e];return t||jo.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Xu[t];return n||jo.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Qu[e];return t||jo.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,r;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));r=Yu.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:r,nonce:i}}return jo.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Yu.default,nonce:i}}};import{PublicKey as te,SystemProgram as Ed,TransactionInstruction as Fd}from"@solana/web3.js";import Rn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Dd,TOKEN_2022_PROGRAM_ID as Wd,TOKEN_PROGRAM_ID as qd}from"@solana/spl-token";function Ud(o,e,t,n,i,r,s,a,u,c,l,m,d,p,f){var h;let y=[],b=[T({pubkey:qd,isWritable:!1}),T({pubkey:Wd,isWritable:!1}),T({pubkey:Dd,isWritable:!1}),T({pubkey:Ed.programId,isWritable:!1}),T({pubkey:e,isSigner:!0})];b.push(T({pubkey:t})),b.push(T({pubkey:i}));let g=[u,c],P=[l,m],w=[r,s,a];for(let S=0;S<g.length;S++){let B=g[S],C=w[S]===B.mintA.address;if(b.push(T({pubkey:new te(B.programId),isWritable:!1})),S===g.length-1?b.push(T({pubkey:i})):b.push(T({pubkey:n})),b.push(T({pubkey:new te(w[S])})),b.push(T({pubkey:new te(w[S+1])})),B.version===6){let x=P[S];b.push(T({pubkey:new te(x.config.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(C?x.vault.A:x.vault.B)})),b.push(T({pubkey:new te(C?x.vault.B:x.vault.A)})),b.push(T({pubkey:new te(B.observationId)})),b.push(T({pubkey:rn})),b.push(T({pubkey:je(new te(B.programId),new te(B.id)).publicKey})),y.push(Gd(B.sqrtPriceX64.toString(),C));for(let R of(h=f[S])!=null?h:[])b.push(T({pubkey:new te(R)}))}else if(B.version===5){let x=P[S];b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.authority),isWritable:!1})),b.push(T({pubkey:new te(x.marketProgramId)})),b.push(T({pubkey:new te(x.marketAuthority)})),b.push(T({pubkey:la,isWritable:!1})),b.push(T({pubkey:new te(x.openOrders)})),b.push(T({pubkey:new te(x.vault.A)})),b.push(T({pubkey:new te(x.vault.B)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.marketId)})),b.push(T({pubkey:new te(x.marketBids)})),b.push(T({pubkey:new te(x.marketAsks)})),b.push(T({pubkey:new te(x.marketEventQueue)})),b.push(T({pubkey:new te(x.marketBaseVault)})),b.push(T({pubkey:new te(x.marketQuoteVault)}))}else if(B.version===4){let x=P[S],R=B.status!==1;b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(x.authority),isWritable:!1})),b.push(T({pubkey:new te(R?x.id:x.marketProgramId)})),b.push(T({pubkey:new te(R?x.id:x.marketAuthority)})),b.push(T({pubkey:new te(R?x.id:x.openOrders)})),b.push(T({pubkey:new te(x.vault.A)})),b.push(T({pubkey:new te(x.vault.B)})),b.push(T({pubkey:new te(R?x.id:x.marketId)})),b.push(T({pubkey:new te(R?x.id:x.marketBids)})),b.push(T({pubkey:new te(R?x.id:x.marketAsks)})),b.push(T({pubkey:new te(R?x.id:x.marketEventQueue)})),b.push(T({pubkey:new te(R?x.id:x.marketBaseVault)})),b.push(T({pubkey:new te(R?x.id:x.marketQuoteVault)}))}else if(B.version===7){let x=P[S];b.push(T({pubkey:new te(x.authority)})),b.push(T({pubkey:new te(x.config.id)})),b.push(T({pubkey:new te(x.id)})),b.push(T({pubkey:new te(C?x.vault.A:x.vault.B)})),b.push(T({pubkey:new te(C?x.vault.B:x.vault.A)})),b.push(T({pubkey:new te(B.observationId)}))}else throw Error("pool type error")}let k=E([G("insId"),A("amountIn"),A("amountOut"),j(J(),y.length,"clmmPriceLimit")]),I=Buffer.alloc(k.span);return k.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:y},I),new Fd({keys:b,programId:o,data:I})}function Gd(o,e){if(o)if(e){let t=new Rn(o).div(new Rn(25));return t.gt(xo)?t:xo}else{let t=new Rn(o).mul(new Rn(25));return t.lt(So)?t:So}else return e?xo:So}function ju({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var i,r,s,a,u,c,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Qe(m),p=t.equals(d.mintA.address)?ht.add(yt):Tt.sub(yt);return Ae.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((r=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?r:new Rn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[zo(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new te(m[d?"mintA":"mintB"].address),new te(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?v.CpmmSwapBaseIn:v.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[No({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((u=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?u:new Rn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?v.AmmV5SwapBaseIn:v.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],f=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Ud(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,f,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(c=n.minAmountOut.fee)==null?void 0:c.raw)!=null?l:new Rn(0)),n.remainingAccounts)],instructionTypes:[v.RouteSwap],lookupTableAddress:[p.lookupTableAccount,f.lookupTableAccount].filter(y=>y!==void 0),address:{}}}else throw Error("route type error")}var Zt=new $o(0),vi=class extends Be{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(H));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1}=e,r=await this.getWSolAccounts(),s=this.createTxBuilder();s.addCustomComputeBudget(e.computeBudgetConfig);let a=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});s.addInstruction(a);let u=Z(t);for(let c=0;c<r.length;c++)u.gte(r[c].amount)?(s.addInstruction({instructions:[zt({tokenAccount:r[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(r[c].amount)):s.addInstruction({instructions:[zt({tokenAccount:r[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return s.versionBuild({txVersion:i})}async wrapWSol(e,t,n){let i=this.createTxBuilder(),r=await Qt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(r),i.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:r,txVersion:s}){let a=this.createTxBuilder(),u=e.amountIn,c=e.amountOut,l=u.amount.token.mint.equals(H),m=c.amount.token.mint.equals(H),d=u.amount.token.mint,p=c.amount.token.mint,{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Zo:Oe,mint:d,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:l?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(y&&a.addInstruction(y),f===void 0)throw Error("input account check error");let b;if(e.routeType==="route")b=this.scope.account.getAssociatedTokenAccount(p,c.amount.token.isToken2022?Zo:Oe);else{let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?Zo:Oe,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});b=k,I&&a.addInstruction(I)}m&&a.addInstruction({endInstructions:[zt({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:b,programId:Oe})],endInstructionTypes:[v.CloseAccount]});let g;if(e.routeType==="route"){let k=e.middleToken;g=this.scope.account.getAssociatedTokenAccount(k.mint,k.isToken2022?Zo:Oe)}let P=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),w=ju({routeProgram:r,inputMint:d,swapInfo:D(L({},e),{poolInfo:[...e.poolInfoList],poolKey:P,outputMint:p}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:g,destinationToken:b}});if(e.feeConfig!==void 0){let k=this.createTxBuilder();k.addInstruction({instructions:[Hu(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[v.TransferAmount]}),k.addInstruction(w);let{transactions:I}=s===0?await k.sizeCheckBuildV0():await k.sizeCheckBuild();I.length<2&&a.addInstruction({instructions:[Hu(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[v.TransferAmount]})}return a.addInstruction(w),s===0?a.sizeCheckBuildV0({computeBudgetConfig:i,address:w.address}):a.sizeCheckBuild({computeBudgetConfig:i,address:w.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=oo,clmm:n=bn,cpmm:i=so}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Mo.offsetOf("baseMint"),length:64}}),s=E([K("baseMint"),K("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),u=E([K("mintA"),K("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:kn.span}],dataSlice:{offset:kn.offsetOf("mintA"),length:64}})).map(p=>{let f=u.decode(p.account.data);return{id:p.pubkey,version:6,mintA:f.mintA,mintB:f.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:Qo.offsetOf("mintA"),length:64}})).map(p=>{let f=u.decode(p.account.data);return{id:p.pubkey,version:7,mintA:f.mintA,mintB:f.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:r}){e=e.toString()===Ln.default.toString()?H:e,t=t.toString()===Ln.default.toString()?H:t;let s={},a={},u={},c=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),u[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Oe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let f of p.in)for(let y of p.out)f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&u[f.id.toString()]===void 0?u[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f),y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&u[y.id.toString()]===void 0?u[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y)}return{directPath:c,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(u)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(y=>[y.mintA.toBase58(),y.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(y=>y.id)),s=Vo(r),a={};Object.values(s).forEach(y=>{i.delete(y.mintA.address),a[y.mintA.address]={address:new Ln(y.mintA.address),programId:Oe,mintAuthority:null,supply:BigInt(0),decimals:y.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(y.mintB.address),a[y.mintB.address]={address:new Ln(y.mintB.address),programId:Oe,mintAuthority:null,supply:BigInt(0),decimals:y.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let u=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(y=>y.id.toBase58()),!0);Object.values(u).forEach(y=>{let[b,g]=[y.mintA.toBase58(),y.mintB.toBase58()];y.mintProgramA.equals(Oe)?(i.delete(b),a[b]={address:y.mintA,programId:y.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(b),y.mintProgramB.equals(Oe)?(i.delete(g),a[g]={address:y.mintB,programId:y.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let c=await Mn({connection:this.scope.connection,mints:Array.from(i).map(y=>new Ln(y))});a=L(L({},a),c);let l=this.scope.cpmm.toComputePoolInfos({pools:u,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(y=>y.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),f=Object.keys(e.routePathDict).reduce((y,b)=>D(L({},y),{[b]:D(L({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:f}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:r,tickCache:s,slippage:a,chainTime:u,epochInfo:c,feeConfig:l}){var g,P,w,k,I,h,S,B,C;let m=l===void 0?new $o(0):e.raw.mul(new $o(l.feeBps.toNumber())).div(new $o(1e4)),d=e.raw.sub(m),p=new be(e.token,d),f=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},y=D(L({},t),{address:dt(t.address).toString()}),b=[];for(let x of n)try{b.push(D(L({},this.computeAmountOut({itemPool:x,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:y,amountIn:p})),{feeConfig:f}))}catch(R){this.logDebug("direct error",x.version,x.id.toString(),R.message)}this.logDebug("direct done");for(let[x,R]of Object.entries(i)){let F={chainId:101,address:x,programId:R.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:R.mDecimals,tags:[],extensions:{}},O=R.in.map(q=>{try{return{pool:q,data:this.computeAmountOut({itemPool:q,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:F,amountIn:p})}}catch(W){this.logDebug("route in error",q.version,q.id.toString(),W.message);return}}).sort((q,W)=>{var Me,ot,rt,mt;let Se=q===void 0?Zt:q.data.amountOut.amount.raw.sub((ot=(Me=q.data.amountOut.fee)==null?void 0:Me.raw)!=null?ot:Zt),Vt=W===void 0?Zt:W.data.amountOut.amount.raw.sub((mt=(rt=W.data.amountOut.fee)==null?void 0:rt.raw)!=null?mt:Zt);return Se.lt(Vt)?1:-1})[0];if(O===void 0)continue;let X=new be(Lo(F),O.data.amountOut.amount.raw.sub((P=(g=O.data.amountOut.fee)==null?void 0:g.raw)!=null?P:Zt));for(let q of R.out)try{let W=this.computeAmountOut({itemPool:q,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:y,amountIn:X});b.push(D(L({},W),{allTrade:!!(O.data.allTrade&&W.allTrade),amountIn:O.data.amountIn,amountOut:W.amountOut,minAmountOut:W.minAmountOut,currentPrice:void 0,executionPrice:new M(new ut({baseToken:O.data.amountIn.amount.token,denominator:O.data.amountIn.amount.raw,quoteToken:W.amountOut.amount.token,numerator:W.amountOut.amount.raw.sub((k=(w=W.amountOut.fee)==null?void 0:w.raw)!=null?k:Zt)}).toFixed()),priceImpact:new M(O.data.priceImpact.add(W.priceImpact).toFixed()),fee:[O.data.fee[0],W.fee[0]],routeType:"route",poolInfoList:[O.pool,q],remainingAccounts:[O.data.remainingAccounts[0],W.remainingAccounts[0]],minMiddleAmountFee:(I=W.amountOut.fee)!=null&&I.raw?new be(O.data.amountOut.amount.token,((S=(h=O.data.amountOut.fee)==null?void 0:h.raw)!=null?S:Zt).add((C=(B=W.amountOut.fee)==null?void 0:B.raw)!=null?C:Zt)):void 0,middleToken:O.data.amountOut.amount.token,poolReady:O.data.poolReady&&W.poolReady,poolType:[O.data.poolType,W.poolType],feeConfig:f,expirationTime:Rt(O.data.expirationTime,W.expirationTime)}))}catch(W){this.logDebug("route out error",q.version,q.id.toString(),W.message)}}return b.filter(x=>(x.allTrade||this.logDebug(`pool ${x.poolInfoList.map(R=>R.id.toString()).join(",")} filter out since not all trade`),x.allTrade)).sort((x,R)=>x.amountOut.amount.raw.sub(R.amountOut.amount.raw).gt(Zt)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:r,slippage:s,outputToken:a,amountIn:u}){if(e.version===6){let{allTrade:c,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:f,executionPrice:y,priceImpact:b,fee:g,remainingAccounts:P,executionPriceX64:w}=Re.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:u.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:c,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new M(f.toFixed()),executionPrice:new M(y.toFixed()),priceImpact:new M(b.toFixed()),fee:[g],remainingAccounts:[P],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[w],expirationTime:Rt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:c,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:f}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:u.raw,slippage:s});return{allTrade:c,amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:xi(D(L({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xi(D(L({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new be(u.token,f)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:c,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:f}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:u.raw,mintIn:u.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:xi(D(L({},a),{amount:c})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xi(D(L({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new be(u.token,f)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(c=>c.version===6&&!t[c.id.toString()]).map(c=>c.id.toString()));if(i.size>0){let c=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(c).forEach(l=>{t[l]=c[l]})}if(new Set(e.filter(c=>c.version===4&&!n[c.id.toString()]).map(c=>c.id.toString())).size>0){let c=await this.scope.liquidity.getRpcPoolInfos(Array.from(i));Object.keys(c).forEach(l=>{n[l]=c[l]})}let s=new Set(e.filter(c=>c.version===4).map(c=>c.marketId)),a={};s.size>0&&(await qe(this.scope.connection,Array.from(s).map(l=>({pubkey:new Ln(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=Ps.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Ho.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let u=[];return e.forEach(c=>{if(c.version===6){let l=t[c.id.toString()],m={programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:D(L({},c.ammConfig),{id:c.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[]};u.push(m)}else if(c.version===4){let l=n[c.id.toString()],m=L({programId:c.programId,id:c.id,mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:ps({programId:new Ln(c.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:c.lpMint},a[c.marketId]);u.push(m)}else c.version===7&&u.push({programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),authority:Xn(c.programId).publicKey.toBase58(),vault:{A:c.vaultA.toBase58(),B:c.vaultB.toBase58()},mintLp:Je({address:c.mintLp.toBase58(),programId:Oe.toBase58(),decimals:c.lpDecimals}),config:D(L({id:c.configId.toBase58()},c.configInfo),{protocolFeeRate:c.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:c.configInfo.tradeFeeRate.toNumber(),fundFeeRate:c.configInfo.fundFeeRate.toNumber(),createPoolFee:c.configInfo.createPoolFee.toString()})})}),u}};import{PublicKey as Xd,Transaction as ks,TransactionInstruction as zd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Qd}from"@solana/spl-token";import Zu from"bn.js";var et=class extends Be{static getPdaPoolId(e,t){return le([et.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return le([et.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Zu(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>et.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<et.VERSION_PROJECT.length;l++)a.push(...s.map(m=>et.getPdaOwnerId(t,m,i,l).publicKey));let u=await Bt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],f=a[l],y=u[d],b=u[n.length+l];if(!(y&&b)||y.data.length!==et.POOL_LAYOUT.span||b.data.length!==et.OWNER_LAYOUT.span)continue;let g=et.POOL_LAYOUT.decode(y.data),P=et.OWNER_LAYOUT.decode(b.data),w=g.openTime.toNumber(),k=g.endTime.toNumber(),I=P.tokenInfo.map(B=>B.debtAmount.gt(new Zu(0))).filter(B=>!B).length!==3,h=r>w&&r<k&&g.status===1,S=I&&h;c.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:f,snapshotLpAmount:P.lpAmount,project:et.VERSION_PROJECT[m],openTime:w,endTime:k,canClaim:S,canClaimErrorType:I?h?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((B,C)=>({mintAddress:B.mintAddress,mintVault:B.mintVault,mintDecimals:B.mintDecimals,perLpLoss:B.perLpLoss,debtAmount:P.tokenInfo[C].debtAmount.add(P.tokenInfo[C].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,r=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ie.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(Ie.WSOL.mint),associatedOnly:u.mintAddress.equals(Ie.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),r.push(c)}n.addInstruction({instructions:[et.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:r}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,r={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Ie.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!m.mintAddress.equals(Ie.WSOL.mint),associatedOnly:m.mintAddress.equals(Ie.WSOL.mint)?!1:t.associatedOnly});p&&n.addInstruction(p),d&&(r[m.mintAddress.toString()]=d,l.push(d))}n.addInstruction({instructions:[et.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:i,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return kr(u,[i,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new ks().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new ks().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new ks().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:Qd,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new zd({keys:r,programId:e,data:a})}},It=et;It.CLAIMED_NUM=3,It.POOL_LAYOUT=E([ye(8),G("bump"),G("status"),A("openTime"),A("endTime"),K("ammId"),j(E([G("mintDecimals"),K("mintAddress"),K("mintVault"),A("perLpLoss"),A("totalClaimedAmount")]),et.CLAIMED_NUM,"tokenInfo"),j(A(),10,"padding")]),It.OWNER_LAYOUT=E([ye(8),G("bump"),G("version"),K("poolId"),K("owner"),A("lpAmount"),j(E([K("mintAddress"),A("debtAmount"),A("claimedAmount")]),et.CLAIMED_NUM,"tokenInfo"),j(A(),4,"padding")]),It.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Xd(e)),It.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},It.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Fi}from"@solana/web3.js";import ec from"bn.js";import{SYSVAR_CLOCK_PUBKEY as jd,TransactionInstruction as $u}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ju}from"@solana/spl-token";var Yd=E([G("instruction"),Ia("amount")]),Ei=E([G("instruction")]);function Jo({programId:o},e){let t=[{pubkey:Ju,isSigner:!1,isWritable:!1},{pubkey:Hs,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,r])=>({pubkey:r,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Ei.span);return Ei.encode({instruction:2},n),new $u({keys:t,programId:o,data:n})}function hs(o){let{poolConfig:e,userKeys:t,side:n}=o,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Ei.span);Ei.encode({instruction:2},s);let a=[{pubkey:Ju,isWritable:!1,isSigner:!1},{pubkey:jd,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new $u({programId:e.programId,keys:a,data:s})}var Hd={[ni.IDO_PROGRAM_ID_V1.toString()]:1,[ni.IDO_PROGRAM_ID_V2.toString()]:2,[ni.IDO_PROGRAM_ID_V3.toString()]:3,[ni.IDO_PROGRAM_ID_V4.toString()]:4},zn=class extends Be{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:r}){let s=this.createTxBuilder(),a=Hd[t.programId];a||this.logAndCreateError("invalid version",a);let u=Qe(t),[c,l]=[!new ec(e.coin).isZero(),!new ec(e.pc).isZero()],m=u.projectInfo.mint.address.equals(H),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:i});!d&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&p&&s.addInstruction(p);let f=u.buyInfo.mint.address.equals(H),{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:i});if(!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!d||!y)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[Jo({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:d,userIdoInfo:new Fi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[Jo({programId:new Fi(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:y,userIdoInfo:new Fi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[Jo({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:y,userBaseTokenAccount:d,userIdoInfo:new Fi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let g={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:y,ledgerAccount:new Fi(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[hs(D(L({},g),{side:"base"}))]:[],...l?[hs(D(L({},g),{side:"quote"}))]:[]]}).versionBuild({txVersion:r})}};import{PublicKey as Zd}from"@solana/web3.js";import{MintLayout as $d,TOKEN_2022_PROGRAM_ID as Ts,TOKEN_PROGRAM_ID as Is}from"@solana/spl-token";var Di=class extends Be{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:r,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),u=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(on.address,on),this._mintGroup.official.add(on.address),s.forEach(c=>{this._blackTokenMap.set(c.address,D(L({},c),{priority:-1}))}),r.forEach(c=>{var l;this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,D(L({},c),{type:"raydium",priority:2,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Ts.toBase58():Is.toBase58()})),this._mintGroup.official.add(c.address))}),u.forEach(c=>{var l;this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,D(L({},c),{type:"jupiter",priority:1,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Ts.toBase58():Is.toBase58(),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags})),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,D(L({},c),{type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?Ts.toBase58():Is.toBase58()})),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return on;let r=(await this.scope.api.getTokenInfo([n]))[0];if(r)return this._mintGroup.extra.add(n),this._tokenMap.set(n,D(L({},r),{priority:2})),r;let s=await this.scope.connection.getAccountInfo(new Zd(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=$d.decode(s.data),u=n.toString().substring(0,6),c={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:u,name:u,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,c),c}};var er=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u,blockhashCommitment:c="confirmed"}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Kt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=c,this.api=r,this._apiCacheTime=u||5*60*1e3,this.logger=ue("Raydium"),this.farm=new gi({scope:this,moduleName:"Raydium_Farm"}),this.account=new ci({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Li({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Di({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new vi({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Mi({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Vi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new It({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Un({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new zn({scope:this,moduleName:"Raydium_ido"}),this.availability={};let l=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:l,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=Jd({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:r,logRequests:s,urlConfigs:a}=t,u=new yo({cluster:n,timeout:i,urlConfigs:a,logCount:r,logRequests:s}),c=new er(D(L({},t),{api:u}));return await c.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await c.token.load({type:e.jupTokenType}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(bo);return this._owner.publicKey}setOwner(e){return this._owner=e?new Kt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(ba);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(bo),new Error(bo)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>D(L({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{er as Raydium};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map