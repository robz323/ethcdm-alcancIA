import { sha256 } from "js-sha256";
import _ from "lodash";
/**
 *  Default is to expire requests 30 seconds from now.
 */
const getDefaultRequestTimestamp = () => Math.floor(Date.now() / 1000) + 30;
export class SwitchboardSecrets {
    url;
    constructor(url) {
        this.url = url ?? "https://api.secrets.switchboard.xyz";
    }
    async getUser(userPubkey, ciphersuite) {
        const url = `${this.url}/user/${userPubkey}/ciphersuite/${ciphersuite}`;
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": Buffer.from(sha256.create().update("test-sig").digest()).toString("hex"),
            },
        });
        if (!response.ok) {
            throw new Error(`getUser failed: ${response.statusText}`);
        }
        const json = await response.json();
        return {
            ciphersuite: json.ciphersuite,
            user_pubkey: json.user_pubkey,
            created_at: new Date(json.created_at),
            updated_at: new Date(json.updated_at),
            contact_info: json.contact_info,
        };
    }
    createOrUpdateUserRequest(
    /**
     *  The address of the user.
     */
    userPubkey, 
    /**
     *  'ed25519' for Solana users, 'ethers' for EVM users.
     */
    ciphersuite, 
    /**
     *  Stringified contact info for the user.
     */
    contactInfo = "", 
    /**
     *  The timestamp that this request expires.
     *
     *  Default: now + 30 seconds.
     */
    expiryTimestamp = getDefaultRequestTimestamp()) {
        return new UpdateUserPayload(userPubkey, ciphersuite, contactInfo, expiryTimestamp);
    }
    async createOrUpdateUser(request, signature) {
        const url = `${this.url}/user`;
        const response = await fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": signature,
            },
            body: request.toString(),
        });
        if (!response.ok) {
            throw new Error(`createOrUpdateUser failed: ${response.statusText}`);
        }
    }
    async getUserSecrets(userPubkey, ciphersuite) {
        const url = `${this.url}/user/${userPubkey}/ciphersuite/${ciphersuite}/secrets`;
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": Buffer.from(sha256.create().update("test-sig").digest()).toString("hex"),
            },
        });
        if (!response.ok) {
            throw new Error(`getUserSecrets failed: ${response.statusText}`);
        }
        const json = await response.json();
        return _.isArray(json)
            ? json
                .map((item) => ({
                secret: item.secret,
                secret_name: item.secret_name,
                created_at: new Date(item.created_at),
                updated_at: new Date(item.updated_at),
                whitelist: _.isArray(item.whitelisted_mrenclaves)
                    ? item.whitelisted_mrenclaves.filter((val) => !!val)
                    : [],
            }))
                .sort((a, b) => b.updated_at.getTime() - a.updated_at.getTime())
            : [];
    }
    createSecretRequest(
    /**
     *  The address of the user.
     */
    userPubkey, 
    /**
     *  'ed25519' for Solana users, 'ethers' for EVM users.
     */
    ciphersuite, 
    /**
     *  The key of the secret.
     *
     *  Keys must be unique per user.
     */
    secretName, 
    /**
     *  The value of the secret.
     */
    secretValue, 
    /**
     *  The timestamp that this request expires.
     *
     *  Default: now + 30 seconds.
     */
    expiryTimestamp = getDefaultRequestTimestamp()) {
        return new CreateSecretPayload(userPubkey, ciphersuite, secretName, secretValue, expiryTimestamp);
    }
    async createSecret(request, signature) {
        const url = `${this.url}/secret`;
        const response = await fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": signature,
            },
            body: request.toString(),
        });
        if (!response.ok) {
            throw new Error(`createSecret failed: ${response.statusText}`);
        }
    }
    createAddMrEnclaveRequest(
    /**
     *  The address of the user.
     */
    userPubkey, 
    /**
     *  'ed25519' for Solana users, 'ethers' for EVM users.
     */
    ciphersuite, 
    /**
     *  The MrEnclave value to add.
     */
    mrEnclave, 
    /**
     *  The names of the secrets to whitelist the MrEnclave value for.
     */
    secretNames, 
    /**
     *  The timestamp that this request expires.
     *
     *  Default: now + 30 seconds.
     */
    expiryTimestamp = getDefaultRequestTimestamp()) {
        return new AddMrEnclavePayload(userPubkey, ciphersuite, mrEnclave, secretNames, expiryTimestamp);
    }
    async addMrEnclave(request, signature) {
        const url = `${this.url}/mrenclave/whitelist`;
        const response = await fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": signature,
            },
            body: request.toString(),
        });
        if (!response.ok) {
            throw new Error(`addMrEnclave failed: ${response.statusText}`);
        }
    }
    createRemoveMrEnclaveRequest(
    /**
     *  The address of the user.
     */
    userPubkey, 
    /**
     *  'ed25519' for Solana users, 'ethers' for EVM users.
     */
    ciphersuite, 
    /**
     *  The mrEnclave value to remove.
     */
    mrEnclave, 
    /**
     *  The timestamp that this request expires.
     *
     *  Default: now + 30 seconds.
     */
    expiryTimestamp = getDefaultRequestTimestamp()) {
        return new RemoveMrEnclavePayload(userPubkey, ciphersuite, mrEnclave, expiryTimestamp);
    }
    async removeMrEnclave(request, signature) {
        const url = `${this.url}/mrenclave/whitelist`;
        const response = await fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": signature,
            },
            body: request.toString(),
        });
        if (!response.ok) {
            throw new Error(`removeMrEnclave failed: ${response.statusText}`);
        }
    }
    createDeleteSecretRequest(
    /**
     *  The address of the user.
     */
    userPubkey, 
    /**
     *  'ed25519' for Solana users, 'ethers' for EVM users.
     */
    ciphersuite, 
    /**
     *  The name fo the secret to delete.
     */
    secretName, 
    /**
     *  The timestamp that this request expires.
     *
     *  Default: now + 30 seconds.
     */
    expiryTimestamp = getDefaultRequestTimestamp()) {
        return new DeleteSecretPayload(userPubkey, ciphersuite, secretName, expiryTimestamp);
    }
    async deleteSecret(request, signature) {
        const url = `${this.url}/secret`;
        const response = await fetch(url, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "X-Signed-Header": signature,
            },
            body: request.toString(),
        });
        if (!response.ok) {
            throw new Error(`deleteSecret failed: ${response.statusText}`);
        }
    }
}
export class UpdateUserPayload {
    user_pubkey;
    ciphersuite;
    contact_info;
    timestamp;
    constructor(user_pubkey, ciphersuite, contact_info, timestamp) {
        this.user_pubkey = user_pubkey;
        this.ciphersuite = ciphersuite;
        this.contact_info = contact_info;
        this.timestamp = timestamp;
    }
    static from(obj) {
        return new UpdateUserPayload(obj.user_pubkey, obj.ciphersuite, obj.contact_info, obj.timestamp);
    }
    toJSON() {
        return {
            user_pubkey: this.user_pubkey,
            ciphersuite: this.ciphersuite,
            contact_info: this.contact_info,
            timestamp: this.timestamp,
        };
    }
    toString() {
        return JSON.stringify(this.toJSON());
    }
    toEncodedMessage() {
        return Buffer.from(sha256.create().update(this.toString()).digest());
    }
}
export class CreateSecretPayload {
    user_pubkey;
    ciphersuite;
    secret_name;
    secret;
    timestamp;
    constructor(user_pubkey, ciphersuite, secret_name, secret, timestamp) {
        this.user_pubkey = user_pubkey;
        this.ciphersuite = ciphersuite;
        this.secret_name = secret_name;
        this.secret = secret;
        this.timestamp = timestamp;
    }
    static from(obj) {
        return new CreateSecretPayload(obj.user_pubkey, obj.ciphersuite, obj.secret_name, obj.secret, obj.timestamp);
    }
    toJSON() {
        return {
            user_pubkey: this.user_pubkey,
            ciphersuite: this.ciphersuite,
            secret: this.secret,
            secret_name: this.secret_name,
            timestamp: this.timestamp,
        };
    }
    toString() {
        return JSON.stringify(this.toJSON());
    }
    toEncodedMessage() {
        return Buffer.from(sha256.create().update(this.toString()).digest());
    }
}
export class AddMrEnclavePayload {
    user_pubkey;
    ciphersuite;
    mr_enclave;
    secret_names;
    timestamp;
    constructor(user_pubkey, ciphersuite, mr_enclave, secret_names, timestamp) {
        this.user_pubkey = user_pubkey;
        this.ciphersuite = ciphersuite;
        this.mr_enclave = mr_enclave;
        this.secret_names = secret_names;
        this.timestamp = timestamp;
    }
    static from(obj) {
        return new AddMrEnclavePayload(obj.user_pubkey, obj.ciphersuite, obj.mr_enclave, obj.secret_names, obj.timestamp);
    }
    toJSON() {
        return {
            user_pubkey: this.user_pubkey,
            ciphersuite: this.ciphersuite,
            mr_enclave: this.mr_enclave,
            secret_names: this.secret_names,
            timestamp: this.timestamp,
        };
    }
    toString() {
        return JSON.stringify(this.toJSON());
    }
    toEncodedMessage() {
        return Buffer.from(sha256.create().update(this.toString()).digest());
    }
}
export class RemoveMrEnclavePayload {
    user_pubkey;
    ciphersuite;
    mr_enclave;
    timestamp;
    constructor(user_pubkey, ciphersuite, mr_enclave, timestamp) {
        this.user_pubkey = user_pubkey;
        this.ciphersuite = ciphersuite;
        this.mr_enclave = mr_enclave;
        this.timestamp = timestamp;
    }
    static from(obj) {
        return new RemoveMrEnclavePayload(obj.user_pubkey, obj.ciphersuite, obj.mr_enclave, obj.timestamp);
    }
    toJSON() {
        return {
            user_pubkey: this.user_pubkey,
            ciphersuite: this.ciphersuite,
            mr_enclave: this.mr_enclave,
            timestamp: this.timestamp,
        };
    }
    toString() {
        return JSON.stringify(this.toJSON());
    }
    toEncodedMessage() {
        return Buffer.from(sha256.create().update(this.toString()).digest());
    }
}
export class DeleteSecretPayload {
    user_pubkey;
    ciphersuite;
    secret_name;
    timestamp;
    constructor(user_pubkey, ciphersuite, secret_name, timestamp) {
        this.user_pubkey = user_pubkey;
        this.ciphersuite = ciphersuite;
        this.secret_name = secret_name;
        this.timestamp = timestamp;
    }
    static from(obj) {
        return new DeleteSecretPayload(obj.user_pubkey, obj.ciphersuite, obj.secret_name, obj.timestamp);
    }
    toJSON() {
        return {
            user_pubkey: this.user_pubkey,
            ciphersuite: this.ciphersuite,
            secret_name: this.secret_name,
            timestamp: this.timestamp,
        };
    }
    toString() {
        return JSON.stringify(this.toJSON());
    }
    toEncodedMessage() {
        return Buffer.from(sha256.create().update(this.toString()).digest());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjcmV0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZWNyZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFDO0FBRXZCOztHQUVHO0FBQ0gsTUFBTSwwQkFBMEIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7QUFrQjVFLE1BQU0sT0FBTyxrQkFBa0I7SUFDcEIsR0FBRyxDQUFTO0lBQ3JCLFlBQW1CLEdBQVk7UUFDN0IsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUkscUNBQXFDLENBQUM7SUFDMUQsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPLENBQ2xCLFVBQWtCLEVBQ2xCLFdBQW1CO1FBRW5CLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsU0FBUyxVQUFVLGdCQUFnQixXQUFXLEVBQUUsQ0FBQztRQUN4RSxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDaEMsTUFBTSxFQUFFLEtBQUs7WUFDYixPQUFPLEVBQUU7Z0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FDNUIsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FDNUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO2FBQ2xCO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixRQUFRLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FB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LEVBQ2YsR0FBRyxDQUFDLFdBQVcsRUFDZixHQUFHLENBQUMsU0FBUyxDQUNkLENBQUM7SUFDSixDQUFDO0lBRU0sTUFBTTtRQUNYLE9BQU87WUFDTCxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7U0FDMUIsQ0FBQztJQUNKLENBQUM7SUFFTSxRQUFRO1FBQ2IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFTSxnQkFBZ0I7UUFDckIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaGEyNTYgfSBmcm9tIFwianMtc2hhMjU2XCI7XG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5cbi8qKlxuICogIERlZmF1bHQgaXMgdG8gZXhwaXJlIHJlcXVlc3RzIDMwIHNlY29uZHMgZnJvbSBub3cuXG4gKi9cbmNvbnN0IGdldERlZmF1bHRSZXF1ZXN0VGltZXN0YW1wID0gKCkgPT4gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCkgKyAzMDtcblxuZXhwb3J0IHR5cGUgU2VjcmV0c0FwaVVzZXIgPSB7XG4gIGNpcGhlcnN1aXRlOiBcImVkMjU1MTlcIjtcbiAgdXNlcl9wdWJrZXk6IHN0cmluZztcbiAgY3JlYXRlZF9hdDogRGF0ZTtcbiAgdXBkYXRlZF9hdDogRGF0ZTtcbiAgY29udGFjdF9pbmZvOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBTZWNyZXRzQXBpU2VjcmV0ID0ge1xuICBjcmVhdGVkX2F0OiBEYXRlO1xuICB1cGRhdGVkX2F0OiBEYXRlO1xuICBzZWNyZXQ6IHN0cmluZztcbiAgc2VjcmV0X25hbWU6IHN0cmluZztcbiAgd2hpdGVsaXN0OiBzdHJpbmdbXTtcbn07XG5cbmV4cG9ydCBjbGFzcyBTd2l0Y2hib2FyZFNlY3JldHMge1xuICByZWFkb25seSB1cmw6IHN0cmluZztcbiAgcHVibGljIGNvbnN0cnVjdG9yKHVybD86IHN0cmluZykge1xuICAgIHRoaXMudXJsID0gdXJsID8/IFwiaHR0cHM6Ly9hcGkuc2VjcmV0cy5zd2l0Y2hib2FyZC54eXpcIjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRVc2VyKFxuICAgIHVzZXJQdWJrZXk6IHN0cmluZyxcbiAgICBjaXBoZXJzdWl0ZTogc3RyaW5nXG4gICk6IFByb21pc2U8U2VjcmV0c0FwaVVzZXI+IHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLnVybH0vdXNlci8ke3VzZXJQdWJrZXl9L2NpcGhlcnN1aXRlLyR7Y2lwaGVyc3VpdGV9YDtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgXCJYLVNpZ25lZC1IZWFkZXJcIjogQnVmZmVyLmZyb20oXG4gICAgICAgICAgc2hhMjU2LmNyZWF0ZSgpLnVwZGF0ZShcInRlc3Qtc2lnXCIpLmRpZ2VzdCgpXG4gICAgICAgICkudG9TdHJpbmcoXCJoZXhcIiksXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZ2V0VXNlciBmYWlsZWQ6ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBqc29uID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgIHJldHVybiB7XG4gICAgICBjaXBoZXJzdWl0ZToganNvbi5jaXBoZXJzdWl0ZSxcbiAgICAgIHVzZXJfcHVia2V5OiBqc29uLnVzZXJfcHVia2V5LFxuICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoanNvbi5jcmVhdGVkX2F0KSxcbiAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKGpzb24udXBkYXRlZF9hdCksXG4gICAgICBjb250YWN0X2luZm86IGpzb24uY29udGFjdF9pbmZvLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlT3JVcGRhdGVVc2VyUmVxdWVzdChcbiAgICAvKipcbiAgICAgKiAgVGhlIGFkZHJlc3Mgb2YgdGhlIHVzZXIuXG4gICAgICovXG4gICAgdXNlclB1YmtleTogc3RyaW5nLFxuICAgIC8qKlxuICAgICAqICAnZWQyNTUxOScgZm9yIFNvbGFuYSB1c2VycywgJ2V0aGVycycgZm9yIEVWTSB1c2Vycy5cbiAgICAgKi9cbiAgICBjaXBoZXJzdWl0ZTogc3RyaW5nLFxuICAgIC8qKlxuICAgICAqICBTdHJpbmdpZmllZCBjb250YWN0IGluZm8gZm9yIHRoZSB1c2VyLlxuICAgICAqL1xuICAgIGNvbnRhY3RJbmZvID0gXCJcIixcbiAgICAvKipcbiAgICAgKiAgVGhlIHRpbWVzdGFtcCB0aGF0IHRoaXMgcmVxdWVzdCBleHBpcmVzLlxuICAgICAqXG4gICAgICogIERlZmF1bHQ6IG5vdyArIDMwIHNlY29uZHMuXG4gICAgICovXG4gICAgZXhwaXJ5VGltZXN0YW1wID0gZ2V0RGVmYXVsdFJlcXVlc3RUaW1lc3RhbXAoKVxuICApOiBVcGRhdGVVc2VyUGF5bG9hZCB7XG4gICAgcmV0dXJuIG5ldyBVcGRhdGVVc2VyUGF5bG9hZChcbiAgICAgIHVzZXJQdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZSxcbiAgICAgIGNvbnRhY3RJbmZvLFxuICAgICAgZXhwaXJ5VGltZXN0YW1wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVPclVwZGF0ZVVzZXIoXG4gICAgcmVxdWVzdDogVXBkYXRlVXNlclBheWxvYWQsXG4gICAgc2lnbmF0dXJlOiBzdHJpbmdcbiAgKSB7XG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy51cmx9L3VzZXJgO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICBtZXRob2Q6IFwiUFVUXCIsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBcIlgtU2lnbmVkLUhlYWRlclwiOiBzaWduYXR1cmUsXG4gICAgICB9LFxuICAgICAgYm9keTogcmVxdWVzdC50b1N0cmluZygpLFxuICAgIH0pO1xuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgY3JlYXRlT3JVcGRhdGVVc2VyIGZhaWxlZDogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRVc2VyU2VjcmV0cyhcbiAgICB1c2VyUHVia2V5OiBzdHJpbmcsXG4gICAgY2lwaGVyc3VpdGU6IHN0cmluZ1xuICApOiBQcm9taXNlPFNlY3JldHNBcGlTZWNyZXRbXT4ge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMudXJsfS91c2VyLyR7dXNlclB1YmtleX0vY2lwaGVyc3VpdGUvJHtjaXBoZXJzdWl0ZX0vc2VjcmV0c2A7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgIG1ldGhvZDogXCJHRVRcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIFwiWC1TaWduZWQtSGVhZGVyXCI6IEJ1ZmZlci5mcm9tKFxuICAgICAgICAgIHNoYTI1Ni5jcmVhdGUoKS51cGRhdGUoXCJ0ZXN0LXNpZ1wiKS5kaWdlc3QoKVxuICAgICAgICApLnRvU3RyaW5nKFwiaGV4XCIpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGdldFVzZXJTZWNyZXRzIGZhaWxlZDogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgIH1cblxuICAgIGNvbnN0IGpzb24gPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgcmV0dXJuIF8uaXNBcnJheShqc29uKVxuICAgICAgPyBqc29uXG4gICAgICAgICAgLm1hcDxTZWNyZXRzQXBpU2VjcmV0PigoaXRlbSkgPT4gKHtcbiAgICAgICAgICAgIHNlY3JldDogaXRlbS5zZWNyZXQsXG4gICAgICAgICAgICBzZWNyZXRfbmFtZTogaXRlbS5zZWNyZXRfbmFtZSxcbiAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKGl0ZW0uY3JlYXRlZF9hdCksXG4gICAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZShpdGVtLnVwZGF0ZWRfYXQpLFxuICAgICAgICAgICAgd2hpdGVsaXN0OiBfLmlzQXJyYXkoaXRlbS53aGl0ZWxpc3RlZF9tcmVuY2xhdmVzKVxuICAgICAgICAgICAgICA/IGl0ZW0ud2hpdGVsaXN0ZWRfbXJlbmNsYXZlcy5maWx0ZXIoKHZhbDogc3RyaW5nKSA9PiAhIXZhbClcbiAgICAgICAgICAgICAgOiBbXSxcbiAgICAgICAgICB9KSlcbiAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYi51cGRhdGVkX2F0LmdldFRpbWUoKSAtIGEudXBkYXRlZF9hdC5nZXRUaW1lKCkpXG4gICAgICA6IFtdO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVNlY3JldFJlcXVlc3QoXG4gICAgLyoqXG4gICAgICogIFRoZSBhZGRyZXNzIG9mIHRoZSB1c2VyLlxuICAgICAqL1xuICAgIHVzZXJQdWJrZXk6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgJ2VkMjU1MTknIGZvciBTb2xhbmEgdXNlcnMsICdldGhlcnMnIGZvciBFVk0gdXNlcnMuXG4gICAgICovXG4gICAgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgVGhlIGtleSBvZiB0aGUgc2VjcmV0LlxuICAgICAqXG4gICAgICogIEtleXMgbXVzdCBiZSB1bmlxdWUgcGVyIHVzZXIuXG4gICAgICovXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nLFxuICAgIC8qKlxuICAgICAqICBUaGUgdmFsdWUgb2YgdGhlIHNlY3JldC5cbiAgICAgKi9cbiAgICBzZWNyZXRWYWx1ZTogc3RyaW5nLFxuICAgIC8qKlxuICAgICAqICBUaGUgdGltZXN0YW1wIHRoYXQgdGhpcyByZXF1ZXN0IGV4cGlyZXMuXG4gICAgICpcbiAgICAgKiAgRGVmYXVsdDogbm93ICsgMzAgc2Vjb25kcy5cbiAgICAgKi9cbiAgICBleHBpcnlUaW1lc3RhbXAgPSBnZXREZWZhdWx0UmVxdWVzdFRpbWVzdGFtcCgpXG4gICk6IENyZWF0ZVNlY3JldFBheWxvYWQge1xuICAgIHJldHVybiBuZXcgQ3JlYXRlU2VjcmV0UGF5bG9hZChcbiAgICAgIHVzZXJQdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZSxcbiAgICAgIHNlY3JldE5hbWUsXG4gICAgICBzZWNyZXRWYWx1ZSxcbiAgICAgIGV4cGlyeVRpbWVzdGFtcFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlU2VjcmV0KHJlcXVlc3Q6IENyZWF0ZVNlY3JldFBheWxvYWQsIHNpZ25hdHVyZTogc3RyaW5nKSB7XG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy51cmx9L3NlY3JldGA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgIG1ldGhvZDogXCJQVVRcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIFwiWC1TaWduZWQtSGVhZGVyXCI6IHNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgICBib2R5OiByZXF1ZXN0LnRvU3RyaW5nKCksXG4gICAgfSk7XG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBjcmVhdGVTZWNyZXQgZmFpbGVkOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZUFkZE1yRW5jbGF2ZVJlcXVlc3QoXG4gICAgLyoqXG4gICAgICogIFRoZSBhZGRyZXNzIG9mIHRoZSB1c2VyLlxuICAgICAqL1xuICAgIHVzZXJQdWJrZXk6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgJ2VkMjU1MTknIGZvciBTb2xhbmEgdXNlcnMsICdldGhlcnMnIGZvciBFVk0gdXNlcnMuXG4gICAgICovXG4gICAgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgVGhlIE1yRW5jbGF2ZSB2YWx1ZSB0byBhZGQuXG4gICAgICovXG4gICAgbXJFbmNsYXZlOiBzdHJpbmcsXG4gICAgLyoqXG4gICAgICogIFRoZSBuYW1lcyBvZiB0aGUgc2VjcmV0cyB0byB3aGl0ZWxpc3QgdGhlIE1yRW5jbGF2ZSB2YWx1ZSBmb3IuXG4gICAgICovXG4gICAgc2VjcmV0TmFtZXM6IHN0cmluZ1tdLFxuICAgIC8qKlxuICAgICAqICBUaGUgdGltZXN0YW1wIHRoYXQgdGhpcyByZXF1ZXN0IGV4cGlyZXMuXG4gICAgICpcbiAgICAgKiAgRGVmYXVsdDogbm93ICsgMzAgc2Vjb25kcy5cbiAgICAgKi9cbiAgICBleHBpcnlUaW1lc3RhbXAgPSBnZXREZWZhdWx0UmVxdWVzdFRpbWVzdGFtcCgpXG4gICk6IEFkZE1yRW5jbGF2ZVBheWxvYWQge1xuICAgIHJldHVybiBuZXcgQWRkTXJFbmNsYXZlUGF5bG9hZChcbiAgICAgIHVzZXJQdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZSxcbiAgICAgIG1yRW5jbGF2ZSxcbiAgICAgIHNlY3JldE5hbWVzLFxuICAgICAgZXhwaXJ5VGltZXN0YW1wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhZGRNckVuY2xhdmUocmVxdWVzdDogQWRkTXJFbmNsYXZlUGF5bG9hZCwgc2lnbmF0dXJlOiBzdHJpbmcpIHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLnVybH0vbXJlbmNsYXZlL3doaXRlbGlzdGA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgIG1ldGhvZDogXCJQVVRcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIFwiWC1TaWduZWQtSGVhZGVyXCI6IHNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgICBib2R5OiByZXF1ZXN0LnRvU3RyaW5nKCksXG4gICAgfSk7XG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBhZGRNckVuY2xhdmUgZmFpbGVkOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZVJlbW92ZU1yRW5jbGF2ZVJlcXVlc3QoXG4gICAgLyoqXG4gICAgICogIFRoZSBhZGRyZXNzIG9mIHRoZSB1c2VyLlxuICAgICAqL1xuICAgIHVzZXJQdWJrZXk6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgJ2VkMjU1MTknIGZvciBTb2xhbmEgdXNlcnMsICdldGhlcnMnIGZvciBFVk0gdXNlcnMuXG4gICAgICovXG4gICAgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgVGhlIG1yRW5jbGF2ZSB2YWx1ZSB0byByZW1vdmUuXG4gICAgICovXG4gICAgbXJFbmNsYXZlOiBzdHJpbmcsXG4gICAgLyoqXG4gICAgICogIFRoZSB0aW1lc3RhbXAgdGhhdCB0aGlzIHJlcXVlc3QgZXhwaXJlcy5cbiAgICAgKlxuICAgICAqICBEZWZhdWx0OiBub3cgKyAzMCBzZWNvbmRzLlxuICAgICAqL1xuICAgIGV4cGlyeVRpbWVzdGFtcCA9IGdldERlZmF1bHRSZXF1ZXN0VGltZXN0YW1wKClcbiAgKTogUmVtb3ZlTXJFbmNsYXZlUGF5bG9hZCB7XG4gICAgcmV0dXJuIG5ldyBSZW1vdmVNckVuY2xhdmVQYXlsb2FkKFxuICAgICAgdXNlclB1YmtleSxcbiAgICAgIGNpcGhlcnN1aXRlLFxuICAgICAgbXJFbmNsYXZlLFxuICAgICAgZXhwaXJ5VGltZXN0YW1wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZW1vdmVNckVuY2xhdmUoXG4gICAgcmVxdWVzdDogUmVtb3ZlTXJFbmNsYXZlUGF5bG9hZCxcbiAgICBzaWduYXR1cmU6IHN0cmluZ1xuICApIHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLnVybH0vbXJlbmNsYXZlL3doaXRlbGlzdGA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgIG1ldGhvZDogXCJQVVRcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIFwiWC1TaWduZWQtSGVhZGVyXCI6IHNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgICBib2R5OiByZXF1ZXN0LnRvU3RyaW5nKCksXG4gICAgfSk7XG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGByZW1vdmVNckVuY2xhdmUgZmFpbGVkOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZURlbGV0ZVNlY3JldFJlcXVlc3QoXG4gICAgLyoqXG4gICAgICogIFRoZSBhZGRyZXNzIG9mIHRoZSB1c2VyLlxuICAgICAqL1xuICAgIHVzZXJQdWJrZXk6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgJ2VkMjU1MTknIGZvciBTb2xhbmEgdXNlcnMsICdldGhlcnMnIGZvciBFVk0gdXNlcnMuXG4gICAgICovXG4gICAgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICAvKipcbiAgICAgKiAgVGhlIG5hbWUgZm8gdGhlIHNlY3JldCB0byBkZWxldGUuXG4gICAgICovXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nLFxuICAgIC8qKlxuICAgICAqICBUaGUgdGltZXN0YW1wIHRoYXQgdGhpcyByZXF1ZXN0IGV4cGlyZXMuXG4gICAgICpcbiAgICAgKiAgRGVmYXVsdDogbm93ICsgMzAgc2Vjb25kcy5cbiAgICAgKi9cbiAgICBleHBpcnlUaW1lc3RhbXAgPSBnZXREZWZhdWx0UmVxdWVzdFRpbWVzdGFtcCgpXG4gICk6IERlbGV0ZVNlY3JldFBheWxvYWQge1xuICAgIHJldHVybiBuZXcgRGVsZXRlU2VjcmV0UGF5bG9hZChcbiAgICAgIHVzZXJQdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZSxcbiAgICAgIHNlY3JldE5hbWUsXG4gICAgICBleHBpcnlUaW1lc3RhbXBcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZVNlY3JldChyZXF1ZXN0OiBEZWxldGVTZWNyZXRQYXlsb2FkLCBzaWduYXR1cmU6IHN0cmluZykge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMudXJsfS9zZWNyZXRgO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICBtZXRob2Q6IFwiREVMRVRFXCIsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBcIlgtU2lnbmVkLUhlYWRlclwiOiBzaWduYXR1cmUsXG4gICAgICB9LFxuICAgICAgYm9keTogcmVxdWVzdC50b1N0cmluZygpLFxuICAgIH0pO1xuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZGVsZXRlU2VjcmV0IGZhaWxlZDogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElVcGRhdGVVc2VyUGF5bG9hZCB7XG4gIHVzZXJfcHVia2V5OiBzdHJpbmc7XG4gIGNpcGhlcnN1aXRlOiBzdHJpbmc7XG4gIGNvbnRhY3RfaW5mbzogc3RyaW5nO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFVwZGF0ZVVzZXJQYXlsb2FkIGltcGxlbWVudHMgSVVwZGF0ZVVzZXJQYXlsb2FkIHtcbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IHVzZXJfcHVia2V5OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICByZWFkb25seSBjb250YWN0X2luZm86IHN0cmluZyxcbiAgICByZWFkb25seSB0aW1lc3RhbXA6IG51bWJlclxuICApIHt9XG5cbiAgcHVibGljIHN0YXRpYyBmcm9tKG9iajogSVVwZGF0ZVVzZXJQYXlsb2FkKTogVXBkYXRlVXNlclBheWxvYWQge1xuICAgIHJldHVybiBuZXcgVXBkYXRlVXNlclBheWxvYWQoXG4gICAgICBvYmoudXNlcl9wdWJrZXksXG4gICAgICBvYmouY2lwaGVyc3VpdGUsXG4gICAgICBvYmouY29udGFjdF9pbmZvLFxuICAgICAgb2JqLnRpbWVzdGFtcFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdG9KU09OKCk6IElVcGRhdGVVc2VyUGF5bG9hZCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJfcHVia2V5OiB0aGlzLnVzZXJfcHVia2V5LFxuICAgICAgY2lwaGVyc3VpdGU6IHRoaXMuY2lwaGVyc3VpdGUsXG4gICAgICBjb250YWN0X2luZm86IHRoaXMuY29udGFjdF9pbmZvLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCkpO1xuICB9XG5cbiAgcHVibGljIHRvRW5jb2RlZE1lc3NhZ2UoKTogQnVmZmVyIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc2hhMjU2LmNyZWF0ZSgpLnVwZGF0ZSh0aGlzLnRvU3RyaW5nKCkpLmRpZ2VzdCgpKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDcmVhdGVTZWNyZXRQYXlsb2FkIHtcbiAgdXNlcl9wdWJrZXk6IHN0cmluZztcbiAgY2lwaGVyc3VpdGU6IHN0cmluZztcbiAgc2VjcmV0X25hbWU6IHN0cmluZztcbiAgc2VjcmV0OiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ3JlYXRlU2VjcmV0UGF5bG9hZCBpbXBsZW1lbnRzIElDcmVhdGVTZWNyZXRQYXlsb2FkIHtcbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IHVzZXJfcHVia2V5OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICByZWFkb25seSBzZWNyZXRfbmFtZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNlY3JldDogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHRpbWVzdGFtcDogbnVtYmVyXG4gICkge31cblxuICBwdWJsaWMgc3RhdGljIGZyb20ob2JqOiBJQ3JlYXRlU2VjcmV0UGF5bG9hZCk6IENyZWF0ZVNlY3JldFBheWxvYWQge1xuICAgIHJldHVybiBuZXcgQ3JlYXRlU2VjcmV0UGF5bG9hZChcbiAgICAgIG9iai51c2VyX3B1YmtleSxcbiAgICAgIG9iai5jaXBoZXJzdWl0ZSxcbiAgICAgIG9iai5zZWNyZXRfbmFtZSxcbiAgICAgIG9iai5zZWNyZXQsXG4gICAgICBvYmoudGltZXN0YW1wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyB0b0pTT04oKTogSUNyZWF0ZVNlY3JldFBheWxvYWQge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyX3B1YmtleTogdGhpcy51c2VyX3B1YmtleSxcbiAgICAgIGNpcGhlcnN1aXRlOiB0aGlzLmNpcGhlcnN1aXRlLFxuICAgICAgc2VjcmV0OiB0aGlzLnNlY3JldCxcbiAgICAgIHNlY3JldF9uYW1lOiB0aGlzLnNlY3JldF9uYW1lLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCkpO1xuICB9XG5cbiAgcHVibGljIHRvRW5jb2RlZE1lc3NhZ2UoKTogQnVmZmVyIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc2hhMjU2LmNyZWF0ZSgpLnVwZGF0ZSh0aGlzLnRvU3RyaW5nKCkpLmRpZ2VzdCgpKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBZGRNckVuY2xhdmVQYXlsb2FkIHtcbiAgdXNlcl9wdWJrZXk6IHN0cmluZztcbiAgY2lwaGVyc3VpdGU6IHN0cmluZztcbiAgbXJfZW5jbGF2ZTogc3RyaW5nO1xuICBzZWNyZXRfbmFtZXM6IHN0cmluZ1tdO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEFkZE1yRW5jbGF2ZVBheWxvYWQgaW1wbGVtZW50cyBJQWRkTXJFbmNsYXZlUGF5bG9hZCB7XG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICByZWFkb25seSB1c2VyX3B1YmtleTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGNpcGhlcnN1aXRlOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgbXJfZW5jbGF2ZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNlY3JldF9uYW1lczogc3RyaW5nW10sXG4gICAgcmVhZG9ubHkgdGltZXN0YW1wOiBudW1iZXJcbiAgKSB7fVxuXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShvYmo6IElBZGRNckVuY2xhdmVQYXlsb2FkKTogQWRkTXJFbmNsYXZlUGF5bG9hZCB7XG4gICAgcmV0dXJuIG5ldyBBZGRNckVuY2xhdmVQYXlsb2FkKFxuICAgICAgb2JqLnVzZXJfcHVia2V5LFxuICAgICAgb2JqLmNpcGhlcnN1aXRlLFxuICAgICAgb2JqLm1yX2VuY2xhdmUsXG4gICAgICBvYmouc2VjcmV0X25hbWVzLFxuICAgICAgb2JqLnRpbWVzdGFtcFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdG9KU09OKCk6IElBZGRNckVuY2xhdmVQYXlsb2FkIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcl9wdWJrZXk6IHRoaXMudXNlcl9wdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZTogdGhpcy5jaXBoZXJzdWl0ZSxcbiAgICAgIG1yX2VuY2xhdmU6IHRoaXMubXJfZW5jbGF2ZSxcbiAgICAgIHNlY3JldF9uYW1lczogdGhpcy5zZWNyZXRfbmFtZXMsXG4gICAgICB0aW1lc3RhbXA6IHRoaXMudGltZXN0YW1wLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy50b0pTT04oKSk7XG4gIH1cblxuICBwdWJsaWMgdG9FbmNvZGVkTWVzc2FnZSgpOiBCdWZmZXIge1xuICAgIHJldHVybiBCdWZmZXIuZnJvbShzaGEyNTYuY3JlYXRlKCkudXBkYXRlKHRoaXMudG9TdHJpbmcoKSkuZGlnZXN0KCkpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlbW92ZU1yRW5jbGF2ZVBheWxvYWQge1xuICB1c2VyX3B1YmtleTogc3RyaW5nO1xuICBjaXBoZXJzdWl0ZTogc3RyaW5nO1xuICBtcl9lbmNsYXZlOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgUmVtb3ZlTXJFbmNsYXZlUGF5bG9hZCBpbXBsZW1lbnRzIElSZW1vdmVNckVuY2xhdmVQYXlsb2FkIHtcbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IHVzZXJfcHVia2V5OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgY2lwaGVyc3VpdGU6IHN0cmluZyxcbiAgICByZWFkb25seSBtcl9lbmNsYXZlOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdGltZXN0YW1wOiBudW1iZXJcbiAgKSB7fVxuXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShvYmo6IElSZW1vdmVNckVuY2xhdmVQYXlsb2FkKTogUmVtb3ZlTXJFbmNsYXZlUGF5bG9hZCB7XG4gICAgcmV0dXJuIG5ldyBSZW1vdmVNckVuY2xhdmVQYXlsb2FkKFxuICAgICAgb2JqLnVzZXJfcHVia2V5LFxuICAgICAgb2JqLmNpcGhlcnN1aXRlLFxuICAgICAgb2JqLm1yX2VuY2xhdmUsXG4gICAgICBvYmoudGltZXN0YW1wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyB0b0pTT04oKTogSVJlbW92ZU1yRW5jbGF2ZVBheWxvYWQge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyX3B1YmtleTogdGhpcy51c2VyX3B1YmtleSxcbiAgICAgIGNpcGhlcnN1aXRlOiB0aGlzLmNpcGhlcnN1aXRlLFxuICAgICAgbXJfZW5jbGF2ZTogdGhpcy5tcl9lbmNsYXZlLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCkpO1xuICB9XG5cbiAgcHVibGljIHRvRW5jb2RlZE1lc3NhZ2UoKTogQnVmZmVyIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc2hhMjU2LmNyZWF0ZSgpLnVwZGF0ZSh0aGlzLnRvU3RyaW5nKCkpLmRpZ2VzdCgpKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElEZWxldGVTZWNyZXRQYXlsb2FkIHtcbiAgdXNlcl9wdWJrZXk6IHN0cmluZztcbiAgY2lwaGVyc3VpdGU6IHN0cmluZztcbiAgc2VjcmV0X25hbWU6IHN0cmluZztcbiAgdGltZXN0YW1wOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBEZWxldGVTZWNyZXRQYXlsb2FkIGltcGxlbWVudHMgSURlbGV0ZVNlY3JldFBheWxvYWQge1xuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgdXNlcl9wdWJrZXk6IHN0cmluZyxcbiAgICByZWFkb25seSBjaXBoZXJzdWl0ZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNlY3JldF9uYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdGltZXN0YW1wOiBudW1iZXJcbiAgKSB7fVxuXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShvYmo6IElEZWxldGVTZWNyZXRQYXlsb2FkKTogRGVsZXRlU2VjcmV0UGF5bG9hZCB7XG4gICAgcmV0dXJuIG5ldyBEZWxldGVTZWNyZXRQYXlsb2FkKFxuICAgICAgb2JqLnVzZXJfcHVia2V5LFxuICAgICAgb2JqLmNpcGhlcnN1aXRlLFxuICAgICAgb2JqLnNlY3JldF9uYW1lLFxuICAgICAgb2JqLnRpbWVzdGFtcFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdG9KU09OKCk6IElEZWxldGVTZWNyZXRQYXlsb2FkIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcl9wdWJrZXk6IHRoaXMudXNlcl9wdWJrZXksXG4gICAgICBjaXBoZXJzdWl0ZTogdGhpcy5jaXBoZXJzdWl0ZSxcbiAgICAgIHNlY3JldF9uYW1lOiB0aGlzLnNlY3JldF9uYW1lLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCkpO1xuICB9XG5cbiAgcHVibGljIHRvRW5jb2RlZE1lc3NhZ2UoKTogQnVmZmVyIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc2hhMjU2LmNyZWF0ZSgpLnVwZGF0ZSh0aGlzLnRvU3RyaW5nKCkpLmRpZ2VzdCgpKTtcbiAgfVxufVxuIl19